<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Tracker â€” Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=DM+Sans:wght@400;600;700&family=DM+Mono:wght@400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--black:#0a0a0a;--white:#fff;--g50:#f8f8f8;--g100:#f0f0f0;--g200:#e0e0e0;--g400:#9a9a9a;--g500:#737373;--g800:#2a2a2a;--font:'DM Sans',sans-serif;--mono:'DM Mono',monospace;--din:'Barlow Condensed',sans-serif}
body{font-family:var(--font);background:var(--g50);color:var(--black);min-height:100vh;-webkit-font-smoothing:antialiased}

/* LOGIN */
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--black)}
.login-box{background:var(--white);padding:40px 36px;width:100%;max-width:360px}
.login-logo{font-family:var(--din);font-size:22px;font-weight:800;letter-spacing:1px}
.login-sub{font-size:10px;color:var(--g400);text-transform:uppercase;letter-spacing:2px;margin-bottom:32px}
.g-btn{width:100%;padding:13px;background:var(--black);color:var(--white);border:none;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;gap:10px}
.g-btn:hover{background:var(--g800)}
.login-note{font-size:11px;color:var(--g400);margin-top:14px;text-align:center}
.err-box{padding:10px 12px;background:#fff0f0;border:1px solid #fcc;font-size:12px;color:#c00;margin-bottom:14px;display:none}

/* LAYOUT */
.layout{display:none;min-height:100vh}
.sidebar{width:220px;min-height:100vh;background:var(--black);color:var(--white);position:fixed;top:0;left:0;display:flex;flex-direction:column}
.sb-logo{padding:22px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-logo h1{font-family:var(--din);font-size:16px;font-weight:800;letter-spacing:1px;line-height:1.3}
.sb-logo p{font-size:9px;opacity:.4;text-transform:uppercase;letter-spacing:1.5px;margin-top:2px}
.sb-nav{flex:1;padding:12px 0}
.nav-btn{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;color:rgba(255,255,255,.45);border:none;background:none;width:100%;text-align:left;font-family:var(--font)}
.nav-btn:hover{color:var(--white);background:rgba(255,255,255,.05)}
.nav-btn.on{color:var(--white);background:rgba(255,255,255,.1)}
.nav-btn svg{width:15px;height:15px;flex-shrink:0}
.sb-foot{padding:16px 20px;border-top:1px solid rgba(255,255,255,.08)}
.sb-email{font-size:10px;color:rgba(255,255,255,.35);margin-bottom:8px;word-break:break-all}
.logout-btn{background:none;border:none;color:rgba(255,255,255,.4);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;font-family:var(--font)}
.logout-btn:hover{color:rgba(255,255,255,.7)}

/* MAIN */
.main{margin-left:220px;padding:28px;min-height:100vh}
.pg{display:none}
.pg.on{display:block}
.pg-title{font-family:var(--din);font-size:26px;font-weight:800;letter-spacing:.5px;margin-bottom:2px}
.pg-sub{font-size:11px;color:var(--g400);margin-bottom:24px}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat{background:var(--white);border:1px solid var(--g200);padding:18px}
.stat.dark{background:var(--black);border-color:var(--black)}
.stat-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--g400);margin-bottom:6px}
.stat.dark .stat-lbl{color:rgba(255,255,255,.4)}
.stat-val{font-family:var(--din);font-size:36px;font-weight:800;line-height:1}
.stat.dark .stat-val{color:var(--white)}
.stat-note{font-size:10px;color:var(--g400);margin-top:4px}
.stat.dark .stat-note{color:rgba(255,255,255,.35)}

/* CHARTS */
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.chart-box{background:var(--white);border:1px solid var(--g200);padding:18px}
.chart-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g500);margin-bottom:14px}
.chart-wrap{position:relative;height:190px}

/* TABLE */
.tbl-card{background:var(--white);border:1px solid var(--g200);margin-bottom:20px}
.tbl-hd{padding:14px 18px;border-bottom:1px solid var(--g100);display:flex;justify-content:space-between;align-items:center}
.tbl-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g500)}
.tbl-cnt{font-size:11px;color:var(--g400);font-family:var(--mono)}
table{width:100%;border-collapse:collapse}
th{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g400);padding:9px 18px;text-align:left;border-bottom:1px solid var(--g100);background:var(--g50)}
td{font-size:12px;padding:11px 18px;border-bottom:1px solid var(--g50);color:var(--g800);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--g50)}
.av{width:26px;height:26px;background:var(--black);color:var(--white);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.uc{display:flex;align-items:center;gap:9px}
.badge{display:inline-block;padding:2px 7px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;background:var(--g100);color:var(--g500)}
.del{padding:5px 11px;background:none;border:1px solid var(--g200);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;color:var(--g500);font-family:var(--font)}
.del:hover{border-color:#c00;color:#c00}
.bar-wrap{display:flex;align-items:center;gap:8px}
.bar-track{flex:1;height:3px;background:var(--g100)}
.bar-fill{height:100%;background:var(--black)}
.bar-pct{font-size:10px;font-weight:700;color:var(--g500);font-family:var(--mono);width:30px;text-align:right;flex-shrink:0}
.search{width:100%;padding:10px 14px;border:1px solid var(--g200);font-size:13px;font-family:var(--font);outline:none;margin-bottom:12px}
.search:focus{border-color:var(--black)}
.loading-row td{text-align:center;padding:28px;color:var(--g400);font-size:11px;text-transform:uppercase;letter-spacing:1px}
.refresh{padding:7px 13px;background:var(--white);border:1px solid var(--g200);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;color:var(--g500);font-family:var(--font)}
.refresh:hover{border-color:var(--black);color:var(--black)}
.ptxt{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-logo">Habit Tracker</div>
    <div class="login-sub">Admin Dashboard</div>
    <div class="err-box" id="errBox"></div>
    <button class="g-btn" id="loginBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <p class="login-note">Only your authorized Google account can access this dashboard</p>
  </div>
</div>

<!-- DASHBOARD -->
<div class="layout" id="layout">
  <div class="sidebar">
    <div class="sb-logo"><h1>Habit Tracker<br>Admin</h1><p>Admin Dashboard</p></div>
    <nav class="sb-nav">
      <button class="nav-btn on" data-page="dashboard">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Overview
      </button>
      <button class="nav-btn" data-page="users">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        Users
      </button>
      <button class="nav-btn" data-page="posts">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Posts
      </button>
      <button class="nav-btn" data-page="habits">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
        Habits
      </button>
    </nav>
    <div class="sb-foot">
      <div class="sb-email" id="adminEmail"></div>
      <button class="logout-btn" id="logoutBtn">Sign Out</button>
    </div>
  </div>

  <div class="main">
    <!-- Overview -->
    <div class="pg on" id="pg-dashboard">
      <div class="pg-title">Overview</div>
      <div class="pg-sub" id="lastUpdated">Loading...</div>
      <div class="stat-grid">
        <div class="stat dark"><div class="stat-lbl">Total Users</div><div class="stat-val" id="sUsers">â€”</div><div class="stat-note">Registered</div></div>
        <div class="stat"><div class="stat-lbl">Total Posts</div><div class="stat-val" id="sPosts">â€”</div><div class="stat-note">Community feed</div></div>
        <div class="stat"><div class="stat-lbl">Total Habits</div><div class="stat-val" id="sHabits">â€”</div><div class="stat-note">Active</div></div>
        <div class="stat"><div class="stat-lbl">Total Comments</div><div class="stat-val" id="sComments">â€”</div><div class="stat-note">All comments</div></div>
      </div>
      <div class="chart-row">
        <div class="chart-box"><div class="chart-ttl">Habit Category Distribution</div><div class="chart-wrap"><canvas id="chartCat"></canvas></div></div>
        <div class="chart-box"><div class="chart-ttl">Habits per User (Top 8)</div><div class="chart-wrap"><canvas id="chartUsers"></canvas></div></div>
      </div>
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">Latest Posts</div><button class="refresh" id="refreshBtn">Refresh</button></div>
        <table><thead><tr><th>User</th><th>Content</th><th>Likes</th><th>Comments</th><th>Time</th></tr></thead>
        <tbody id="recentTbody"><tr class="loading-row"><td colspan="5">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Users -->
    <div class="pg" id="pg-users">
      <div class="pg-title">Users</div>
      <div class="pg-sub">All registered users</div>
      <input class="search" id="userSearch" placeholder="Search by name / UID...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">Users</div><div class="tbl-cnt" id="userCnt">â€”</div></div>
        <table><thead><tr><th>User</th><th>UID</th><th>Habits</th><th>Posts</th><th>Avg. Completion</th></tr></thead>
        <tbody id="userTbody"><tr class="loading-row"><td colspan="5">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Posts -->
    <div class="pg" id="pg-posts">
      <div class="pg-title">Posts</div>
      <div class="pg-sub">Review and remove inappropriate posts</div>
      <input class="search" id="postSearch" placeholder="Search by content / username...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">All Posts</div><div class="tbl-cnt" id="postCnt">â€”</div></div>
        <table><thead><tr><th>User</th><th>Content</th><th>Media</th><th>Likes</th><th>Comments</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="postTbody"><tr class="loading-row"><td colspan="7">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Habits -->
    <div class="pg" id="pg-habits">
      <div class="pg-title">Habits</div>
      <div class="pg-sub">Habit creation across all users</div>
      <input class="search" id="habitSearch" placeholder="Search by habit name / category...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">All Habits</div><div class="tbl-cnt" id="habitCnt">â€”</div></div>
        <table><thead><tr><th>Habit Name</th><th>User</th><th>Category</th><th>Frequency</th><th>Streak</th><th>Completion</th></tr></thead>
        <tbody id="habitTbody"><tr class="loading-row"><td colspan="6">Loading...</td></tr></tbody></table>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyDxa2PZEep3eXY1Iiu4IhjXCwXd6z0HelA",
  authDomain:"health-habit-tracker-e6b50.firebaseapp.com",
  projectId:"health-habit-tracker-e6b50",
  storageBucket:"health-habit-tracker-e6b50.firebasestorage.app",
  messagingSenderId:"890093173627",
  appId:"1:890093173627:web:54032fce30ae7ef3f41bde"
});
var auth = firebase.auth();
var db   = firebase.firestore();

var allUsers=[], allPosts=[], allHabits=[];
var catChart=null, userChart=null;

// Auth state
auth.onAuthStateChanged(function(user){
  if(user){
    // Save user data to Firestore for admin visibility
    db.collection('users').doc(user.uid).set({
      uid: user.uid,
      email: user.email||'',
      displayName: user.displayName||'',
      photoURL: user.photoURL||'',
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true}).catch(function(){});

    document.getElementById('loginWrap').style.display='none';
    document.getElementById('layout').style.display='flex';
    document.getElementById('adminEmail').textContent = user.email||user.displayName||'';
    loadAll();
  } else {
    document.getElementById('loginWrap').style.display='flex';
    document.getElementById('layout').style.display='none';
  }
});

// Handle redirect sign-in result
auth.getRedirectResult().then(function(result){
  // Successful login handled by onAuthStateChanged
}).catch(function(e){
  if(e.code && e.code !== 'auth/no-current-user'){
    var b=document.getElementById('errBox');
    b.style.display='block';
    b.textContent='Sign in failed: '+e.message;
  }
});

// Login - try popup first, fall back to redirect if blocked
document.getElementById('loginBtn').onclick = function(){
  var b=document.getElementById('errBox');
  b.style.display='none';
  var provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(function(e){
    // Popup blocked, fall back to redirect
    if(e.code==='auth/popup-blocked'||e.code==='auth/cancelled-popup-request'){
      auth.signInWithRedirect(provider);
    } else {
      b.style.display='block';
      b.textContent='Sign in failed: '+e.message;
    }
  });
};

// Logout
document.getElementById('logoutBtn').onclick = function(){ auth.signOut(); };

// Refresh
document.getElementById('refreshBtn').onclick = loadAll;

// Nav
document.querySelectorAll('.nav-btn').forEach(function(btn){
  btn.onclick = function(){
    document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('on'); });
    document.querySelectorAll('.pg').forEach(function(p){ p.classList.remove('on'); });
    btn.classList.add('on');
    document.getElementById('pg-'+btn.dataset.page).classList.add('on');
  };
});

// Search
document.getElementById('userSearch').oninput = function(){ renderUsers(this.value); };
document.getElementById('postSearch').oninput = function(){ renderPosts(this.value); };
document.getElementById('habitSearch').oninput = function(){ renderHabits(this.value); };

// Load
function loadAll(){
  document.getElementById('lastUpdated').textContent='Loading...';
  Promise.all([loadHabits(), loadPosts(), loadUsers()]).then(function(){
    buildUsers();
    renderStats();
    renderCharts();
    renderRecent();
    renderUsers('');
    renderPosts('');
    renderHabits('');
    document.getElementById('lastUpdated').textContent='Last updated: '+new Date().toLocaleString('en-US');
  });
}

function loadUsers(){
  return db.collection('users').get().then(function(snap){
    // Load Firestore users collection first
    window.fsUsers = {};
    snap.docs.forEach(function(d){
      window.fsUsers[d.id] = d.data();
    });
  }).catch(function(){ window.fsUsers={}; });
}

function loadHabits(){
  return db.collection('habits').get().then(function(snap){
    allHabits = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
  }).catch(function(){ allHabits=[]; });
}

function loadPosts(){
  return db.collection('posts').orderBy('createdAt','desc').get().then(function(snap){
    allPosts = snap.docs.map(function(d){
      var data=d.data();
      var ts=data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      return Object.assign({id:d.id},data,{timeStr:ts?ts.toLocaleString('zh-TW'):'â€”'});
    });
    var promises = allPosts.map(function(p){
      return db.collection('posts').doc(p.id).collection('comments').get()
        .then(function(cs){ p.commentCount=cs.size; })
        .catch(function(){ p.commentCount=p.comments||0; });
    });
    return Promise.all(promises);
  }).catch(function(){ allPosts=[]; });
}

function buildUsers(){
  var map={};

  // Add users from Firestore users collection (those who have logged in)
  Object.entries(window.fsUsers||{}).forEach(function(entry){
    var uid=entry[0], u=entry[1];
    map[uid]={uid:uid, name:u.displayName||u.email||'User', email:u.email||'', habits:[], posts:[], lastSeen:u.lastSeen};
  });

  // Supplement from habits
  allHabits.forEach(function(h){
    if(!h.userId) return;
    if(!map[h.userId]) map[h.userId]={uid:h.userId,name:'User',email:'',habits:[],posts:[]};
    map[h.userId].habits.push(h);
  });

  // Supplement from posts
  allPosts.forEach(function(p){
    if(!p.userId) return;
    if(!map[p.userId]) map[p.userId]={uid:p.userId,name:p.user||'User',email:'',habits:[],posts:[]};
    if(p.user) map[p.userId].name=p.user;
    map[p.userId].posts.push(p);
  });

  allUsers=Object.values(map);
}

function renderStats(){
  document.getElementById('sUsers').textContent=allUsers.length;
  document.getElementById('sPosts').textContent=allPosts.length;
  document.getElementById('sHabits').textContent=allHabits.length;
  var c=allPosts.reduce(function(s,p){ return s+(p.commentCount||0); },0);
  document.getElementById('sComments').textContent=c;
}

function renderCharts(){
  var catMap={};
  allHabits.forEach(function(h){ var k=h.category||'Other'; catMap[k]=(catMap[k]||0)+1; });
  if(catChart) catChart.destroy();
  catChart=new Chart(document.getElementById('chartCat'),{
    type:'doughnut',
    data:{labels:Object.keys(catMap),datasets:[{data:Object.values(catMap),backgroundColor:['#0a0a0a','#3d3d3d','#737373','#9a9a9a','#c4c4c4','#e0e0e0','#555','#888']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:12}}}}
  });
  var ud=allUsers.slice().sort(function(a,b){return b.habits.length-a.habits.length;}).slice(0,8);
  if(userChart) userChart.destroy();
  userChart=new Chart(document.getElementById('chartUsers'),{
    type:'bar',
    data:{labels:ud.map(function(u){return u.name;}),datasets:[{label:'Habits',data:ud.map(function(u){return u.habits.length;}),backgroundColor:'#0a0a0a'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{ticks:{stepSize:1,font:{size:10}}}}}
  });
}

function renderRecent(){
  var tb=document.getElementById('recentTbody');
  var list=allPosts.slice(0,10);
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="5">No posts yet</td></tr>';return;}
  tb.innerHTML=list.map(function(p){
    return '<tr><td><div class="uc"><div class="av">'+((p.avatar||p.user||'?')[0])+'</div>'+htmlEsc(p.user||'â€”')+'</div></td>'+
      '<td><div class="ptxt">'+htmlEsc(p.text||'(no text)')+'</div></td>'+
      '<td>'+(p.likes||0)+'</td><td>'+(p.commentCount||0)+'</td>'+
      '<td style="font-size:10px;color:var(--g400)">'+p.timeStr+'</td></tr>';
  }).join('');
}

function renderUsers(f){
  var tb=document.getElementById('userTbody');
  var list=allUsers.filter(function(u){ return !f||u.name.includes(f)||u.uid.includes(f)||(u.email||'').includes(f); });
  document.getElementById('userCnt').textContent=list.length+' user(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="5">No matching users</td></tr>';return;}
  tb.innerHTML=list.map(function(u){
    var r=u.habits.length?Math.round(u.habits.reduce(function(s,h){return s+calcRate(h);},0)/u.habits.length):0;
    return '<tr><td><div class="uc"><div class="av">'+((u.name||'?')[0])+'</div><div><strong>'+htmlEsc(u.name)+'</strong><div style="font-size:10px;color:var(--g400)">'+htmlEsc(u.email||'')+'</div></div></div></td>'+
      '<td style="font-size:10px;color:var(--g400);font-family:var(--mono)">'+u.uid.slice(0,16)+'â€¦</td>'+
      '<td>'+u.habits.length+'</td><td>'+u.posts.length+'</td>'+
      '<td><div class="bar-wrap"><div class="bar-track"><div class="bar-fill" style="width:'+r+'%"></div></div><div class="bar-pct">'+r+'%</div></div></td></tr>';
  }).join('');
}

function renderPosts(f){
  var tb=document.getElementById('postTbody');
  var list=allPosts.filter(function(p){ return !f||(p.text||'').includes(f)||(p.user||'').includes(f); });
  document.getElementById('postCnt').textContent=list.length+' post(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="7">No matching posts</td></tr>';return;}
  tb.innerHTML=list.map(function(p){
    return '<tr><td><div class="uc"><div class="av">'+((p.avatar||p.user||'?')[0])+'</div>'+htmlEsc(p.user||'â€”')+'</div></td>'+
      '<td><div class="ptxt">'+htmlEsc(p.text||'(no text)')+'</div></td>'+
      '<td>'+(p.hasImage?'ðŸ“·':p.hasVideo?'ðŸŽ¬':'â€”')+'</td>'+
      '<td>'+(p.likes||0)+'</td><td>'+(p.commentCount||0)+'</td>'+
      '<td style="font-size:10px;color:var(--g400)">'+p.timeStr+'</td>'+
      '<td><button class="del" onclick="delPost(\''+p.id+'\')">Delete</button></td></tr>';
  }).join('');
}

function delPost(id){
  if(!confirm('Are you sure you want to delete this post?')) return;
  db.collection('posts').doc(id).delete().then(function(){
    allPosts=allPosts.filter(function(p){return p.id!==id;});
    renderStats(); renderRecent(); renderPosts(document.getElementById('postSearch').value);
  }).catch(function(e){ alert('Delete failed: '+e.message); });
}

function renderHabits(f){
  var tb=document.getElementById('habitTbody');
  var list=allHabits.filter(function(h){ return !f||(h.name||'').includes(f)||(h.category||'').includes(f); });
  document.getElementById('habitCnt').textContent=list.length+' habit(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="6">No matching habits</td></tr>';return;}
  var nm={};
  allUsers.forEach(function(u){ nm[u.uid]=u.name; });
  tb.innerHTML=list.map(function(h){
    var r=calcRate(h);
    return '<tr><td><strong>'+htmlEsc(h.name||'â€”')+'</strong></td>'+
      '<td>'+(nm[h.userId]||((h.userId||'').slice(0,8))||'â€”')+'</td>'+
      '<td><span class="badge">'+htmlEsc(h.category||'â€”')+'</span></td>'+
      '<td style="font-size:11px">'+(h.freqLabel||'Daily')+'</td>'+
      '<td style="font-family:var(--mono);font-size:11px">'+(h.streak||0)+' days</td>'+
      '<td><div class="bar-wrap"><div class="bar-track"><div class="bar-fill" style="width:'+r+'%"></div></div><div class="bar-pct">'+r+'%</div></div></td></tr>';
  }).join('');
}

function calcRate(h){
  var tpc=h.dailyTarget||1, id=h.intervalDays||1;
  var tr=h.timeRange||'', parts=tr.split(/ï½ž|~/).map(function(s){return s.trim().replace(/\//g,'-');});
  var td=function(s){var a=s.split('-').map(Number);return new Date(a[0],a[1]-1,a[2]);};
  var s=parts[0]?td(parts[0]):new Date(), e=parts[1]?td(parts[1]):new Date();
  var days=Math.max(1,Math.round((e-s)/86400000)+1);
  var exp=Math.ceil(days/id)*tpc;
  var done=Object.entries(h.todayCounts||{}).reduce(function(sum,kv){return sum+Math.min(tpc,Math.max(0,kv[1]||0));},0);
  return Math.min(100,Math.round(done/exp*100));
}

function htmlEsc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
