<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- ‚îÄ‚îÄ Security Headers (supplement server-side CSP) ‚îÄ‚îÄ -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="strict-origin-when-cross-origin">
<!-- Prevent indexing of admin panel -->
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
<title>Habit Tracker ‚Äî Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=DM+Sans:wght@400;600;700&family=DM+Mono:wght@400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--black:#0a0a0a;--white:#fff;--g50:#f8f8f8;--g100:#f0f0f0;--g200:#e0e0e0;--g400:#9a9a9a;--g500:#737373;--g800:#2a2a2a;--font:'DM Sans',sans-serif;--mono:'DM Mono',monospace;--din:'Barlow Condensed',sans-serif}
body{font-family:var(--font);background:var(--g50);color:var(--black);min-height:100vh;-webkit-font-smoothing:antialiased}

/* LOGIN */
.loading-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--black);position:fixed;inset:0;z-index:9999}
.loading-screen .dot{width:8px;height:8px;background:rgba(255,255,255,0.6);border-radius:50%;margin:0 5px;animation:ldot 1.2s infinite}
.loading-screen .dot:nth-child(2){animation-delay:.2s}
.loading-screen .dot:nth-child(3){animation-delay:.4s}
@keyframes ldot{0%,80%,100%{opacity:.15}40%{opacity:1}}
.login-wrap{display:none;align-items:center;justify-content:center;min-height:100vh;background:var(--black)}
.login-box{background:var(--white);padding:40px 36px;width:100%;max-width:360px}
.login-logo{font-family:var(--din);font-size:22px;font-weight:800;letter-spacing:1px}
.login-sub{font-size:10px;color:var(--g400);text-transform:uppercase;letter-spacing:2px;margin-bottom:32px}
.g-btn{width:100%;padding:13px;background:var(--black);color:var(--white);border:none;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;gap:10px}
.g-btn:hover{background:var(--g800)}
.login-note{font-size:11px;color:var(--g400);margin-top:14px;text-align:center}
.err-box{padding:10px 12px;background:#fff0f0;border:1px solid #fcc;font-size:12px;color:#c00;margin-bottom:14px;display:none}

/* LAYOUT */
.layout{display:none;min-height:100vh}
.sidebar{width:220px;min-height:100vh;background:var(--black);color:var(--white);position:fixed;top:0;left:0;display:flex;flex-direction:column}
.sb-logo{padding:22px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-logo h1{font-family:var(--din);font-size:16px;font-weight:800;letter-spacing:1px;line-height:1.3}
.sb-logo p{font-size:9px;opacity:.4;text-transform:uppercase;letter-spacing:1.5px;margin-top:2px}
.sb-nav{flex:1;padding:12px 0}
.nav-btn{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;color:rgba(255,255,255,.45);border:none;background:none;width:100%;text-align:left;font-family:var(--font)}
.nav-btn:hover{color:var(--white);background:rgba(255,255,255,.05)}
.nav-btn.on{color:var(--white);background:rgba(255,255,255,.1)}
.nav-btn svg{width:15px;height:15px;flex-shrink:0}
.sb-foot{padding:16px 20px;border-top:1px solid rgba(255,255,255,.08)}
.sb-email{font-size:10px;color:rgba(255,255,255,.35);margin-bottom:8px;word-break:break-all}
.logout-btn{background:none;border:none;color:rgba(255,255,255,.4);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;font-family:var(--font)}
.logout-btn:hover{color:rgba(255,255,255,.7)}

/* MAIN */
.main{margin-left:220px;padding:28px;min-height:100vh}
.pg{display:none}
.pg.on{display:block}
.pg-title{font-family:var(--din);font-size:26px;font-weight:800;letter-spacing:.5px;margin-bottom:2px}
.pg-sub{font-size:11px;color:var(--g400);margin-bottom:24px}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat{background:var(--white);border:1px solid var(--g200);padding:18px}
.stat.dark{background:var(--black);border-color:var(--black)}
.stat-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--g400);margin-bottom:6px}
.stat.dark .stat-lbl{color:rgba(255,255,255,.4)}
.stat-val{font-family:var(--din);font-size:36px;font-weight:800;line-height:1}
.stat.dark .stat-val{color:var(--white)}
.stat-note{font-size:10px;color:var(--g400);margin-top:4px}
.stat.dark .stat-note{color:rgba(255,255,255,.35)}

/* CHARTS */
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.chart-box{background:var(--white);border:1px solid var(--g200);padding:18px}
.chart-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g500);margin-bottom:14px}
.chart-wrap{position:relative;height:190px}

/* TABLE */
.tbl-card{background:var(--white);border:1px solid var(--g200);margin-bottom:20px}
.tbl-hd{padding:14px 18px;border-bottom:1px solid var(--g100);display:flex;justify-content:space-between;align-items:center}
.tbl-ttl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g500)}
.tbl-cnt{font-size:11px;color:var(--g400);font-family:var(--mono)}
table{width:100%;border-collapse:collapse}
th{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g400);padding:9px 18px;text-align:left;border-bottom:1px solid var(--g100);background:var(--g50)}
td{font-size:12px;padding:11px 18px;border-bottom:1px solid var(--g50);color:var(--g800);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--g50)}
.av{width:26px;height:26px;background:var(--black);color:var(--white);display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.uc{display:flex;align-items:center;gap:9px}
.badge{display:inline-block;padding:2px 7px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;background:var(--g100);color:var(--g500)}
.del{padding:5px 11px;background:none;border:1px solid var(--g200);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;color:var(--g500);font-family:var(--font)}
.del:hover{border-color:#c00;color:#c00}
.bar-wrap{display:flex;align-items:center;gap:8px}
.bar-track{flex:1;height:3px;background:var(--g100)}
.bar-fill{height:100%;background:var(--black)}
.bar-pct{font-size:10px;font-weight:700;color:var(--g500);font-family:var(--mono);width:30px;text-align:right;flex-shrink:0}
.search{width:100%;padding:10px 14px;border:1px solid var(--g200);font-size:13px;font-family:var(--font);outline:none;margin-bottom:12px}
.search:focus{border-color:var(--black)}
.loading-row td{text-align:center;padding:28px;color:var(--g400);font-size:11px;text-transform:uppercase;letter-spacing:1px}
.refresh{padding:7px 13px;background:var(--white);border:1px solid var(--g200);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;color:var(--g500);font-family:var(--font)}
.refresh:hover{border-color:var(--black);color:var(--black)}
.quota-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.quota-warn{background:#fffbe6;border:1px solid #e0c060;padding:10px 14px;font-size:11px;color:#7a6000;margin-bottom:16px;display:none}
.quota-warn.show{display:block}
.pct-bar{height:6px;background:var(--g100);margin-top:6px;overflow:hidden}
.pct-fill{height:100%;background:var(--black);transition:width .4s}
.pct-fill.warn{background:#e0a800}
.pct-fill.danger{background:#c00}
.uid-small{font-size:9px;color:var(--g400);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:120px}

/* ‚îÄ‚îÄ MOBILE RWD ‚îÄ‚îÄ */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--black);border:none;padding:8px 10px;cursor:pointer;line-height:1;color:var(--white);font-size:18px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:98}
@media(max-width:768px){
  .hamburger{display:block}
  .sidebar{transform:translateX(-100%);transition:transform .25s ease;z-index:99}
  .sidebar.sb-open{transform:translateX(0)}
  .sidebar-overlay.sb-open{display:block}
  .main{margin-left:0;padding:16px;padding-top:54px}
  .stat-grid{grid-template-columns:repeat(2,1fr)}
  .chart-row{grid-template-columns:1fr}
  .quota-summary{grid-template-columns:repeat(2,1fr)}
  table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
}
</style>
</head>
<body>
<!-- Hamburger (mobile only) -->
<button class="hamburger" id="hamburgerBtn" aria-label="Open menu">&#9776;</button>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- LOGIN -->
<div class="loading-screen" id="loadingScreen"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-logo">Habit Tracker</div>
    <div class="login-sub">Admin Dashboard</div>
    <div class="err-box" id="errBox"></div>
    <button class="g-btn" id="loginBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <p class="login-note">Only your authorized Google account can access this dashboard</p>
  </div>
</div>

<!-- DASHBOARD -->
<div class="layout" id="layout">
  <div class="sidebar">
    <div class="sb-logo"><h1>Habit Tracker<br>Admin</h1><p>Admin Dashboard</p></div>
    <nav class="sb-nav">
      <button class="nav-btn on" data-page="dashboard">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Overview
      </button>
      <button class="nav-btn" data-page="users">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        Users
      </button>
      <button class="nav-btn" data-page="posts">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Posts
      </button>
      <button class="nav-btn" data-page="habits">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
        Habits
      </button>
      <button class="nav-btn" data-page="quota">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
        Upload Quota
      </button>
      <button class="nav-btn" data-page="security">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        Security &amp; Rules
      </button>
      <button class="nav-btn" data-page="reports" id="navReports">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H12.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>
        Reports
        <span id="reportsBadge" style="display:none;background:#dc2626;color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:2px;margin-left:4px;">0</span>
      </button>

    </nav>
    <div class="sb-foot">
      <div class="sb-email" id="adminEmail"></div>
      <button class="logout-btn" id="logoutBtn">Sign Out</button>
    </div>
  </div>

  <div class="main">
    <!-- Security Warning Bar (hidden by default) -->
    <div id="adminSecurityWarn" style="display:none;background:#fffbe6;border:1px solid #e0c060;padding:10px 18px;font-size:11px;color:#7a6000;margin-bottom:16px;border-radius:2px;"></div>
    <!-- Overview -->
    <div class="pg on" id="pg-dashboard">
      <div class="pg-title">Overview</div>
      <div class="pg-sub" id="lastUpdated">Loading...</div>
      <div class="stat-grid">
        <div class="stat dark"><div class="stat-lbl">Total Users</div><div class="stat-val" id="sUsers">‚Äî</div><div class="stat-note">Registered</div></div>
        <div class="stat"><div class="stat-lbl">Total Posts</div><div class="stat-val" id="sPosts">‚Äî</div><div class="stat-note">Community feed</div></div>
        <div class="stat"><div class="stat-lbl">Total Habits</div><div class="stat-val" id="sHabits">‚Äî</div><div class="stat-note">Active</div></div>
        <div class="stat"><div class="stat-lbl">Total Comments</div><div class="stat-val" id="sComments">‚Äî</div><div class="stat-note">All comments</div></div>
      </div>
      <div class="chart-row">
        <div class="chart-box"><div class="chart-ttl">Habit Category Distribution</div><div class="chart-wrap"><canvas id="chartCat"></canvas></div></div>
        <div class="chart-box"><div class="chart-ttl">Habits per User (Top 8)</div><div class="chart-wrap"><canvas id="chartUsers"></canvas></div></div>
      </div>
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">Latest Posts</div><button class="refresh" id="refreshBtn">Refresh</button></div>
        <table><thead><tr><th>User</th><th>Content</th><th>Likes</th><th>Comments</th><th>Time</th></tr></thead>
        <tbody id="recentTbody"><tr class="loading-row"><td colspan="5">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Users -->
    <div class="pg" id="pg-users">
      <div class="pg-title">Users</div>
      <div class="pg-sub">All registered users</div>
      <input class="search" id="userSearch" placeholder="Search by name / UID...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">Users</div><div class="tbl-cnt" id="userCnt">‚Äî</div></div>
        <table><thead><tr><th>User</th><th>UID</th><th>Habits</th><th>Posts</th><th>Avg. Completion</th><th>Action</th></tr></thead>
        <tbody id="userTbody"><tr class="loading-row"><td colspan="5">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Posts -->
    <div class="pg" id="pg-posts">
      <div class="pg-title">Posts</div>
      <div class="pg-sub">Review and remove inappropriate posts</div>
      <input class="search" id="postSearch" placeholder="Search by content / username...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">All Posts</div><div class="tbl-cnt" id="postCnt">‚Äî</div></div>
        <table><thead><tr><th>User</th><th>Content</th><th>Media</th><th>Likes</th><th>Comments</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="postTbody"><tr class="loading-row"><td colspan="7">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Habits -->
    <div class="pg" id="pg-habits">
      <div class="pg-title">Habits</div>
      <div class="pg-sub">Habit creation across all users</div>
      <input class="search" id="habitSearch" placeholder="Search by habit name / category...">
      <div class="tbl-card">
        <div class="tbl-hd"><div class="tbl-ttl">All Habits</div><div class="tbl-cnt" id="habitCnt">‚Äî</div></div>
        <table><thead><tr><th>Habit Name</th><th>User</th><th>Category</th><th>Frequency</th><th>Streak</th><th>Completion</th></tr></thead>
        <tbody id="habitTbody"><tr class="loading-row"><td colspan="6">Loading...</td></tr></tbody></table>
      </div>
    </div>

    <!-- Upload Quota -->
    <div class="pg" id="pg-quota">
      <div class="pg-title">Upload Quota</div>
      <div class="pg-sub" id="quotaUpdated">Loading...</div>
      <div class="quota-warn" id="quotaWarn"></div>
      <div class="quota-summary">
        <div class="stat dark"><div class="stat-lbl">Users w/ Uploads</div><div class="stat-val" id="qTotalUsers">‚Äî</div><div class="stat-note">Have uploaded</div></div>
        <div class="stat"><div class="stat-lbl">Total Images</div><div class="stat-val" id="qTotalImages">‚Äî</div><div class="stat-note">All time</div></div>
        <div class="stat"><div class="stat-lbl">Total Videos</div><div class="stat-val" id="qTotalVideos">‚Äî</div><div class="stat-note">All time</div></div>
        <div class="stat"><div class="stat-lbl">Total Data</div><div class="stat-val" id="qTotalMB">‚Äî</div><div class="stat-note">MB (all time)</div></div>
      </div>
      <div class="tbl-card" style="padding:18px;margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="chart-ttl" style="margin:0">This Month ‚Äî Combined Usage of All Users</div>
          <div style="font-size:11px;color:var(--g400);font-family:var(--mono)" id="qMonthLabel">‚Äî</div>
        </div>
        <div class="pct-bar" style="height:10px"><div class="pct-fill" id="qMonthBar" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--g400)">
          <span>0 MB</span><span id="qMonthLimit">Limit per user: ‚Äî MB</span>
        </div>
      </div>
      <div class="tbl-card">
        <div class="tbl-hd">
          <div class="tbl-ttl">Per-User Upload Usage</div>
          <div style="display:flex;align-items:center;gap:8px">
            <select id="quotaSort" style="padding:5px 8px;border:1px solid var(--g200);font-size:10px;font-family:var(--font);outline:none;cursor:pointer">
              <option value="totalMB">Sort: Total MB ‚Üì</option>
              <option value="monthlyMB">Sort: This Month ‚Üì</option>
              <option value="totalImages">Sort: Images ‚Üì</option>
              <option value="totalVideos">Sort: Videos ‚Üì</option>
              <option value="lastUpload">Sort: Last Upload ‚Üì</option>
            </select>
            <button class="refresh" id="quotaRefreshBtn">Refresh</button>
          </div>
        </div>
        <table>
          <thead><tr>
            <th>User</th>
            <th>Today (img / vid)</th>
            <th>This Month</th>
            <th>All Images</th>
            <th>All Videos</th>
            <th>Total MB</th>
            <th>Last Upload</th>
            <th>Reset Daily</th>
          </tr></thead>
          <tbody id="quotaTbody"><tr class="loading-row"><td colspan="8">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Security & Rules -->
    <div class="pg" id="pg-security">
      <div class="pg-title">Security &amp; Rules</div>
      <div class="pg-sub">Firestore Security Rules, Admin SDK setup, and compliance checklist</div>

      <!-- Session status -->
      <div class="tbl-card" style="padding:18px;margin-bottom:20px">
        <div class="chart-ttl" style="margin-bottom:14px">üîê Current Session</div>
        <div style="display:flex;gap:24px;flex-wrap:wrap">
          <div><div class="stat-lbl">Signed In As</div><div style="font-size:13px;font-weight:700;font-family:var(--mono)" id="sec-email">‚Äî</div></div>
          <div><div class="stat-lbl">Auth Method</div><div style="font-size:13px;font-weight:700" id="sec-provider">‚Äî</div></div>
          <div><div class="stat-lbl">Custom Claim (admin)</div><div style="font-size:13px;font-weight:700" id="sec-claim">‚Äî</div></div>
          <div><div class="stat-lbl">Session Timeout</div><div style="font-size:13px;font-weight:700">30 min inactivity</div></div>
        </div>
      </div>

      <!-- Custom Claims setup guide -->
      <div class="tbl-card" style="padding:18px;margin-bottom:20px">
        <div class="chart-ttl" style="margin-bottom:10px">‚öôÔ∏è Step 1 ‚Äî Set Firebase Custom Claim (One-time setup)</div>
        <p style="font-size:12px;color:var(--g500);line-height:1.7;margin-bottom:12px">
          To enable the second layer of admin verification, run this <strong>once</strong> in your Firebase project using the Admin SDK or Cloud Functions. Replace <code style="background:var(--g100);padding:1px 5px;font-size:11px">YOUR_ADMIN_UID</code> with your Firebase UID (visible in Firebase Console ‚Üí Authentication).
        </p>
        <pre style="background:#1e293b;color:#94a3b8;padding:14px 16px;font-size:11px;overflow-x:auto;line-height:1.8;white-space:pre-wrap">// Node.js (Firebase Admin SDK)
const admin = require('firebase-admin');
admin.initializeApp();

await admin.auth().setCustomUserClaims('YOUR_ADMIN_UID', { admin: true });
console.log('‚úÖ Admin claim set successfully');</pre>
        <p style="font-size:11px;color:var(--g400);margin-top:10px">After setting the claim, sign out and sign back in to the admin dashboard for it to take effect.</p>
      </div>

      <!-- Firestore Security Rules -->
      <div class="tbl-card" style="padding:18px;margin-bottom:20px">
        <div class="chart-ttl" style="margin-bottom:10px">üõ°Ô∏è Step 2 ‚Äî Firestore Security Rules</div>
        <p style="font-size:12px;color:var(--g500);line-height:1.7;margin-bottom:12px">
          Copy these rules into <strong>Firebase Console ‚Üí Firestore Database ‚Üí Rules</strong>. These rules enforce that users can only read/write their own data, while the admin account has read access to all collections.
        </p>
        <pre style="background:#1e293b;color:#94a3b8;padding:14px 16px;font-size:11px;overflow-x:auto;line-height:1.8;white-space:pre-wrap">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ‚îÄ‚îÄ Helper: is this request from the admin? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function isAdmin() {
      return request.auth != null
        &amp;&amp; request.auth.token.admin == true
        &amp;&amp; request.auth.token.email == '<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4a2b242e337b7373787a727b720a2d272b232664292527">[email&#160;protected]</a>';
    }

    // ‚îÄ‚îÄ Users collection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    match /users/{userId} {
      allow read:  if request.auth != null &amp;&amp; (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null &amp;&amp; request.auth.uid == userId;
    }

    // ‚îÄ‚îÄ Habits collection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    match /habits/{habitId} {
      allow read:  if request.auth != null
                   &amp;&amp; (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null
                    &amp;&amp; request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null
                            &amp;&amp; resource.data.userId == request.auth.uid;
    }

    // ‚îÄ‚îÄ Posts collection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    match /posts/{postId} {
      allow read:   if request.auth != null;
      allow create: if request.auth != null
                    &amp;&amp; request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null
                    &amp;&amp; resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null
                    &amp;&amp; (resource.data.userId == request.auth.uid || isAdmin());

      // Comments sub-collection
      match /comments/{commentId} {
        allow read:   if request.auth != null;
        allow create: if request.auth != null;
        allow delete: if request.auth != null
                      &amp;&amp; (resource.data.userId == request.auth.uid || isAdmin());
      }
    }

    // ‚îÄ‚îÄ Upload Quotas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    match /upload_quotas/{uid} {
      allow read, write: if request.auth != null &amp;&amp; request.auth.uid == uid;
      allow read:        if isAdmin();
    }
  }
}</pre>
      </div>

      <!-- Compliance checklist -->
      <div class="tbl-card" style="padding:18px;margin-bottom:20px">
        <div class="chart-ttl" style="margin-bottom:14px">‚úÖ Security &amp; Compliance Checklist</div>
        <table>
          <thead><tr><th>Item</th><th>Status</th><th>Notes</th></tr></thead>
          <tbody>
            <tr><td>Firebase Auth email whitelist</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2948474d501810101b19111811694e44484045074a4644">[email&#160;protected]</a></td></tr>
            <tr><td>Firebase Custom Claim (admin:true)</td><td><span class="badge" id="cl-claim-status">‚ö†Ô∏è Check required</span></td><td style="font-size:11px;color:var(--g500)">Set via Admin SDK then re-login</td></tr>
            <tr><td>Session auto-logout (30 min)</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)">Inactivity timer running</td></tr>
            <tr><td>Admin page noindex meta tag</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)">robots: noindex, nofollow</td></tr>
            <tr><td>Force Google account selection</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)">prompt: select_account</td></tr>
            <tr><td>Firestore Security Rules</td><td><span class="badge" style="background:#fef3c7;color:#92400e">‚ö†Ô∏è Verify in Console</span></td><td style="font-size:11px;color:var(--g500)">Copy rules from Step 2 above</td></tr>
            <tr><td>GDPR conditional analytics</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active (index.html)</span></td><td style="font-size:11px;color:var(--g500)">Umami loads after user consent</td></tr>
            <tr><td>Age verification (birth year)</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active (index.html)</span></td><td style="font-size:11px;color:var(--g500)">EU min age 16</td></tr>
            <tr><td>Privacy Settings / consent withdrawal</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active (index.html)</span></td><td style="font-size:11px;color:var(--g500)">Profile ‚Üí Privacy Settings</td></tr>
            <tr><td>Firebase DPA reference in Privacy Policy</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)">Links to firebase.google.com/terms/data-processing-terms</td></tr>
            <tr><td>Cloudinary DPA reference in Privacy Policy</td><td><span class="badge" style="background:#d1fae5;color:#065f46">‚úÖ Active</span></td><td style="font-size:11px;color:var(--g500)">Links to cloudinary.com/privacy/gdpr</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïê‚ïê REPORTS PAGE ‚ïê‚ïê -->
    <div class="pg" id="pg-reports">
      <div class="pg-title">Reports</div>
      <div class="pg-sub" id="reportsUpdated">Loading...</div>

      <!-- Summary stats -->
      <div class="stat-grid" style="margin-bottom:20px">
        <div class="stat dark"><div class="stat-lbl">Total Reports</div><div class="stat-val" id="rTotal">‚Äî</div><div class="stat-note">All time</div></div>
        <div class="stat" style="border-left:3px solid #fbbf24"><div class="stat-lbl">Pending</div><div class="stat-val" id="rPending" style="color:#d97706">‚Äî</div><div class="stat-note">Awaiting review</div></div>
        <div class="stat" style="border-left:3px solid #34d399"><div class="stat-lbl">Reviewed</div><div class="stat-val" id="rReviewed" style="color:#059669">‚Äî</div><div class="stat-note">Action taken</div></div>
        <div class="stat" style="border-left:3px solid var(--g300)"><div class="stat-lbl">Dismissed</div><div class="stat-val" id="rDismissed">‚Äî</div><div class="stat-note">No violation</div></div>
      </div>

      <!-- Filter row -->
      <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
        <select id="reportStatusFilter" onchange="renderReports()" style="padding:7px 10px;border:1px solid var(--g200);font-size:11px;font-family:var(--font);outline:none;cursor:pointer;background:var(--white)">
          <option value="all">All statuses</option>
          <option value="pending" selected>Pending only</option>
          <option value="reviewed">Reviewed</option>
          <option value="dismissed">Dismissed</option>
        </select>
        <select id="reportReasonFilter" onchange="renderReports()" style="padding:7px 10px;border:1px solid var(--g200);font-size:11px;font-family:var(--font);outline:none;cursor:pointer;background:var(--white)">
          <option value="all">All reasons</option>
          <option value="spam">Spam</option>
          <option value="harassment">Harassment</option>
          <option value="hate_speech">Hate speech</option>
          <option value="misinformation">Misinformation</option>
          <option value="inappropriate">Inappropriate</option>
          <option value="other">Other</option>
        </select>
        <button class="refresh" id="reportsRefreshBtn" onclick="loadReports()">Refresh</button>
        <div style="margin-left:auto;font-size:11px;color:var(--g400)" id="reportsCnt"></div>
      </div>

      <!-- Reports table -->
      <div class="tbl-card">
        <table>
          <thead>
            <tr>
              <th style="width:130px">Reported User</th>
              <th>Post Content</th>
              <th style="width:110px">Reason</th>
              <th style="width:90px">Status</th>
              <th style="width:120px">Reported At</th>
              <th style="width:140px">Actions</th>
            </tr>
          </thead>
          <tbody id="reportsTbody">
            <tr class="loading-row"><td colspan="6">Loading reports...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Immediate safety: if Firebase CDN failed to load, show login immediately
if(typeof firebase === 'undefined'){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('loginWrap').style.display='flex';
  document.getElementById('errBox').style.display='block';
  document.getElementById('errBox').textContent='Failed to load Firebase. Please check your internet connection and reload.';
  throw new Error('Firebase not loaded');
}

// ‰ΩøÁî®Áç®Á´ãÂëΩÂêçÁöÑ appÔºåÈÅøÂÖçËàá index.html ÁöÑ auth session ‰∫íÁõ∏Âπ≤Êìæ
var adminApp = firebase.initializeApp({
  apiKey:"AIzaSyDxa2PZEep3eXY1Iiu4IhjXCwXd6z0HelA",
  authDomain:"health-habit-tracker-e6b50.firebaseapp.com",
  projectId:"health-habit-tracker-e6b50",
  storageBucket:"health-habit-tracker-e6b50.firebasestorage.app",
  messagingSenderId:"890093173627",
  appId:"1:890093173627:web:54032fce30ae7ef3f41bde"
}, "admin");
var auth = firebase.auth(adminApp);
var db   = firebase.firestore(adminApp);

// ‚îÄ‚îÄ Admin Security Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Layer 1: Client-side email whitelist (fast UI feedback)
var ALLOWED_ADMINS = [
  'andy19920818@gmail.com',
];
// Layer 2: Firebase Custom Claim key to check (set via Firebase Admin SDK / Functions)
// Set custom claim: { admin: true } on your user account via Firebase Admin SDK
// See: https://firebase.google.com/docs/auth/admin/custom-claims
var ADMIN_CUSTOM_CLAIM = 'admin'; // claim key expected to be true
// Layer 3: Session timeout (auto sign-out after inactivity)
var SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

var allUsers=[], allPosts=[], allHabits=[];
var catChart=null, userChart=null;
var _sessionTimer = null;
var _lastActivity = Date.now();

/* ‚îÄ‚îÄ Activity tracking for session timeout ‚îÄ‚îÄ */
['mousemove','keydown','click','touchstart','scroll'].forEach(function(evt){
  document.addEventListener(evt, function(){ _lastActivity = Date.now(); }, { passive:true });
});
function resetSessionTimer() {
  if (_sessionTimer) clearTimeout(_sessionTimer);
  _sessionTimer = setTimeout(function(){
    if (Date.now() - _lastActivity >= SESSION_TIMEOUT_MS) {
      showAdminError('Session expired due to inactivity. Please sign in again.');
      auth.signOut();
    }
  }, SESSION_TIMEOUT_MS + 5000);
}

function showAdminError(msg) {
  var b = document.getElementById('errBox');
  b.style.display = 'block';
  b.textContent = msg;
}

/* ‚îÄ‚îÄ Multi-layer admin verification ‚îÄ‚îÄ */
async function verifyAdminAccess(user) {
  var email = (user.email || '').toLowerCase().trim();

  // Layer 1: Email whitelist check
  var emailAllowed = ALLOWED_ADMINS.length === 0 ||
    ALLOWED_ADMINS.map(function(e){ return e.toLowerCase().trim(); }).indexOf(email) !== -1;

  if (!emailAllowed) {
    return { allowed: false, reason: 'Access denied: ' + email + ' is not in the admin whitelist.' };
  }

  // Layer 2: Firebase ID Token Custom Claims check
  try {
    var idTokenResult = await user.getIdTokenResult(true); // force refresh
    var hasClaim = idTokenResult.claims && idTokenResult.claims[ADMIN_CUSTOM_CLAIM] === true;

    if (!hasClaim) {
      // Custom claim not set ‚Äî show guidance (non-blocking for initial setup)
      console.warn('[Admin] Custom claim "' + ADMIN_CUSTOM_CLAIM + '" not found. ' +
        'For enhanced security, set this via Firebase Admin SDK: ' +
        'admin.auth().setCustomUserClaims(uid, { admin: true })');
      // For testing phase, allow email-whitelisted users even without claim
      // Remove this allowance in production by returning { allowed: false } here
      return { allowed: true, warning: 'Custom claim not set ‚Äî email whitelist only. Set Firebase custom claim for production.' };
    }

    return { allowed: true };
  } catch (e) {
    console.error('[Admin] Token verification failed:', e);
    // Fall back to email whitelist only if token check fails
    return { allowed: emailAllowed, warning: 'Could not verify custom claims: ' + e.message };
  }
}

// ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var authResolved = false;
var authSafetyTimer = setTimeout(function(){
  if(!authResolved){
    authResolved = true;
    document.getElementById('loadingScreen').style.display='none';
    document.getElementById('loginWrap').style.display='flex';
  }
}, 5000);

auth.onAuthStateChanged(async function(user){
  clearTimeout(authSafetyTimer);
  authResolved = true;
  document.getElementById('loadingScreen').style.display='none';

  if(user){
    var result = await verifyAdminAccess(user);

    if(!result.allowed){
      document.getElementById('loginWrap').style.display='flex';
      document.getElementById('layout').style.display='none';
      showAdminError(result.reason || 'Access denied.');
      return;
    }

    if(result.warning){
      console.warn('[Admin Security]', result.warning);
      // Show a subtle warning in the dashboard
      var warnBar = document.getElementById('adminSecurityWarn');
      if(warnBar){ warnBar.style.display='block'; warnBar.textContent = '‚ö†Ô∏è Security notice: ' + result.warning; }
    }

    document.getElementById('loginWrap').style.display='none';
    document.getElementById('layout').style.display='flex';
    document.getElementById('adminEmail').textContent = user.email||user.displayName||'';

    document.getElementById('sec-email').textContent = user.email || '‚Äî';
    document.getElementById('sec-provider').textContent =
      (user.providerData && user.providerData[0] && user.providerData[0].providerId) || '‚Äî';

    // Check custom claim and update security page
    user.getIdTokenResult(true).then(function(tokenResult) {
      var hasClaim = tokenResult.claims && tokenResult.claims['admin'] === true;
      var claimEl = document.getElementById('sec-claim');
      var claimStatusEl = document.getElementById('cl-claim-status');
      if (claimEl) claimEl.textContent = hasClaim ? '‚úÖ admin: true' : '‚ö†Ô∏è Not set';
      if (claimEl) claimEl.style.color = hasClaim ? '#065f46' : '#92400e';
      if (claimStatusEl) {
        claimStatusEl.textContent = hasClaim ? '‚úÖ Verified' : '‚ö†Ô∏è Not set ‚Äî email whitelist only';
        claimStatusEl.style.background = hasClaim ? '#d1fae5' : '#fef3c7';
        claimStatusEl.style.color = hasClaim ? '#065f46' : '#92400e';
      }
    }).catch(function() {
      var claimEl = document.getElementById('sec-claim');
      if (claimEl) { claimEl.textContent = '‚ö†Ô∏è Could not verify'; claimEl.style.color = '#92400e'; }
    });

    // Start session timeout
    resetSessionTimer();
    // Log admin access (audit trail)
    console.info('[Admin] Access granted to:', user.email, 'at', new Date().toISOString());

    loadAll();
  } else {
    clearTimeout(_sessionTimer);
    document.getElementById('loginWrap').style.display='flex';
    document.getElementById('layout').style.display='none';
  }
});

// Handle redirect sign-in result
var _hasAuthParams = window.location.href.indexOf('__/auth/handler') > -1
  || window.location.search.indexOf('code=') > -1;
if(_hasAuthParams){
  auth.getRedirectResult().then(async function(result){
    if(result && result.user){
      var check = await verifyAdminAccess(result.user);
      if(!check.allowed){
        showAdminError(check.reason || 'Access denied.');
      }
    }
  }).catch(function(e){
    if(e.code && e.code !== 'auth/no-current-user'){
      showAdminError('Sign in failed: ' + e.message);
    }
  });
}

// Login
document.getElementById('loginBtn').onclick = function(){
  var b=document.getElementById('errBox');
  b.style.display='none';
  var provider = new firebase.auth.GoogleAuthProvider();
  // Force account selection to prevent silent re-use of wrong account
  provider.setCustomParameters({ prompt: 'select_account' });
  auth.signInWithPopup(provider).then(async function(result){
    var check = await verifyAdminAccess(result.user);
    if(!check.allowed){
      b.style.display='block';
      b.textContent = check.reason || 'Access denied.';
    }
  }).catch(function(e){
    if(e.code==='auth/popup-blocked'||e.code==='auth/cancelled-popup-request'){
      auth.signInWithRedirect(provider);
    } else if(e.code !== 'auth/popup-closed-by-user'){
      showAdminError('Sign in failed: ' + e.message);
    }
  });
};

// Logout
document.getElementById('logoutBtn').onclick = function(){
  clearTimeout(_sessionTimer);
  auth.signOut();
};

// Refresh
document.getElementById('refreshBtn').onclick = loadAll;

// Nav
document.querySelectorAll('.nav-btn').forEach(function(btn){
  btn.onclick = function(){
    document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('on'); });
    document.querySelectorAll('.pg').forEach(function(p){ p.classList.remove('on'); });
    btn.classList.add('on');
    document.getElementById('pg-'+btn.dataset.page).classList.add('on');
  };
});

// Search
document.getElementById('userSearch').oninput = function(){ renderUsers(this.value); };
document.getElementById('postSearch').oninput = function(){ renderPosts(this.value); };
document.getElementById('habitSearch').oninput = function(){ renderHabits(this.value); };

// Load
function loadAll(){
  document.getElementById('lastUpdated').textContent='Loading...';
  Promise.all([loadHabits(), loadPosts(), loadUsers()]).then(function(){
    buildUsers();
    renderUsers('');
    renderStats();
    renderCharts();
    renderRecent();
    renderUsers('');
    renderPosts('');
    renderHabits('');
    document.getElementById('lastUpdated').textContent='Last updated: '+new Date().toLocaleString('en-US');
  });
  // Quota & Reports Áç®Á´ãËºâÂÖ•
  loadQuota();
  loadReports();
}

function loadUsers(){
  return db.collection('users').get().then(function(snap){
    // Load Firestore users collection first
    window.fsUsers = {};
    snap.docs.forEach(function(d){
      window.fsUsers[d.id] = d.data();
    });
  }).catch(function(){ window.fsUsers={}; });
}

function loadHabits(){
  return db.collection('habits').get().then(function(snap){
    allHabits = snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
  }).catch(function(){ allHabits=[]; });
}

function loadPosts(){
  return db.collection('posts').orderBy('createdAt','desc').get().then(function(snap){
    allPosts = snap.docs.map(function(d){
      var data=d.data();
      var ts=data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      return Object.assign({id:d.id},data,{timeStr:ts?ts.toLocaleString('zh-TW'):'‚Äî'});
    });
    var promises = allPosts.map(function(p){
      return db.collection('posts').doc(p.id).collection('comments').get()
        .then(function(cs){ p.commentCount=cs.size; })
        .catch(function(){ p.commentCount=p.comments||0; });
    });
    return Promise.all(promises);
  }).catch(function(){ allPosts=[]; });
}

function buildUsers(){
  var map={};

  // Add users from Firestore users collection (those who have logged in)
  Object.entries(window.fsUsers||{}).forEach(function(entry){
    var uid=entry[0], u=entry[1];
    map[uid]={uid:uid, name:u.displayName||u.email||'User', email:u.email||'', habits:[], posts:[], lastSeen:u.lastSeen};
  });

  // Supplement from habits
  allHabits.forEach(function(h){
    if(!h.userId) return;
    if(!map[h.userId]) map[h.userId]={uid:h.userId,name:'User',email:'',habits:[],posts:[]};
    map[h.userId].habits.push(h);
  });

  // Supplement from posts
  allPosts.forEach(function(p){
    if(!p.userId) return;
    if(!map[p.userId]) map[p.userId]={uid:p.userId,name:p.user||'User',email:'',habits:[],posts:[]};
    if(p.user) map[p.userId].name=p.user;
    map[p.userId].posts.push(p);
  });

  allUsers=Object.values(map);
}

function renderStats(){
  document.getElementById('sUsers').textContent=allUsers.length;
  document.getElementById('sPosts').textContent=allPosts.length;
  document.getElementById('sHabits').textContent=allHabits.length;
  var c=allPosts.reduce(function(s,p){ return s+(p.commentCount||0); },0);
  document.getElementById('sComments').textContent=c;
}

function renderCharts(){
  var catMap={};
  allHabits.forEach(function(h){ var k=h.category||'Other'; catMap[k]=(catMap[k]||0)+1; });
  if(catChart) catChart.destroy();
  catChart=new Chart(document.getElementById('chartCat'),{
    type:'doughnut',
    data:{labels:Object.keys(catMap),datasets:[{data:Object.values(catMap),backgroundColor:['#0a0a0a','#3d3d3d','#737373','#9a9a9a','#c4c4c4','#e0e0e0','#555','#888']}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:12}}}}
  });
  var ud=allUsers.slice().sort(function(a,b){return b.habits.length-a.habits.length;}).slice(0,8);
  if(userChart) userChart.destroy();
  userChart=new Chart(document.getElementById('chartUsers'),{
    type:'bar',
    data:{labels:ud.map(function(u){return u.name;}),datasets:[{label:'Habits',data:ud.map(function(u){return u.habits.length;}),backgroundColor:'#0a0a0a'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{ticks:{stepSize:1,font:{size:10}}}}}
  });
}

function renderRecent(){
  var tb=document.getElementById('recentTbody');
  var list=allPosts.slice(0,10);
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="5">No posts yet</td></tr>';return;}
  tb.innerHTML=list.map(function(p){
    return '<tr><td><div class="uc"><div class="av">'+((p.avatar||p.user||'?')[0])+'</div>'+htmlEsc(p.user||'‚Äî')+'</div></td>'+
      '<td><div class="ptxt">'+htmlEsc(p.text||'(no text)')+'</div></td>'+
      '<td>'+(p.likes||0)+'</td><td>'+(p.commentCount||0)+'</td>'+
      '<td style="font-size:10px;color:var(--g400)">'+p.timeStr+'</td></tr>';
  }).join('');
}

function renderUsers(f){
  var tb=document.getElementById('userTbody');
  var list=allUsers.filter(function(u){ return !f||u.name.includes(f)||u.uid.includes(f)||(u.email||'').includes(f); });
  document.getElementById('userCnt').textContent=list.length+' user(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="5">No matching users</td></tr>';return;}
  tb.innerHTML=list.map(function(u){
    var r=u.habits.length?Math.round(u.habits.reduce(function(s,h){return s+calcRate(h);},0)/u.habits.length):0;
    return '<tr>'+
      '<td><div class="uc"><div class="av">'+((u.name||'?')[0])+'</div><div><strong>'+htmlEsc(u.name)+'</strong>'+
      '<div style="font-size:10px;color:var(--g400)">'+htmlEsc(u.email||'')+'</div></div></div></td>'+
      '<td style="font-size:10px;color:var(--g400);font-family:var(--mono)">'+u.uid.slice(0,16)+'‚Ä¶</td>'+
      '<td>'+u.habits.length+'</td><td>'+u.posts.length+'</td>'+
      '<td><div class="bar-wrap"><div class="bar-track"><div class="bar-fill" style="width:'+r+'%"></div></div><div class="bar-pct">'+r+'%</div></div></td>'+
      '<td><button class="del" onclick="deleteUserData(\''+u.uid+'\',\''+htmlEsc(u.name)+'\')" title="Delete all Firestore data for this user">Delete Data</button></td></tr>';
  }).join('');
}

function deleteUserData(uid, name){
  if(!confirm('Delete ALL Firestore data for "'+name+'"?\n\nThis will remove:\n‚Ä¢ All habits\n‚Ä¢ All posts (and their comments)\n‚Ä¢ Upload quota record\n‚Ä¢ User profile\n\nNote: You still need to delete the Auth account in Firebase Console.\n\nThis cannot be undone!')) return;
  var tasks=[];
  // Delete habits
  tasks.push(db.collection('habits').where('userId','==',uid).get().then(function(snap){
    var b=db.batch();
    snap.docs.forEach(function(d){b.delete(d.ref);});
    return snap.docs.length?b.commit():Promise.resolve();
  }));
  // Delete posts + their comments
  tasks.push(db.collection('posts').where('userId','==',uid).get().then(function(snap){
    return Promise.all(snap.docs.map(function(d){
      return d.ref.collection('comments').get().then(function(cs){
        var b=db.batch();
        cs.docs.forEach(function(c){b.delete(c.ref);});
        b.delete(d.ref);
        return b.commit();
      });
    }));
  }));
  // Delete upload quota
  tasks.push(db.collection('upload_quotas').doc(uid).delete().catch(function(){}));
  // Delete user profile
  tasks.push(db.collection('users').doc(uid).delete().catch(function(){}));

  Promise.all(tasks).then(function(){
    alert('Done! All Firestore data for "'+name+'" has been deleted.\nRemember to also delete the Auth account in Firebase Console.');
    loadAll();
  }).catch(function(e){
    alert('Error: '+e.message);
  });
}

function renderPosts(f){
  var tb=document.getElementById('postTbody');
  var list=allPosts.filter(function(p){ return !f||(p.text||'').includes(f)||(p.user||'').includes(f); });
  document.getElementById('postCnt').textContent=list.length+' post(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="7">No matching posts</td></tr>';return;}
  tb.innerHTML=list.map(function(p){
    return '<tr><td><div class="uc"><div class="av">'+((p.avatar||p.user||'?')[0])+'</div>'+htmlEsc(p.user||'‚Äî')+'</div></td>'+
      '<td><div class="ptxt">'+htmlEsc(p.text||'(no text)')+'</div></td>'+
      '<td>'+(p.hasImage?'üì∑':p.hasVideo?'üé¨':'‚Äî')+'</td>'+
      '<td>'+(p.likes||0)+'</td><td>'+(p.commentCount||0)+'</td>'+
      '<td style="font-size:10px;color:var(--g400)">'+p.timeStr+'</td>'+
      '<td><button class="del" onclick="delPost(\''+p.id+'\')">Delete</button></td></tr>';
  }).join('');
}

function delPost(id){
  if(!confirm('Are you sure you want to delete this post?')) return;
  db.collection('posts').doc(id).delete().then(function(){
    allPosts=allPosts.filter(function(p){return p.id!==id;});
    buildUsers(); // ‚úÖ ÈáçÊñ∞Ë®àÁÆóÊØè‰ΩçÁî®Êà∂ÁöÑ post Êï∏Èáè
    renderStats();
    renderRecent();
    renderPosts(document.getElementById('postSearch').value);
    renderUsers(document.getElementById('userSearch').value); // ‚úÖ ÂêåÊ≠•Êõ¥Êñ∞ Users È†ÅÈù¢
  }).catch(function(e){ alert('Delete failed: '+e.message); });
}

function renderHabits(f){
  var tb=document.getElementById('habitTbody');
  var list=allHabits.filter(function(h){ return !f||(h.name||'').includes(f)||(h.category||'').includes(f); });
  document.getElementById('habitCnt').textContent=list.length+' habit(s)';
  if(!list.length){tb.innerHTML='<tr class="loading-row"><td colspan="6">No matching habits</td></tr>';return;}
  var nm={};
  allUsers.forEach(function(u){ nm[u.uid]=u.name; });
  tb.innerHTML=list.map(function(h){
    var r=calcRate(h);
    return '<tr><td><strong>'+htmlEsc(h.name||'‚Äî')+'</strong></td>'+
      '<td>'+(nm[h.userId]||((h.userId||'').slice(0,8))||'‚Äî')+'</td>'+
      '<td><span class="badge">'+htmlEsc(h.category||'‚Äî')+'</span></td>'+
      '<td style="font-size:11px">'+(h.freqLabel||'Daily')+'</td>'+
      '<td style="font-family:var(--mono);font-size:11px">'+(h.streak||0)+' days</td>'+
      '<td><div class="bar-wrap"><div class="bar-track"><div class="bar-fill" style="width:'+r+'%"></div></div><div class="bar-pct">'+r+'%</div></div></td>'+
      '<td><button class="del" onclick="deleteUserData(\''+u.uid+'\',\''+htmlEsc(u.name)+'\')" title="Delete all Firestore data for this user">Delete Data</button></td></tr>';
  }).join('');
}

function calcRate(h){
  var tpc=h.dailyTarget||1, id=h.intervalDays||1;
  var tr=h.timeRange||'', parts=tr.split(/ÔΩû|~/).map(function(s){return s.trim().replace(/\//g,'-');});
  var td=function(s){var a=s.split('-').map(Number);return new Date(a[0],a[1]-1,a[2]);};
  var s=parts[0]?td(parts[0]):new Date(), e=parts[1]?td(parts[1]):new Date();
  var days=Math.max(1,Math.round((e-s)/86400000)+1);
  var exp=Math.ceil(days/id)*tpc;
  var done=Object.entries(h.todayCounts||{}).reduce(function(sum,kv){return sum+Math.min(tpc,Math.max(0,kv[1]||0));},0);
  return Math.min(100,Math.round(done/exp*100));
}

function htmlEsc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UPLOAD QUOTA
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var QUOTA_LIMITS = {
  DAILY_IMAGE_COUNT: 5,
  DAILY_VIDEO_COUNT: 2,
  MONTHLY_TOTAL_MB: 500,
};
var allQuotas = [];

document.getElementById('quotaRefreshBtn').onclick = loadQuota;
document.getElementById('quotaSort').onchange = function(){ renderQuota(); };

function getThisMonth(){ return new Date().toISOString().slice(0,7); }
function getToday(){ return new Date().toISOString().slice(0,10); }

function loadQuota(){
  document.getElementById('quotaUpdated').textContent = 'Loading...';
  db.collection('upload_quotas').get().then(function(snap){
    allQuotas = snap.docs.map(function(d){
      var data = d.data();
      var lastAt = data.lastUploadAt && data.lastUploadAt.toDate ? data.lastUploadAt.toDate() : null;
      return Object.assign({id:d.id}, data, {lastUploadDate: lastAt});
    });
    renderQuota();
    document.getElementById('quotaUpdated').textContent = 'Last updated: '+new Date().toLocaleString('zh-TW');
  }).catch(function(e){
    document.getElementById('quotaUpdated').textContent = '‚ö†Ô∏è Load failed: '+e.message;
    document.getElementById('quotaTbody').innerHTML =
      '<tr><td colspan="8" style="padding:20px 18px;color:#c00;font-size:12px;line-height:1.8">' +
      '<strong>&#10060; Firestore &#27491;&#38480;&#19981;&#36275;</strong><br>' +
      'Admin &#24115;&#34399;&#23616;&#26410;&#34987;&#25480;&#27177;&#35712;&#21462; upload_quotas collection&#12290;<br>' +
      '&#35531;&#22312; Firebase Console &#8594; Firestore &#8594; Rules &#21152;&#20837;&#20197;&#19979;&#35215;&#21017;&#65306;<br><br>' +
      '<code style="background:#1e293b;color:#94a3b8;padding:10px 14px;display:block;margin-top:6px;font-size:11px;border-radius:2px;white-space:pre-wrap">' +
      'match /upload_quotas/{uid} {\n' +
      '  allow read, write: if request.auth != null\n' +
      '    &amp;&amp; request.auth.uid == uid;\n' +
      '  // Admin read-all (replace with your email)\n' +
      '  allow read: if request.auth != null\n' +
      '    &amp;&amp; request.auth.token.email == \"YOUR_ADMIN@EMAIL.COM\";\n' +
      '}</code></td></tr>';
  });
}

function renderQuota(){
  var month = getThisMonth(), today = getToday();
  var sortKey = document.getElementById('quotaSort').value;

  // Sort
  var list = allQuotas.slice().sort(function(a,b){
    if(sortKey==='lastUpload'){
      var at = a.lastUploadDate||new Date(0), bt = b.lastUploadDate||new Date(0);
      return bt-at;
    }
    if(sortKey==='monthlyMB'){
      var am = a.monthlyMonth===month ? (a.monthlyMB||0) : 0;
      var bm = b.monthlyMonth===month ? (b.monthlyMB||0) : 0;
      return bm-am;
    }
    return (b[sortKey]||0)-(a[sortKey]||0);
  });

  // Summary stats
  var sumImages=0, sumVideos=0, sumMB=0, sumMonthMB=0;
  list.forEach(function(q){
    sumImages += q.totalImages||0;
    sumVideos += q.totalVideos||0;
    sumMB     += q.totalMB||0;
    if(q.monthlyMonth===month) sumMonthMB += q.monthlyMB||0;
  });

  document.getElementById('qTotalUsers').textContent  = list.length;
  document.getElementById('qTotalImages').textContent = sumImages;
  document.getElementById('qTotalVideos').textContent = sumVideos;
  document.getElementById('qTotalMB').textContent     = sumMB.toFixed(1)+' MB';

  // Monthly bar (combined all users vs limit * users)
  var combinedLimit = QUOTA_LIMITS.MONTHLY_TOTAL_MB * Math.max(1, list.length);
  var monthPct = Math.min(100, Math.round(sumMonthMB / combinedLimit * 100));
  document.getElementById('qMonthLabel').textContent = sumMonthMB.toFixed(1)+' / '+combinedLimit+' MB';
  document.getElementById('qMonthLimit').textContent = 'Limit: '+QUOTA_LIMITS.MONTHLY_TOTAL_MB+' MB / user';
  var bar = document.getElementById('qMonthBar');
  bar.style.width = monthPct+'%';
  bar.className = 'pct-fill'+(monthPct>=90?' danger':monthPct>=70?' warn':'');

  // Warn box
  var heavyUsers = list.filter(function(q){
    var mm = q.monthlyMonth===month ? q.monthlyMB||0 : 0;
    return mm > QUOTA_LIMITS.MONTHLY_TOTAL_MB * 0.8;
  });
  var warnEl = document.getElementById('quotaWarn');
  if(heavyUsers.length){
    warnEl.className='quota-warn show';
    warnEl.textContent = '‚ö†Ô∏è '+heavyUsers.length+' user(s) have used over 80% of their monthly quota: '+heavyUsers.map(function(q){return q.displayName||q.uid.slice(0,8);}).join(', ');
  } else {
    warnEl.className='quota-warn';
  }

  // Table
  var tb = document.getElementById('quotaTbody');
  if(!list.length){ tb.innerHTML='<tr class="loading-row"><td colspan="8">No upload records yet</td></tr>'; return; }
  tb.innerHTML = list.map(function(q){
    var dImg = q.dailyDate===today ? (q.dailyImages||0) : 0;
    var dVid = q.dailyDate===today ? (q.dailyVideos||0) : 0;
    var mMB  = q.monthlyMonth===month ? (q.monthlyMB||0) : 0;
    var mPct = Math.min(100, Math.round(mMB / QUOTA_LIMITS.MONTHLY_TOTAL_MB * 100));
    var mCls = mPct>=90?'danger':mPct>=70?'warn':'';
    var lastStr = q.lastUploadDate ? q.lastUploadDate.toLocaleString('zh-TW') : '‚Äî';
    var imgCls = dImg>=QUOTA_LIMITS.DAILY_IMAGE_COUNT ? 'color:#c00;font-weight:700' : '';
    var vidCls = dVid>=QUOTA_LIMITS.DAILY_VIDEO_COUNT ? 'color:#c00;font-weight:700' : '';
    return '<tr>'+
      '<td><div class="uc"><div class="av">'+((q.displayName||q.uid||'?')[0].toUpperCase())+'</div>'+
        '<div><strong>'+htmlEsc(q.displayName||'Unknown')+'</strong>'+
        '<div class="uid-small">'+htmlEsc(q.email||q.uid||'')+'</div></div></div></td>'+
      '<td style="font-family:var(--mono);font-size:11px">'+
        '<span style="'+imgCls+'">üì∑ '+dImg+'/'+QUOTA_LIMITS.DAILY_IMAGE_COUNT+'</span>„ÄÄ'+
        '<span style="'+vidCls+'">üé¨ '+dVid+'/'+QUOTA_LIMITS.DAILY_VIDEO_COUNT+'</span></td>'+
      '<td style="min-width:160px">'+
        '<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">'+
          '<span style="font-family:var(--mono);font-weight:700;color:var(--black)">'+mMB.toFixed(1)+' MB</span>'+
          '<span style="color:var(--g400)">/ '+QUOTA_LIMITS.MONTHLY_TOTAL_MB+' MB &nbsp;('+mPct+'%)</span></div>'+
        '<div class="pct-bar" style="height:8px"><div class="pct-fill '+mCls+'" style="width:'+mPct+'%"></div></div>'+
        '<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--g400);margin-top:2px">'+
          '<span>0</span><span>'+QUOTA_LIMITS.MONTHLY_TOTAL_MB+' MB</span></div></td>'+
      '<td style="font-family:var(--mono);font-size:12px">'+(q.totalImages||0)+'</td>'+
      '<td style="font-family:var(--mono);font-size:12px">'+(q.totalVideos||0)+'</td>'+
      '<td style="font-family:var(--mono);font-size:12px;font-weight:700">'+((q.totalMB||0).toFixed(2))+' MB</td>'+
      '<td style="font-size:10px;color:var(--g400)">'+lastStr+'</td>'+
      '<td><button class="del" onclick="resetUserDaily(\''+q.id+'\')">Reset Daily</button></td>'+
    '</tr>';
  }).join('');
}

// ‚îÄ‚îÄ Mobile sidebar toggle ‚îÄ‚îÄ
document.getElementById('hamburgerBtn').onclick = function(){ toggleSidebar(true); };
document.getElementById('sidebarOverlay').onclick = function(){ toggleSidebar(false); };
function toggleSidebar(open){
  document.querySelector('.sidebar').classList.toggle('sb-open', open);
  document.getElementById('sidebarOverlay').classList.toggle('sb-open', open);
}
// Close sidebar on nav click (mobile)
document.querySelectorAll('.nav-btn').forEach(function(btn){
  btn.addEventListener('click', function(){ if(window.innerWidth<=768) toggleSidebar(false); });
});

function resetUserDaily(uid){
  if(!confirm('Reset today\'s upload count for this user?')) return;
  db.collection('upload_quotas').doc(uid).update({
    dailyDate: '1970-01-01', dailyImages: 0, dailyVideos: 0,
  }).then(function(){ loadQuota(); }).catch(function(e){ alert('Failed: '+e.message); });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REPORTS ‚Äî load, render, actions
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var allReports = [];

function loadReports(){
  document.getElementById('reportsUpdated').textContent = 'Loading...';
  db.collection('reports').orderBy('reportedAt','desc').get()
    .then(function(snap){
      allReports = snap.docs.map(function(d){
        var data = d.data();
        var ts = data.reportedAt && data.reportedAt.toDate ? data.reportedAt.toDate() : null;
        return Object.assign({ id: d.id }, data, { reportedAtDate: ts });
      });
      updateReportsBadge();
      renderReportStats();
      renderReports();
      document.getElementById('reportsUpdated').textContent = 'Last updated: ' + new Date().toLocaleString('en-US');
    })
    .catch(function(e){
      document.getElementById('reportsUpdated').textContent = '‚ö†Ô∏è Load failed: ' + e.message;
      document.getElementById('reportsTbody').innerHTML =
        '<tr><td colspan="6" style="padding:20px;color:#c00;font-size:12px">Failed to load reports: ' + htmlEsc(e.message) +
        '<br><br>Ensure Firestore Rules allow admin to read <code>reports</code> collection.</td></tr>';
    });
}

function updateReportsBadge(){
  var pending = allReports.filter(function(r){ return r.status === 'pending'; }).length;
  var badge = document.getElementById('reportsBadge');
  if (!badge) return;
  if (pending > 0) {
    badge.textContent = pending;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

function renderReportStats(){
  var total     = allReports.length;
  var pending   = allReports.filter(function(r){ return r.status==='pending'; }).length;
  var reviewed  = allReports.filter(function(r){ return r.status==='reviewed'; }).length;
  var dismissed = allReports.filter(function(r){ return r.status==='dismissed'; }).length;
  document.getElementById('rTotal').textContent     = total;
  document.getElementById('rPending').textContent   = pending;
  document.getElementById('rReviewed').textContent  = reviewed;
  document.getElementById('rDismissed').textContent = dismissed;
}

var REASON_LABELS = {
  spam:          'üì¢ Spam',
  harassment:    'üò° Harassment',
  hate_speech:   'üö´ Hate speech',
  misinformation:'‚ö†Ô∏è Misinformation',
  inappropriate: 'üîû Inappropriate',
  other:         'üìù Other'
};

var STATUS_STYLE = {
  pending:   'background:#fef3c7;color:#92400e;',
  reviewed:  'background:#d1fae5;color:#065f46;',
  dismissed: 'background:#f3f4f6;color:#6b7280;'
};

function renderReports(){
  var statusFilter = document.getElementById('reportStatusFilter').value;
  var reasonFilter = document.getElementById('reportReasonFilter').value;

  var list = allReports.filter(function(r){
    if (statusFilter !== 'all' && r.status !== statusFilter) return false;
    if (reasonFilter !== 'all' && r.reason !== reasonFilter) return false;
    return true;
  });

  document.getElementById('reportsCnt').textContent = list.length + ' report(s) shown';
  var tb = document.getElementById('reportsTbody');
  if (!list.length) {
    tb.innerHTML = '<tr class="loading-row"><td colspan="6">No reports match the current filter</td></tr>';
    return;
  }

  tb.innerHTML = list.map(function(r){
    var reasonLabel  = REASON_LABELS[r.reason] || r.reason || '‚Äî';
    var statusStyle  = STATUS_STYLE[r.status] || '';
    var statusLabel  = (r.status || 'pending').charAt(0).toUpperCase() + (r.status||'pending').slice(1);
    var timeStr      = r.reportedAtDate ? r.reportedAtDate.toLocaleString('en-US',{month:'numeric',day:'numeric',year:'2-digit',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    var postPreview  = htmlEsc((r.postText||'(no text)').slice(0,80)) + ((r.postText||'').length>80?'‚Ä¶':'');
    var reportedUser = htmlEsc(r.reportedUserName || r.reportedUserId || '‚Äî');
    var postIdShort  = r.postId ? r.postId.slice(0,10)+'‚Ä¶' : '‚Äî';

    // Action buttons depending on status
    var actionBtns = '';
    if (r.status === 'pending') {
      actionBtns =
        '<button class="del" style="background:#059669;color:#fff;border-color:#059669;margin-right:4px" '
        + 'onclick="setReportStatus(\''+r.id+'\',\'reviewed\')" title="Mark as reviewed ‚Äî post has been actioned">‚úì Reviewed</button>'
        + '<button class="del" style="color:var(--g500)" '
        + 'onclick="setReportStatus(\''+r.id+'\',\'dismissed\')" title="Dismiss ‚Äî no violation found">‚úó Dismiss</button>';
    } else {
      actionBtns =
        '<button class="del" onclick="setReportStatus(\''+r.id+'\',\'pending\')" title="Move back to pending">‚Ü© Reopen</button>';
    }

    return '<tr>'
      + '<td><div class="uc"><div class="av">' + (reportedUser[0]||'?').toUpperCase() + '</div>'
      + '<div><strong style="font-size:12px">' + reportedUser + '</strong>'
      + '<div style="font-size:9px;color:var(--g400);font-family:var(--mono)">' + htmlEsc(r.reportedUserId||'').slice(0,16) + '</div></div></div></td>'
      + '<td><div class="ptxt" title="' + htmlEsc(r.postText||'') + '">' + postPreview + '</div>'
      + '<div style="font-size:9px;color:var(--g400);font-family:var(--mono);margin-top:2px">ID: ' + htmlEsc(postIdShort) + '</div></td>'
      + '<td style="font-size:11px">' + reasonLabel + '</td>'
      + '<td><span class="badge" style="' + statusStyle + '">' + statusLabel + '</span></td>'
      + '<td style="font-size:10px;color:var(--g400)">' + timeStr + '</td>'
      + '<td>' + actionBtns + '</td>'
      + '</tr>';
  }).join('');
}

function setReportStatus(reportId, newStatus){
  db.collection('reports').doc(reportId).update({
    status: newStatus,
    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
    reviewedBy: auth.currentUser ? auth.currentUser.email : 'admin'
  }).then(function(){
    // Update in-memory
    var r = allReports.find(function(x){ return x.id === reportId; });
    if (r) r.status = newStatus;
    updateReportsBadge();
    renderReportStats();
    renderReports();
  }).catch(function(e){ alert('Update failed: ' + e.message); });
}

</script>
</body>
</html>