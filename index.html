<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Habit Tracker Pro - Community Edition">
    <meta name="theme-color" content="#000000">
    <title>Habit Tracker Pro</title>

    <!-- ── PWA ── -->
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HabitTracker">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./icons/icon-144x144.png">
    <!-- Splash screens for iOS -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- ── Umami Analytics ── -->
    <script defer src="https://umami-psi-opal.vercel.app/script.js" data-website-id="6dd260f7-7f10-4321-b579-dada371b2b34"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #0a0a0a;
            --gray-900: #1a1a1a;
            --gray-800: #2a2a2a;
            --gray-700: #3d3d3d;
            --gray-600: #555555;
            --gray-500: #737373;
            --gray-400: #9a9a9a;
            --gray-300: #c4c4c4;
            --gray-200: #e0e0e0;
            --gray-100: #f0f0f0;
            --gray-50: #f8f8f8;
            --white: #ffffff;
            --font: 'DM Sans', sans-serif;
            --mono: 'DM Mono', monospace;
            --din: 'Barlow Condensed', 'DM Mono', monospace;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: var(--font);
            background: var(--white);
            color: var(--black);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            position: relative;
        }


        /* ── HISTORY PAGE ── */
        .history-page { min-height:100vh; background:var(--white); }
        .history-nav { display:flex; align-items:center; gap:10px; padding:16px 20px 12px; border-bottom:1px solid var(--gray-100); }
        .history-nav-back { background:none; border:none; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--gray-600); font-family:var(--font); padding:0; }
        .history-nav-back:hover { color:var(--black); }
        .history-nav-title { font-size:15px; font-weight:700; font-family:var(--din); letter-spacing:.5px; }

        /* chart section */
        .history-chart-section { padding:24px 20px 16px; background:var(--black); color:var(--white); }
        .history-chart-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; opacity:.5; margin-bottom:16px; }
        .history-charts-row { display:flex; gap:16px; align-items:center; }
        .donut-wrap { position:relative; flex-shrink:0; }
        .donut-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; }
        .donut-center-val { font-size:22px; font-weight:700; font-family:var(--din); line-height:1; }
        .donut-center-lbl { font-size:9px; opacity:.55; text-transform:uppercase; letter-spacing:.8px; margin-top:2px; }
        .history-legend { flex:1; display:flex; flex-direction:column; gap:10px; }
        .legend-item { display:flex; align-items:center; gap:8px; }
        .legend-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
        .legend-label { font-size:11px; opacity:.65; flex:1; }
        .legend-val { font-size:14px; font-weight:700; font-family:var(--din); }

        /* percentile banner */
        .history-percentile { margin:0; padding:16px 20px; background:#111; border-top:1px solid #222; display:flex; align-items:center; gap:14px; }
        .percentile-big { font-size:40px; font-weight:700; font-family:var(--din); color:var(--white); line-height:1; }
        .percentile-big span { font-size:20px; }
        .percentile-text { flex:1; }
        .percentile-text strong { display:block; font-size:13px; color:var(--white); margin-bottom:3px; }
        .percentile-text small { font-size:11px; color:rgba(255,255,255,.5); }
        .percentile-bar-wrap { margin-top:8px; }
        .percentile-bar-track { height:2px; background:rgba(255,255,255,.15); }
        .percentile-bar-fill { height:100%; background:var(--white); transition:width 1s cubic-bezier(.4,0,.2,1); }

        /* archive list */
        .archive-list-section { padding:20px; }
        .archive-list-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
        .archive-count-badge { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--gray-400); }
        .archive-item {
            border:1px solid var(--gray-200); margin-bottom:10px;
            overflow:hidden; transition:border-color .15s;
        }
        .archive-item:hover { border-color:var(--gray-500); }
        .archive-item-top { padding:14px 16px 10px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
        .archive-item-left { flex:1; min-width:0; }
        .archive-item-name { font-size:14px; font-weight:600; color:var(--black); margin-bottom:4px; }
        .archive-item-range { font-size:10px; color:var(--gray-400); font-family:var(--din); letter-spacing:.3px; }
        .archive-rate-circle { width:50px; height:50px; flex-shrink:0; position:relative; }
        .archive-item-tags { padding:0 16px 12px; display:flex; gap:6px; flex-wrap:wrap; }
        .archive-tag { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding:2px 7px; background:var(--gray-100); color:var(--gray-500); }
        .archive-prog-bar { height:3px; background:var(--gray-100); }
        .archive-prog-fill { height:100%; transition:width .6s cubic-bezier(.4,0,.2,1); }

        /* history entry button in profile */
        .history-entry-btn {
            width:100%; display:flex; align-items:center; justify-content:space-between;
            padding:16px; border:1px solid var(--gray-200); background:var(--white);
            cursor:pointer; transition:.15s; font-family:var(--font); margin-top:4px;
        }
        .history-entry-btn:hover { border-color:var(--black); background:var(--gray-50); }
        .history-entry-left { display:flex; align-items:center; gap:12px; }
        .history-entry-icon { width:36px; height:36px; background:var(--black); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .history-entry-text strong { display:block; font-size:13px; font-weight:700; color:var(--black); }
        .history-entry-text span { font-size:11px; color:var(--gray-400); }
        .history-entry-arrow { color:var(--gray-300); }
        /* ── COMMENTS ── */
        .comments-section { border-top:1px solid var(--gray-100); padding:10px 14px; }
        .comment-item { display:flex; gap:9px; margin-bottom:10px; }
        .comment-avatar { width:26px; height:26px; background:var(--gray-100); border:1px solid var(--gray-200); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; flex-shrink:0; }
        .comment-body { flex:1; }
        .comment-user { font-size:11px; font-weight:700; color:var(--black); margin-bottom:2px; }
        .comment-text { font-size:12px; color:var(--gray-700); line-height:1.5; }
        .comment-time { font-size:9px; color:var(--gray-400); margin-top:2px; text-transform:uppercase; letter-spacing:.4px; }
        .comment-input-row { display:flex; gap:8px; margin-top:8px; }
        .comment-input { flex:1; padding:8px 10px; border:1px solid var(--gray-200); font-size:12px; font-family:var(--font); outline:none; background:var(--white); color:var(--black); border-radius:0; }
        .comment-input:focus { border-color:var(--black); }
        .comment-send { padding:8px 13px; background:var(--black); color:var(--white); border:none; font-size:10px; font-weight:700; cursor:pointer; font-family:var(--font); text-transform:uppercase; letter-spacing:.8px; flex-shrink:0; }
        .comment-send:disabled { background:var(--gray-300); cursor:not-allowed; }
        .comments-toggle { font-size:11px; color:var(--gray-500); cursor:pointer; font-weight:600; padding:4px 0; display:inline-block; }
        .comments-toggle:hover { color:var(--black); }

        /* ── PWA INSTALL BANNER ── */
        .pwa-install-banner {
            position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
            max-width:440px; width:calc(100% - 32px);
            background:var(--black); color:var(--white);
            padding:14px 16px; display:flex; align-items:center; gap:12px;
            z-index:500; box-shadow:0 4px 24px rgba(0,0,0,.25);
            animation: slideUp .3s ease;
        }
        @keyframes slideUp { from { opacity:0; transform:translateX(-50%) translateY(20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
        .pwa-install-icon { width:40px; height:40px; flex-shrink:0; border-radius:8px; overflow:hidden; }
        .pwa-install-icon img { width:100%; height:100%; }
        .pwa-install-text { flex:1; }
        .pwa-install-text strong { display:block; font-size:13px; font-weight:700; margin-bottom:2px; }
        .pwa-install-text span { font-size:11px; opacity:.6; }
        .pwa-install-btn { padding:8px 14px; background:var(--white); color:var(--black); border:none; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; cursor:pointer; font-family:var(--font); white-space:nowrap; }
        .pwa-install-close { background:none; border:none; color:rgba(255,255,255,.5); font-size:18px; cursor:pointer; padding:0 4px; line-height:1; flex-shrink:0; }
        /* ── NOTIF PROMPT ── */
        .notif-prompt {
            position:fixed; top:0; left:50%; transform:translateX(-50%);
            max-width:480px; width:100%; background:var(--white);
            border-bottom:2px solid var(--black); padding:14px 20px;
            display:flex; align-items:center; gap:12px; z-index:600;
            box-shadow:0 2px 16px rgba(0,0,0,.1);
            animation: slideDown .3s ease;
        }
        @keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
        .notif-prompt-text { flex:1; font-size:12px; color:var(--gray-700); line-height:1.5; }
        .notif-prompt-text strong { display:block; font-size:13px; font-weight:700; color:var(--black); margin-bottom:2px; }
        .notif-yes { padding:7px 14px; background:var(--black); color:var(--white); border:none; font-size:11px; font-weight:700; cursor:pointer; font-family:var(--font); }
        .notif-no  { padding:7px 10px; background:none; border:none; font-size:11px; color:var(--gray-400); cursor:pointer; font-family:var(--font); }

        /* ── CLOUDINARY UPLOAD OVERLAY ── */
        .upload-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,.6);
            display:flex; align-items:center; justify-content:center; z-index:2000;
        }
        .upload-overlay-box {
            background:var(--white); padding:32px 28px; max-width:320px; width:90%;
            text-align:center; border-top:3px solid var(--black);
        }
        .upload-overlay-title { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
        .upload-overlay-sub { font-size:11px; color:var(--gray-400); }
        .upload-progress-bar { height:4px; background:var(--gray-100); margin-top:16px; overflow:hidden; }
        .upload-progress-fill { height:100%; background:var(--black); transition:width .3s; }
        .cloudinary-setup-box {
            background:#fffbe6; border:1px solid #e0c060; padding:14px 16px;
            margin-bottom:16px; font-size:11px; color:#7a6000; line-height:1.6;
        }
        .cloudinary-setup-box a { color:#7a6000; font-weight:700; }
        .cloudinary-setup-box code { background:#f5e97a; padding:1px 4px; font-size:10px; border-radius:2px; }

        /* avatar upload */
        .profile-avatar-wrap { position:relative; width:72px; margin:0 auto 14px; cursor:pointer; }
        .profile-avatar-wrap:hover .avatar-edit-overlay { opacity:1; }
        .avatar-edit-overlay {
            position:absolute; inset:0; background:rgba(0,0,0,.45);
            display:flex; align-items:center; justify-content:center;
            font-size:9px; font-weight:700; text-transform:uppercase;
            letter-spacing:.8px; color:white; opacity:0; transition:.2s;
        }
        .avatar-img { width:72px; height:72px; object-fit:cover; border:2px solid var(--black); display:block; }

        /* ── AUTH ── */
        .auth-page {
            display:flex; flex-direction:column;
            justify-content:center; align-items:center;
            min-height:100vh; padding:40px 20px;
            background: var(--white);
        }
        .auth-logo {
            font-size:28px; font-weight:700; letter-spacing:-1px;
            margin-bottom:4px; font-family:var(--din);
        }
        .auth-subtitle { font-size:13px; color:var(--gray-500); margin-bottom:48px; font-weight:400; letter-spacing:2px; text-transform:uppercase; }
        .auth-form { width:100%; max-width:360px; }
        .form-group { margin-bottom:16px; }
        .form-label { display:block; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:8px; color:var(--gray-600); }
        .form-input { width:100%; padding:13px 14px; border:1px solid var(--gray-200); font-size:14px; font-family:var(--font); transition:border-color .2s; background:var(--white); color:var(--black); border-radius:0; outline:none; }
        .form-input:focus { border-color:var(--black); }
        .form-input option { font-family: var(--font); }
        .button { width:100%; padding:13px; border:none; font-size:12px; font-weight:700; cursor:pointer; transition:all .2s; text-transform:uppercase; letter-spacing:1.5px; font-family:var(--font); border-radius:0; }
        .button-primary { background:var(--black); color:var(--white); margin-bottom:10px; }
        .button-primary:hover { background:var(--gray-800); }
        .button-primary:disabled { background:var(--gray-400); cursor:not-allowed; }
        .button-secondary { background:var(--white); color:var(--black); border:1px solid var(--gray-200); }
        .button-secondary:hover { background:var(--gray-50); border-color:var(--black); }
        .auth-switch { text-align:center; margin-top:24px; font-size:13px; color:var(--gray-500); }
        .auth-switch a { color:var(--black); text-decoration:none; font-weight:700; cursor:pointer; }
        .demo-badge { background:var(--gray-50); border:1px solid var(--gray-200); padding:12px 16px; margin-bottom:24px; font-size:12px; max-width:360px; width:100%; color:var(--gray-600); }
        .demo-badge strong { color:var(--black); }
        .error-message { background:var(--black); color:var(--white); padding:12px 16px; margin-bottom:16px; font-size:12px; max-width:360px; width:100%; }

        /* ── HEADER ── */
        .header {
            background:var(--black); padding:18px 20px;
            color:var(--white); display:flex;
            justify-content:space-between; align-items:center;
            position:sticky; top:0; z-index:100;
        }
        .header-title h1 { font-size:17px; font-weight:700; letter-spacing:-0.3px; font-family:var(--din); }
        .header-title p { font-size:11px; opacity:.5; margin-top:2px; letter-spacing:.5px; }
        .logout-btn { padding:6px 12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); color:white; font-size:10px; cursor:pointer; text-transform:uppercase; letter-spacing:1px; font-weight:700; font-family:var(--font); transition:.2s; }
        .logout-btn:hover { background:rgba(255,255,255,.16); }

        /* ── CONTENT ── */
        .content { padding:20px; padding-bottom:90px; }

        /* ── TAB BAR ── */
        .tab-bar {
            position:fixed; bottom:0; left:50%; transform:translateX(-50%);
            max-width:480px; width:100%; background:var(--white);
            border-top:1px solid var(--gray-200);
            display:flex; justify-content:space-around; padding:10px 0 12px;
            z-index:200;
        }
        .tab-item { flex:1; text-align:center; padding:4px; cursor:pointer; border:none; background:none; color:var(--gray-400); transition:color .15s; }
        .tab-item.active { color:var(--black); }
        .tab-item svg { width:20px; height:20px; display:block; margin:0 auto 3px; }
        .tab-item span { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; display:block; }

        /* ── HOME ADD BUTTON ── */
        .home-top {
            display:flex; justify-content:center;
            margin-bottom:24px; padding-top:8px;
        }
        .center-add-btn-standalone {
            width:56px; height:56px;
            background:var(--black); border:none;
            cursor:pointer; display:flex;
            align-items:center; justify-content:center;
            transition:all .2s;
            box-shadow: 0 2px 16px rgba(0,0,0,.18);
        }
        .center-add-btn-standalone:hover { background:var(--gray-800); transform:scale(1.07); }
        .center-add-btn-standalone svg { width:22px; height:22px; }

        /* ── SECTION TITLE ── */
        .section-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; color:var(--gray-500); }

        /* ── HABIT CARDS (list) ── */
        .habit-card {
            border:1px solid var(--gray-200); padding:14px 16px;
            margin-bottom:10px; transition:.2s; cursor:pointer;
        }
        .habit-card:hover { border-color:var(--black); }
        .habit-header { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
        .habit-info { flex:1; }
        .habit-title { font-size:14px; font-weight:600; color:var(--black); margin-bottom:6px; }
        .habit-meta { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
        .habit-category { display:inline-block; padding:2px 7px; font-size:9px; background:var(--gray-100); color:var(--gray-600); font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
        .habit-streak { display:flex; align-items:center; gap:4px; font-size:12px; font-weight:700; color:var(--gray-600); }
        .habit-time-range { font-size:10px; color:var(--gray-400); font-family:var(--din); }

        /* habit progress bar (replaces check button) */
        .habit-progress-section { flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
        .habit-progress-bar-wrap { width:80px; }
        .habit-prog-label { display:flex; justify-content:space-between; font-size:9px; color:var(--gray-400); font-weight:600; letter-spacing:.5px; margin-bottom:4px; }
        .habit-prog-track { height:5px; background:var(--gray-100); border-radius:0; overflow:hidden; }
        .habit-prog-fill { height:100%; background:var(--black); transition:width .4s cubic-bezier(.4,0,.2,1); border-radius:0; }
        .habit-prog-fill.done { background:var(--black); }
        .habit-mark-btn { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; border:1px solid var(--gray-200); background:var(--white); color:var(--gray-600); padding:5px 10px; cursor:pointer; transition:.2s; font-family:var(--font); white-space:nowrap; }
        .habit-mark-btn:hover { border-color:var(--black); color:var(--black); }
        .habit-mark-btn.marked { background:var(--black); color:var(--white); border-color:var(--black); }

        /* ── HABIT DETAIL VIEW ── */
        .detail-back { display:flex; align-items:center; gap:8px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:1px; cursor:pointer; margin-bottom:20px; color:var(--gray-600); padding:0; border:none; background:none; }
        .detail-back svg { width:16px; height:16px; }
        .detail-back:hover { color:var(--black); }
        .detail-title { font-size:22px; font-weight:700; margin-bottom:4px; }
        .detail-category { font-size:10px; color:var(--gray-400); text-transform:uppercase; letter-spacing:1px; margin-bottom:24px; }
        .detail-stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:1px; background:var(--gray-200); border:1px solid var(--gray-200); margin-bottom:24px; }
        .detail-stat-card { background:var(--white); padding:18px; text-align:center; }
        .detail-stat-value { font-size:28px; font-weight:700; color:var(--black); font-family:var(--din); }
        .detail-stat-label { font-size:10px; color:var(--gray-400); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:4px; }

        /* ── MODAL ── */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:flex-end; justify-content:center; padding:0; z-index:1000; }
        .modal-content { background:var(--white); padding:28px; max-width:480px; width:100%; max-height:85vh; overflow-y:auto; border-top:3px solid var(--black); }
        .modal-header { font-size:16px; font-weight:700; margin-bottom:24px; text-transform:uppercase; letter-spacing:.5px; font-family:var(--din); }
        .button-group { display:flex; gap:10px; margin-top:20px; }
        .button-group .button { flex:1; }

        /* time range row */
        .time-range-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
        .time-range-row .form-input { padding:10px 8px; font-size:12px; }

        /* ── GROUPS ── */
        .group-card {
            background:var(--white); border:1px solid var(--gray-200);
            padding:16px; margin-bottom:12px; cursor:pointer; transition:.2s;
        }
        .group-card:hover { border-color:var(--black); }
        .group-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
        .group-name { font-size:15px; font-weight:700; }
        .group-category-tag { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding:3px 8px; background:var(--gray-100); color:var(--gray-600); }
        .group-info { font-size:11px; color:var(--gray-500); display:flex; gap:12px; margin-bottom:12px; }
        .group-progress { margin-bottom:12px; }
        .progress-label { display:flex; justify-content:space-between; margin-bottom:5px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--gray-500); }
        .progress-bar { height:3px; background:var(--gray-100); }
        .progress-fill { height:100%; background:var(--black); transition:width .3s; }
        .group-bottom { display:flex; justify-content:space-between; align-items:center; }
        .group-members { display:flex; gap:4px; }
        .member-avatar-sm { width:26px; height:26px; background:var(--gray-100); border:1px solid var(--gray-200); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; }
        .join-btn { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; border:1px solid var(--black); background:var(--white); color:var(--black); padding:6px 14px; cursor:pointer; transition:.2s; font-family:var(--font); }
        .join-btn:hover { background:var(--black); color:var(--white); }
        .join-btn.joined { background:var(--black); color:var(--white); }

        /* ── GROUP DETAIL (member list) ── */
        .group-detail-header { margin-bottom:20px; }
        .group-detail-title { font-size:20px; font-weight:700; margin-bottom:6px; }
        .group-detail-meta { font-size:12px; color:var(--gray-500); display:flex; gap:12px; margin-bottom:16px; }
        .group-detail-progress { margin-bottom:8px; }
        .member-list-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--gray-400); margin:20px 0 12px; }
        .member-row {
            display:flex; align-items:center; gap:14px;
            padding:14px 0; border-bottom:1px solid var(--gray-100);
            cursor:pointer; transition:.1s;
        }
        .member-row:hover { background:var(--gray-50); margin:0 -20px; padding:14px 20px; }
        .member-avatar-lg { width:44px; height:44px; flex-shrink:0; background:var(--gray-100); border:1px solid var(--gray-200); display:flex; align-items:center; justify-content:center; font-size:17px; font-weight:700; }
        .member-info { flex:1; min-width:0; }
        .member-name { font-size:14px; font-weight:600; margin-bottom:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .member-sub { font-size:11px; color:var(--gray-400); margin-bottom:6px; }
        .member-prog-wrap { display:flex; align-items:center; gap:8px; }
        .member-prog-track { flex:1; height:4px; background:var(--gray-100); }
        .member-prog-fill { height:100%; background:var(--black); transition:width .4s; }
        .member-prog-pct { font-size:10px; font-weight:700; color:var(--gray-500); font-family:var(--din); flex-shrink:0; width:30px; text-align:right; }
        .member-arrow { color:var(--gray-300); flex-shrink:0; }

        /* ── MEMBER PROFILE VIEW ── */
        .member-profile-header { padding:28px 0 20px; text-align:center; border-bottom:1px solid var(--gray-100); margin-bottom:20px; }
        .member-profile-avatar { width:72px; height:72px; background:var(--gray-100); border:2px solid var(--black); margin:0 auto 14px; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; }
        .member-profile-name { font-size:20px; font-weight:700; margin-bottom:4px; }
        .member-profile-handle { font-size:12px; color:var(--gray-400); margin-bottom:14px; }
        .member-profile-actions { display:flex; gap:10px; justify-content:center; margin-bottom:16px; }
        .follow-btn { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; border:1px solid var(--black); background:var(--black); color:var(--white); padding:8px 20px; cursor:pointer; transition:.2s; font-family:var(--font); }
        .follow-btn.following { background:var(--white); color:var(--black); }
        .follow-btn:hover { opacity:.8; }
        .msg-btn { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; border:1px solid var(--gray-200); background:var(--white); color:var(--black); padding:8px 20px; cursor:pointer; transition:.2s; font-family:var(--font); }
        .msg-btn:hover { border-color:var(--black); }
        .profile-stat-row { display:flex; justify-content:center; gap:0; border:1px solid var(--gray-200); }
        .profile-stat-cell { flex:1; text-align:center; padding:14px 8px; border-right:1px solid var(--gray-100); }
        .profile-stat-cell:last-child { border-right:none; }
        .profile-stat-num { font-size:20px; font-weight:700; font-family:var(--din); }
        .profile-stat-lbl { font-size:9px; color:var(--gray-400); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:3px; }
        .privacy-notice { background:var(--gray-50); border:1px solid var(--gray-200); padding:12px 16px; font-size:12px; color:var(--gray-500); text-align:center; margin-bottom:20px; }
        .posts-grid { display:flex; flex-direction:column; gap:0; }

        /* ── FEED / POSTS ── */
        .feed-card { background:var(--white); border:1px solid var(--gray-200); margin-bottom:14px; }
        .feed-header { padding:12px 14px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--gray-50); }
        .feed-avatar { width:34px; height:34px; background:var(--gray-100); border:1px solid var(--gray-200); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; flex-shrink:0; }
        .feed-user-info h4 { font-size:13px; font-weight:700; margin-bottom:1px; }
        .feed-time { font-size:10px; color:var(--gray-400); text-transform:uppercase; letter-spacing:.5px; }
        .feed-content { padding:14px; }
        .feed-text { font-size:13px; line-height:1.6; margin-bottom:10px; color:var(--gray-800); }
        .feed-habit-tag { display:inline-block; padding:3px 9px; background:var(--gray-100); font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--gray-600); }
        .feed-media { margin-top:12px; border:1px solid var(--gray-100); overflow:hidden; }
        .feed-media img { width:100%; height:180px; object-fit:cover; display:block; }
        .feed-media-placeholder { width:100%; height:160px; background:var(--gray-100); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:8px; color:var(--gray-400); font-size:12px; }
        .feed-actions { padding:10px 14px; border-top:1px solid var(--gray-50); display:flex; gap:18px; }
        .feed-action { display:flex; align-items:center; gap:5px; font-size:11px; color:var(--gray-500); cursor:pointer; transition:color .15s; font-weight:600; }
        .feed-action:hover { color:var(--black); }
        .feed-action svg { width:15px; height:15px; }
        .feed-action.liked { color:var(--black); }

        /* ── PROFILE PAGE ── */
        .profile-header { padding:28px 0 20px; text-align:center; border-bottom:1px solid var(--gray-100); }
        .profile-avatar { width:72px; height:72px; background:var(--gray-100); border:2px solid var(--black); margin:0 auto 14px; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; }
        .profile-name { font-size:20px; font-weight:700; margin-bottom:4px; }
        .profile-email { font-size:12px; color:var(--gray-400); margin-bottom:16px; }
        .profile-stats { display:flex; border:1px solid var(--gray-200); margin-top:12px; }
        .profile-stat { flex:1; text-align:center; padding:14px 8px; border-right:1px solid var(--gray-100); }
        .profile-stat:last-child { border-right:none; }
        .profile-stat-value { font-size:20px; font-weight:700; font-family:var(--din); }
        .profile-stat-label { font-size:9px; color:var(--gray-400); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-top:3px; }
        .profile-privacy-section { margin-top:20px; padding-top:16px; border-top:1px solid var(--gray-100); }
        .privacy-toggle-row { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--gray-50); }
        .privacy-toggle-label { font-size:13px; font-weight:600; }
        .privacy-toggle-sub { font-size:11px; color:var(--gray-400); margin-top:2px; }
        .toggle-switch { position:relative; width:44px; height:24px; cursor:pointer; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; inset:0; background:var(--gray-200); transition:.3s; }
        .toggle-slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.3s; }
        .toggle-switch input:checked + .toggle-slider { background:var(--black); }
        .toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); }

        /* ── POST COMPOSER ── */
        .composer-wrap { margin-top:20px; border:1px solid var(--gray-200); }
        .composer-textarea {
            width:100%; padding:14px 16px; font-size:14px; font-family:var(--font);
            border:none; outline:none; resize:none; min-height:100px;
            color:var(--black); background:var(--white); line-height:1.6;
        }
        .composer-textarea::placeholder { color:var(--gray-300); }
        .composer-media-preview {
            position:relative; margin:0 16px 12px;
            border:1px solid var(--gray-100); overflow:hidden;
            height:200px; background:#000; flex-shrink:0;
        }
        .composer-media-preview img,
        .composer-media-preview video {
            width:100%; height:100%; object-fit:cover; display:block;
        }
        .composer-media-remove {
            position:absolute; top:6px; right:6px;
            width:24px; height:24px; background:rgba(0,0,0,.6); color:white;
            border:none; cursor:pointer; font-size:14px; display:flex;
            align-items:center; justify-content:center; font-weight:700;
        }
        .composer-toolbar {
            display:flex; align-items:center; justify-content:space-between;
            padding:10px 14px; border-top:1px solid var(--gray-100);
            background:var(--gray-50);
        }
        .composer-media-btns { display:flex; gap:8px; }
        .composer-media-btn {
            display:flex; align-items:center; gap:5px;
            font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px;
            border:1px solid var(--gray-200); background:var(--white);
            color:var(--gray-600); padding:6px 11px; cursor:pointer;
            transition:.15s; font-family:var(--font);
        }
        .composer-media-btn:hover { border-color:var(--black); color:var(--black); }
        .composer-media-btn svg { width:13px; height:13px; }
        .composer-submit {
            font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px;
            border:none; background:var(--black); color:var(--white);
            padding:8px 18px; cursor:pointer; transition:.15s; font-family:var(--font);
        }
        .composer-submit:hover { background:var(--gray-800); }
        .composer-submit:disabled { background:var(--gray-300); cursor:not-allowed; }
        .composer-char { font-size:10px; color:var(--gray-400); font-family:var(--mono); }
        /* my posts list */
        .my-posts-section { margin-top:24px; }
        .my-post-item { border:1px solid var(--gray-200); margin-bottom:10px; }
        .my-post-header { padding:10px 14px 0; display:flex; justify-content:space-between; align-items:center; }
        .my-post-time { font-size:10px; color:var(--gray-400); text-transform:uppercase; letter-spacing:.5px; }
        .my-post-delete { border:none; background:none; font-size:10px; color:var(--gray-400); cursor:pointer; font-family:var(--font); font-weight:700; text-transform:uppercase; letter-spacing:.5px; padding:0; transition:.15s; }
        .my-post-delete:hover { color:#c00; }
        .my-post-body { padding:10px 14px 12px; font-size:13px; line-height:1.6; color:var(--gray-800); }
        .my-post-media { border-top:1px solid var(--gray-100); }
        .my-post-media img, .my-post-media video { width:100%; max-height:180px; object-fit:cover; display:block; }
        .my-post-actions { padding:8px 14px; border-top:1px solid var(--gray-50); display:flex; gap:16px; }

        /* ── EMPTY STATE ── */
        .empty-state { text-align:center; padding:50px 20px; color:var(--gray-400); }
        .empty-state svg { width:40px; height:40px; margin:0 auto 14px; opacity:.25; }
        .empty-state h3 { font-size:15px; font-weight:700; margin-bottom:6px; color:var(--black); }
        .empty-state p { font-size:12px; line-height:1.5; }

        /* ── LOADING ── */
        .loading { text-align:center; padding:60px 20px; font-size:13px; color:var(--gray-400); font-family:var(--din); }

        /* ── BACK NAV ── */
        .back-nav { display:flex; align-items:center; gap:8px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; cursor:pointer; margin-bottom:20px; color:var(--gray-500); border:none; background:none; padding:0; font-family:var(--font); }
        .back-nav:hover { color:var(--black); }
        .back-nav svg { width:14px; height:14px; }

        /* ── CHIP TAG ── */
        .chip { display:inline-block; padding:3px 9px; background:var(--gray-100); font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--gray-600); margin-right:6px; margin-bottom:4px; }

        /* ── FREQ / DURATION PILLS ── */
        .pill-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .pill {
            padding:6px 13px; border:1px solid var(--gray-200);
            font-size:11px; font-weight:700; cursor:pointer;
            font-family:var(--font); background:var(--white);
            color:var(--gray-600); transition:.15s;
            text-transform:uppercase; letter-spacing:.5px;
            border-radius:0; white-space:nowrap;
        }
        .pill:hover { border-color:var(--black); color:var(--black); }
        .pill.selected { background:var(--black); color:var(--white); border-color:var(--black); }
        .pill-custom-wrap { display:flex; align-items:center; gap:6px; margin-top:8px; }
        .pill-custom-input {
            width:60px; padding:6px 8px; border:1px solid var(--gray-200);
            font-size:12px; font-family:var(--mono); background:var(--white);
            color:var(--black); border-radius:0; outline:none; text-align:center;
        }
        .pill-custom-input:focus { border-color:var(--black); }
        .pill-unit-select {
            padding:6px 8px; border:1px solid var(--gray-200);
            font-size:11px; font-family:var(--font); background:var(--white);
            color:var(--black); border-radius:0; outline:none; cursor:pointer;
            font-weight:600;
        }
        .pill-unit-select:focus { border-color:var(--black); }
        .section-divider { height:1px; background:var(--gray-100); margin:16px 0; }
        .modal-section-label {
            font-size:10px; font-weight:700; text-transform:uppercase;
            letter-spacing:1.2px; color:var(--gray-400); margin-bottom:10px;
        }

        /* date-row: simplified */
        .date-row { display:flex; gap:6px; align-items:center; }
        .date-row .form-input { padding:9px 6px; font-size:12px; flex:1; }
        .date-sep { font-size:12px; color:var(--gray-400); font-weight:700; flex-shrink:0; }

        /* progress count badge on card */
        .prog-count { font-size:10px; color:var(--gray-400); font-family:var(--mono); margin-bottom:3px; text-align:right; }

        /* today counter buttons */
        .counter-wrap { display:flex; align-items:center; gap:0; margin-top:8px; border:1px solid var(--gray-200); width:fit-content; }
        .counter-btn { width:30px; height:30px; border:none; background:var(--white); font-size:16px; cursor:pointer; color:var(--gray-600); display:flex; align-items:center; justify-content:center; transition:.15s; font-family:var(--font); font-weight:700; }
        .counter-btn:hover { background:var(--black); color:var(--white); }
        .counter-val { min-width:30px; text-align:center; font-size:13px; font-weight:700; font-family:var(--mono); border-left:1px solid var(--gray-200); border-right:1px solid var(--gray-200); padding:0 4px; line-height:30px; }

        /* delete row at bottom of card */
        .card-delete-row {
            margin-top:12px;
            padding-top:10px;
            border-top:1px solid var(--gray-100);
            display:flex;
            justify-content:flex-end;
        }
        .card-delete-btn {
            border:none; background:none; cursor:pointer;
            font-size:10px; font-weight:700; text-transform:uppercase;
            letter-spacing:.8px; color:var(--gray-400);
            font-family:var(--font); padding:4px 0;
            display:flex; align-items:center; gap:5px;
            transition:.15s;
        }
        .card-delete-btn:hover { color:#c00; }
        .card-delete-btn svg { width:11px; height:11px; }


        /* ── DELETE ACCOUNT MODAL ── */
        .delete-account-btn {
            width:100%; padding:12px; background:none; border:1px solid #fca5a5;
            color:#dc2626; font-size:11px; font-weight:700; text-transform:uppercase;
            letter-spacing:1px; cursor:pointer; font-family:var(--font); margin-top:8px;
            transition:.2s;
        }
        .delete-account-btn:hover { background:#fef2f2; border-color:#dc2626; }
        .danger-modal { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; z-index:3000; padding:20px; }
        .danger-modal-box { background:var(--white); padding:28px; max-width:360px; width:100%; border-top:4px solid #dc2626; }
        .danger-modal-title { font-size:16px; font-weight:700; color:#dc2626; margin-bottom:8px; font-family:var(--din); text-transform:uppercase; letter-spacing:.5px; }
        .danger-modal-body { font-size:12px; color:var(--gray-600); line-height:1.7; margin-bottom:20px; }
        .danger-modal-body strong { color:var(--black); }
        .danger-confirm-input { width:100%; padding:10px 12px; border:1px solid var(--gray-200); font-size:13px; font-family:var(--font); outline:none; margin-bottom:14px; }
        .danger-confirm-input:focus { border-color:#dc2626; }
        .danger-confirm-btn { width:100%; padding:12px; background:#dc2626; color:white; border:none; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; cursor:pointer; font-family:var(--font); margin-bottom:8px; }
        .danger-confirm-btn:disabled { background:#fca5a5; cursor:not-allowed; }
        .danger-cancel-btn { width:100%; padding:10px; background:none; border:1px solid var(--gray-200); font-size:11px; font-weight:600; cursor:pointer; font-family:var(--font); color:var(--gray-600); }
        .danger-step { font-size:10px; color:var(--gray-400); text-align:center; margin-bottom:12px; text-transform:uppercase; letter-spacing:.8px; }
        .danger-deleting { text-align:center; padding:20px 0; }
        .danger-deleting p { font-size:12px; color:var(--gray-500); margin-top:8px; }
        /* scrollbar */
        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:var(--gray-200); }
    </style>
</head>
<body>
<div id="root"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- React -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ── Firebase config ── */
const firebaseConfig = {
    apiKey: "AIzaSyDxa2PZEep3eXY1Iiu4IhjXCwXd6z0HelA",
    authDomain: "health-habit-tracker-e6b50.firebaseapp.com",
    projectId: "health-habit-tracker-e6b50",
    storageBucket: "health-habit-tracker-e6b50.firebasestorage.app",
    messagingSenderId: "890093173627",
    appId: "1:890093173627:web:54032fce30ae7ef3f41bde"
};
let app, auth, db;
const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";
if (isFirebaseConfigured) {
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
}

/* ── ICONS ── */
const HomeIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>);
const GroupIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>);
const FeedIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>);
const ProfileIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>);
const PlusIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="white" strokeWidth={2.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>);
const HeartIcon = ({filled}) => (<svg fill={filled?"currentColor":"none"} viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>);
const ChatIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>);
const FlameIcon = () => (<svg width="13" height="13" fill="currentColor" viewBox="0 0 24 24"><path d="M12 23a7.5 7.5 0 0 1-5.138-12.963C8.204 8.774 11.5 6.5 11 1.5c6 4 9 8 3 14 1 0 2.5 0 5-2.47.27.773.5 1.604.5 2.47A7.5 7.5 0 0 1 12 23z"/></svg>);
const BackIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>);
const ChevronRightIcon = () => (<svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>);
const ImageIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>);
const VideoIcon = () => (<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 10l4.553-2.069A1 1 0 0121 8.868v6.264a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>);
const LockIcon = () => (<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>);
const ShareIcon = () => (<svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>);

/* ══════════════════════════════════════════════════
   ★ CLOUDINARY Settings — Please fill in your own info ★
   Steps:
   1. Go to https://cloudinary.com and register for free
   2. Enter Settings → Upload → Add upload preset
      • Set Signing mode to "Unsigned"
      • Note Preset name
   3. Go back to Dashboard and note your Cloud name
   4. Fill in the two values below — completely free!
   ══════════════════════════════════════════════════ */
const CLOUDINARY_CLOUD_NAME = 'di21uvipg';
const CLOUDINARY_UPLOAD_PRESET = 'mxt3i95r';

const isCloudinaryConfigured =
    CLOUDINARY_CLOUD_NAME !== 'YOUR_CLOUD_NAME' &&
    CLOUDINARY_UPLOAD_PRESET !== 'YOUR_UPLOAD_PRESET';

/* ══════════════════════════════════════════════════
   ★ Upload Quota Settings — 調整這裡的限制數值 ★
   ══════════════════════════════════════════════════ */
const UPLOAD_LIMITS = {
    IMAGE_MAX_MB: 2,          // 單張圖片上傳上限 (MB)
    VIDEO_MAX_MB: 20,         // 單個影片上傳上限 (MB)
    DAILY_IMAGE_COUNT: 5,     // 每日最多上傳圖片數
    DAILY_VIDEO_COUNT: 2,     // 每日最多上傳影片數
    MONTHLY_TOTAL_MB: 500,    // 每月總流量上限 (MB)，Cloudinary 免費版約 25GB，保守設定
    IMAGE_COMPRESS_MAX_PX: 1280, // 圖片壓縮後最大邊長 (px)
    IMAGE_COMPRESS_QUALITY: 0.80, // 圖片壓縮品質 (0-1)
};

/* ── 圖片壓縮 ── */
async function compressImage(file) {
    return new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            const maxPx = UPLOAD_LIMITS.IMAGE_COMPRESS_MAX_PX;
            let { width, height } = img;
            if (width > maxPx || height > maxPx) {
                if (width > height) { height = Math.round(height * maxPx / width); width = maxPx; }
                else { width = Math.round(width * maxPx / height); height = maxPx; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => {
                // 若壓縮後比原始大，保留原始
                if (blob.size >= file.size) { resolve(file); return; }
                resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', UPLOAD_LIMITS.IMAGE_COMPRESS_QUALITY);
        };
        img.onerror = () => { URL.revokeObjectURL(url); resolve(file); };
        img.src = url;
    });
}

function getTodayKey() { return toISODay(); } // uses local date, not UTC
function getMonthKey() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; } // local month

/* ── 取得目前 user uid ── */
function getCurrentUid() {
    try { return auth?.currentUser?.uid || null; }
    catch(e) { return null; }
}

/* ── 從 Firestore 讀取配額文件 ── */
async function fetchQuotaDoc(uid) {
    if (!uid || !db) return null;
    try {
        const snap = await db.collection('upload_quotas').doc(uid).get();
        return snap.exists ? snap.data() : null;
    } catch(e) {
        console.warn('[Quota] 讀取失敗:', e);
        return null;
    }
}

/* ── 檢查配額（上傳前，從 Firestore 讀） ── */
async function checkQuotaFS(uid, file, isVideo) {
    const fileMB = file.size / 1024 / 1024;
    const maxMB = isVideo ? UPLOAD_LIMITS.VIDEO_MAX_MB : UPLOAD_LIMITS.IMAGE_MAX_MB;

    // 先檢查單檔大小（不需讀 DB）
    if (fileMB > maxMB)
        throw new Error(`檔案太大！${isVideo ? '影片' : '圖片'}上限 ${maxMB} MB，此檔案約 ${fileMB.toFixed(1)} MB`);

    const q = await fetchQuotaDoc(uid);
    const today = getTodayKey(), month = getMonthKey();

    // 每日計數（若日期不同代表新的一天，計數歸零）
    const dailyImages = (q?.dailyDate === today ? q.dailyImages : 0) || 0;
    const dailyVideos = (q?.dailyDate === today ? q.dailyVideos : 0) || 0;

    // 每月流量（若月份不同代表新月份，歸零）
    const monthlyMB = (q?.monthlyMonth === month ? q.monthlyMB : 0) || 0;

    if (!isVideo && dailyImages >= UPLOAD_LIMITS.DAILY_IMAGE_COUNT)
        throw new Error(`今日圖片上傳已達上限 ${UPLOAD_LIMITS.DAILY_IMAGE_COUNT} 張，明天再試！`);

    if (isVideo && dailyVideos >= UPLOAD_LIMITS.DAILY_VIDEO_COUNT)
        throw new Error(`今日影片上傳已達上限 ${UPLOAD_LIMITS.DAILY_VIDEO_COUNT} 支，明天再試！`);

    if (monthlyMB + fileMB > UPLOAD_LIMITS.MONTHLY_TOTAL_MB)
        throw new Error(`本月上傳流量已達上限 ${UPLOAD_LIMITS.MONTHLY_TOTAL_MB} MB，下月重置！`);

    return { dailyImages, dailyVideos, monthlyMB };
}

/* ── 上傳成功後寫回 Firestore（用 merge 避免覆蓋） ── */
async function recordUploadFS(uid, fileMB, isVideo, userName, userEmail) {
    if (!uid || !db) return;
    const today = getTodayKey(), month = getMonthKey();
    try {
        // 先讀現有資料（確保跨裝置累加正確）
        const q = await fetchQuotaDoc(uid);
        const dailyImages = (q?.dailyDate === today ? q.dailyImages : 0) || 0;
        const dailyVideos = (q?.dailyDate === today ? q.dailyVideos : 0) || 0;
        const monthlyMB   = (q?.monthlyMonth === month ? q.monthlyMB : 0) || 0;
        const totalImages = (q?.totalImages || 0);
        const totalVideos = (q?.totalVideos || 0);
        const totalMB     = (q?.totalMB || 0);

        const newDoc = {
            uid,
            displayName: userName || q?.displayName || '',
            email: userEmail || q?.email || '',
            // 每日
            dailyDate: today,
            dailyImages: isVideo ? dailyImages : dailyImages + 1,
            dailyVideos: isVideo ? dailyVideos + 1 : dailyVideos,
            // 每月
            monthlyMonth: month,
            monthlyMB: +( monthlyMB + fileMB ).toFixed(3),
            // 累計總量
            totalImages: isVideo ? totalImages : totalImages + 1,
            totalVideos: isVideo ? totalVideos + 1 : totalVideos,
            totalMB: +( totalMB + fileMB ).toFixed(3),
            lastUploadAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        await db.collection('upload_quotas').doc(uid).set(newDoc, { merge: true });
        console.log(`[Quota] ✅ 已寫入 Firestore | 今日圖:${newDoc.dailyImages}/${UPLOAD_LIMITS.DAILY_IMAGE_COUNT} 影:${newDoc.dailyVideos}/${UPLOAD_LIMITS.DAILY_VIDEO_COUNT} | 本月:${newDoc.monthlyMB}MB`);
    } catch(e) {
        console.warn('[Quota] 寫入失敗:', e);
    }
}

/* ── 主上傳函數（含限制 + 壓縮 + Firestore quota） ── */
async function uploadToCloudinary(file, resourceType = 'auto', onProgress) {
    if (!isCloudinaryConfigured) {
        return { url: URL.createObjectURL(file), publicId: null, local: true };
    }

    const isVideo = file.type.startsWith('video/') || resourceType === 'video';
    const uid = getCurrentUid();
    const currentUser = auth?.currentUser;

    // ① 檢查配額（Firestore，跨裝置真實數字）
    await checkQuotaFS(uid, file, isVideo);

    // ② 壓縮圖片
    let uploadFile = file;
    if (!isVideo && file.type.startsWith('image/')) {
        uploadFile = await compressImage(file);
        console.log(`[Upload] 圖片壓縮: ${(file.size/1024/1024).toFixed(2)}MB → ${(uploadFile.size/1024/1024).toFixed(2)}MB`);
    }

    const finalMB = +(uploadFile.size / 1024 / 1024).toFixed(3);
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
    const formData = new FormData();
    formData.append('file', uploadFile);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

    return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url);
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable && onProgress) onProgress(Math.round(e.loaded / e.total * 100));
        };
        xhr.onload = async () => {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.secure_url) {
                    // ③ 上傳成功後寫配額到 Firestore
                    await recordUploadFS(
                        uid, finalMB, isVideo,
                        currentUser?.displayName || currentUser?.email || '',
                        currentUser?.email || ''
                    );
                    resolve({ url: data.secure_url, publicId: data.public_id });
                } else {
                    reject(new Error(data.error?.message || 'Upload failed'));
                }
            } catch(e) { reject(e); }
        };
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(formData);
    });
}

/* ── MOCK DATA ── */
const mockGroups = [
    { id:1, name:'30-Day Early Rise Challenge', members:24, active:18, progress:75, category:'Sleep', joined:false },
    { id:2, name:'Daily Workout Check-in', members:156, active:132, progress:85, category:'Fitness', joined:true },
    { id:3, name:'Skincare Routine Diary', members:89, active:67, progress:60, category:'Skincare', joined:false },
    { id:4, name:'Mindful Eating Plan', members:43, active:31, progress:55, category:'Nutrition', joined:false },
];

const mockGroupMembers = [
    { id:'m1', name:'Alex Chen', handle:'@alexc', avatar:'A', progress:92, streak:14, habits:8, followers:34, following:21, isPublic:true, isFollowing:false, posts:[
        { id:'p1', text:'Day 14 of waking up early! My morning routine has completely transformed my mornings — I feel amazing.', time:'2 hr ago', habit:'Early Rising', likes:24, comments:5, hasImage:true, liked:false },
        { id:'p2', text:'Morning meditation + cold shower = all-day energy. Try it for 7 days straight — you will thank yourself.', time:'Yesterday', habit:'Mindfulness', likes:18, comments:3, hasImage:false, liked:false },
    ]},
    { id:'m2', name:'Jordan Lee', handle:'@jordanl', avatar:'J', progress:78, streak:9, habits:5, followers:12, following:8, isPublic:false, isFollowing:true, followApproved:true, posts:[
        { id:'p3', text:'Day 9 waking up before sunrise. Still hard, but absolutely worth it.', time:'3 hr ago', habit:'Early Rising', likes:11, comments:2, hasImage:false, liked:false },
    ]},
    { id:'m3', name:'Sam Wang', handle:'@samr', avatar:'S', progress:65, streak:7, habits:6, followers:8, following:15, isPublic:false, isFollowing:false, followApproved:false, posts:[] },
    { id:'m4', name:'Morgan Wu', handle:'@morganw', avatar:'M', progress:88, streak:21, habits:9, followers:67, following:44, isPublic:true, isFollowing:false, posts:[
        { id:'p4', text:'21-day streak! Consistency is the key. Here is my morning routine:', time:'1 day ago', habit:'Early Rising', likes:45, comments:12, hasImage:true, liked:false },
        { id:'p5', text:'All my meals prepped for the week. Eating clean has never been this easy.', time:'2 days ago', habit:'Nutrition', likes:32, comments:7, hasImage:true, liked:false },
    ]},
    { id:'m5', name:'Riley Park', handle:'@rileyp', avatar:'R', progress:41, streak:3, habits:4, followers:5, following:9, isPublic:false, isFollowing:false, followApproved:false, posts:[] },
    { id:'m6', name:'Drew Kim', handle:'@drewk', avatar:'D', progress:95, streak:30, habits:12, followers:120, following:60, isPublic:true, isFollowing:true, followApproved:true, posts:[
        { id:'p6', text:'30 days — that is how you build a truly lasting habit. Here is what I learned this month.', time:'5 hr ago', habit:'All Habits', likes:89, comments:23, hasImage:false, liked:false },
    ]},
];

const mockFeedGlobal = [
    { id:'f1', user:'Drew Kim', avatar:'D', time:'5 hr ago', habit:'All Habits', text:'30 days — that is how you build a truly lasting habit. Here is what I learned this month.', likes:89, comments:23, hasImage:false, liked:false },
    { id:'f2', user:'Morgan Wu', avatar:'M', time:'1 day ago', habit:'Early Rising', text:'21-day streak! Consistency is the key. Here is my morning routine:', likes:45, comments:12, hasImage:true, liked:false },
    { id:'f3', user:'Alex Chen', avatar:'A', time:'2 hr ago', habit:'Early Rising', text:'Day 14 of waking up early! My morning routine has completely transformed my mornings — I feel amazing.', likes:24, comments:5, hasImage:true, liked:false },
    { id:'f4', user:'Morgan Wu', avatar:'M', time:'2 days ago', habit:'Nutrition', text:'All my meals prepped for the week. Eating clean has never been this easy.', likes:32, comments:7, hasImage:true, liked:false },
    { id:'f5', user:'Jordan Lee', avatar:'J', time:'3 hr ago', habit:'Early Rising', text:'Day 9 waking up before sunrise. Still hard, but absolutely worth it.', likes:11, comments:2, hasImage:false, liked:false },
];

/* ── AUTH PAGE ── */
function AuthPage({ onAuthSuccess }) {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [displayName, setDisplayName] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    // "Verification email sent" screen
    const [verificationSent, setVerificationSent] = useState(false);
    const [sentEmail, setSentEmail] = useState('');
    const [resendCooldown, setResendCooldown] = useState(0);

    const handleDemoLogin = () => {
        const u = { uid:'demo-user', email:'demo@example.com', displayName:'You' };
        localStorage.setItem('demoUser', JSON.stringify(u));
        onAuthSuccess(u);
    };

    /* Password strength validation */
    const validateForm = () => {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email.trim()) return 'Please enter your email address';
        if (!emailRegex.test(email.trim())) return 'Please enter a valid email address (e.g., user@example.com)';
        if (!password) return 'Please enter a password';
        if (password.length < 8) return 'Password must be at least 8 characters';
        if (!/[A-Z]/.test(password)) return 'Password must contain at least one uppercase letter (A-Z)';
        if (!/[a-z]/.test(password)) return 'Password must contain at least one lowercase letter (a-z)';
        if (!/[0-9]/.test(password)) return 'Password must contain at least one number (0-9)';
        if (!isLogin) {
            if (!displayName.trim()) return 'Please enter your name';
            if (displayName.trim().length < 2) return 'Name must be at least 2 characters';
        }
        return null;
    };

    /* Firebase error code → message */
    const firebaseErrMsg = (code) => ({
        'auth/email-already-in-use': 'This email is already registered. Please sign in instead. (If you previously deleted your account but this error persists, the account may still exist in Firebase — please contact the administrator.)',
        'auth/invalid-email':        'Invalid email format',
        'auth/weak-password':        'Password is too weak. Please use a stronger password',
        'auth/user-not-found':       'Account not found. Please check your email address',
        'auth/wrong-password':       'Incorrect password. Please try again',
        'auth/too-many-requests':    'Too many attempts. Please try again later',
        'auth/network-request-failed':'Network error. Please check your connection and try again',
        'auth/user-disabled':        'This account has been disabled. Please contact support',
    }[code] || null);

    /* Countdown timer (resend cooldown) */
    const startCooldown = () => {
        setResendCooldown(60);
        const t = setInterval(() => {
            setResendCooldown(prev => {
                if (prev <= 1) { clearInterval(t); return 0; }
                return prev - 1;
            });
        }, 1000);
    };

    /* Resend verification email */
    const handleResend = async () => {
        if (resendCooldown > 0) return;
        try {
            const r = await auth.signInWithEmailAndPassword(email, password);
            if (!r.user.emailVerified) {
                const actionCodeSettings = {
                    url: window.location.origin + window.location.pathname,
                    handleCodeInApp: false,
                };
                await r.user.sendEmailVerification(actionCodeSettings);
                startCooldown();
                setError('');
            }
            await auth.signOut();
        } catch(err) {
            setError(firebaseErrMsg(err.code) || err.message);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        const validErr = validateForm();
        if (validErr) { setError(validErr); return; }

        setLoading(true);
        if (!isFirebaseConfigured) { handleDemoLogin(); return; }

        try {
            if (isLogin) {
                /* ── Login flow ── */
                const r = await auth.signInWithEmailAndPassword(email, password);
                if (!r.user.emailVerified) {
                    // Email not verified — sign out and prompt
                    await auth.signOut();
                    setSentEmail(email);
                    setVerificationSent(true);
                    startCooldown();
                    return;
                }
                // ✅ 只有 email 驗證通過才寫入 Firestore，假 email 不會出現在後台
                await db.collection('users').doc(r.user.uid).set({
                    displayName: r.user.displayName || displayName || '',
                    email: r.user.email || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                onAuthSuccess(r.user);
            } else {
                /* ── Registration flow ── */
                const r = await auth.createUserWithEmailAndPassword(email, password);
                await r.user.updateProfile({ displayName });
                // ✅ 只寄驗證信，不寫入 Firestore（等登入且驗證通過後才寫）
                // actionCodeSettings 提升信件送達率，並設定驗證後回跳網址
                const actionCodeSettings = {
                    url: window.location.origin + window.location.pathname,
                    handleCodeInApp: false,
                };
                await r.user.sendEmailVerification(actionCodeSettings);
                await auth.signOut();
                setSentEmail(email);
                setVerificationSent(true);
                startCooldown();
            }
        } catch(err) {
            setError(firebaseErrMsg(err.code) || err.message);
        } finally {
            setLoading(false);
        }
    };

    /* ── Verification email sent screen ── */
    if (verificationSent) {
        return (
            <div className="auth-page">
                <div style={{
                    width:64, height:64, background:'var(--black)',
                    display:'flex', alignItems:'center', justifyContent:'center',
                    margin:'0 auto 20px', fontSize:28
                }}>✉️</div>
                <div className="auth-logo" style={{textAlign:'center', marginBottom:8}}>Verification Email Sent</div>
                <div style={{
                    fontSize:13, color:'var(--gray-500)', textAlign:'center',
                    marginBottom:16, lineHeight:1.7, maxWidth:320
                }}>
                    We've sent a verification email to<br/>
                    <strong style={{color:'var(--black)'}}>{sentEmail}</strong>
                </div>
                <div style={{
                    width:'100%', maxWidth:360, marginBottom:20,
                    padding:'14px 16px', background:'#FFF8E1',
                    border:'1px solid #FFD54F', borderRadius:0, fontSize:12,
                    color:'#5D4037', lineHeight:1.9, textAlign:'left'
                }}>
                    <strong style={{color:'#E65100', fontSize:13}}>⚠️ 請先去垃圾信匣找！</strong><br/>
                    驗證信很可能在 <strong>垃圾郵件 / Spam</strong> 資料夾。<br/>
                    找到後請點 <strong>「Report not spam」</strong> 再點擊驗證連結。
                </div>

                {error && <div className="error-message" style={{maxWidth:360, width:'100%', marginBottom:16}}>{error}</div>}

                <div style={{width:'100%', maxWidth:360}}>
                    {/* After verification, go to sign in */}
                    <button
                        className="button button-primary"
                        onClick={() => { setVerificationSent(false); setIsLogin(true); setPassword(''); }}
                    >
                        Verified — Sign In Now
                    </button>

                    {/* Resend verification email */}
                    <button
                        className="button button-secondary"
                        onClick={handleResend}
                        disabled={resendCooldown > 0}
                        style={{marginTop:0}}
                    >
                        {resendCooldown > 0 ? `Resend Email (${resendCooldown}s)` : 'Resend Verification Email'}
                    </button>

                    <div style={{
                        marginTop:16, padding:'12px 16px',
                        background:'var(--gray-50)', border:'1px solid var(--gray-200)',
                        fontSize:11, color:'var(--gray-500)', lineHeight:1.9
                    }}>
                        <strong style={{color:'var(--gray-700)'}}>沒有收到信？請依序檢查：</strong><br/>
                        ① <strong style={{color:'var(--gray-800)'}}>垃圾郵件 / Spam</strong> 資料夾（最常見）<br/>
                        ② Gmail 的 <strong style={{color:'var(--gray-800)'}}>促銷 Promotions</strong> 分頁<br/>
                        ③ Gmail 的 <strong style={{color:'var(--gray-800)'}}>更新 Updates</strong> 分頁<br/>
                        ④ 確認 email 地址是否正確<br/>
                        ⑤ 驗證連結 24 小時後過期，請盡快點擊
                    </div>
                </div>
            </div>
        );
    }

    /* ── Login / Sign Up screen ── */
    return (
        <div className="auth-page">
            <div className="auth-logo">Habit Tracker</div>
            <div className="auth-subtitle">PROFESSIONAL WELLNESS</div>
            {!isFirebaseConfigured && (
                <div className="demo-badge"><strong>Demo Mode:</strong>Firebase not configured. Click to use the local demo version.</div>
            )}
            {error && <div className="error-message">{error}</div>}
            <form className="auth-form" onSubmit={handleSubmit}>
                {!isLogin && (
                    <div className="form-group">
                        <label className="form-label">Name</label>
                        <input type="text" className="form-input" value={displayName}
                            onChange={e=>setDisplayName(e.target.value)} placeholder="Your name"/>
                    </div>
                )}
                <div className="form-group">
                    <label className="form-label">Email</label>
                    <input type="email" className="form-input" value={email}
                        onChange={e=>setEmail(e.target.value)} placeholder="your@email.com"/>
                </div>
                <div className="form-group">
                    <label className="form-label">Password</label>
                    <input type="password" className="form-input" value={password}
                        onChange={e=>setPassword(e.target.value)} placeholder="••••••••" minLength="8"/>
                    {!isLogin && (
                        <div style={{fontSize:11, color:'var(--gray-400)', marginTop:6, lineHeight:1.6}}>
                            Password must be at least 8 chars, with uppercase, lowercase, and a number
                        </div>
                    )}
                </div>
                <button type="submit" className="button button-primary" disabled={loading}>
                    {loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}
                </button>
            </form>
            <div className="auth-switch">
                {isLogin ? "Don't have an account?" : "Already have an account?"}
                <a onClick={()=>{ setIsLogin(!isLogin); setError(''); }}>
                    {isLogin ? 'Sign Up' : 'Sign In'}
                </a>
            </div>
        </div>
    );
}

/* ── FEED CARD COMPONENT (Firebase real likes + comments) ── */
function FeedCard({ post, currentUser, onLike }) {
    const [showComments, setShowComments] = useState(false);
    const [comments, setComments] = useState([]);
    const [commentText, setCommentText] = useState('');
    const [sendingComment, setSendingComment] = useState(false);
    const [loadingComments, setLoadingComments] = useState(false);

    // Load comments (only when expanded)
    useEffect(() => {
        if (!showComments || !isFirebaseConfigured || !post.id) return;
        setLoadingComments(true);
        const unsub = db.collection('posts').doc(post.id)
            .collection('comments')
            .orderBy('createdAt', 'asc')
            .onSnapshot(snap => {
                setComments(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                setLoadingComments(false);
            }, () => setLoadingComments(false));
        return () => unsub();
    }, [showComments, post.id]);

    const handleSendComment = async () => {
        if (!commentText.trim() || !currentUser) return;
        setSendingComment(true);
        try {
            if (isFirebaseConfigured) {
                await db.collection('posts').doc(post.id).collection('comments').add({
                    text: commentText.trim(),
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'User',
                    userAvatar: (currentUser.displayName || currentUser.email)?.[0]?.toUpperCase() || 'U',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
                // Update comment count
                await db.collection('posts').doc(post.id).update({
                    comments: firebase.firestore.FieldValue.increment(1)
                });
            } else {
                setComments(prev => [...prev, {
                    id: Date.now().toString(),
                    text: commentText.trim(),
                    userName: currentUser.displayName || 'User',
                    userAvatar: (currentUser.displayName || currentUser.email)?.[0]?.toUpperCase() || 'U',
                    createdAt: null,
                }]);
            }
            setCommentText('');
        } catch(e) {
            if (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))) {
                alert('留言失敗：Firestore 安全規則尚未設定留言寫入權限。\n請到 Firebase Console → Firestore → Rules，加入 comments subcollection 的寫入規則。\n\n詳細規則範本請見 README 或聯絡管理員。');
            } else {
                alert('Comment failed: ' + e.message);
            }
        }
        finally { setSendingComment(false); }
    };

    const likeCount = post.likes + (post.liked ? 0 : 0); // likes already updated by parent

    return (
        <div className="feed-card">
            <div className="feed-header">
                <div className="feed-avatar">{post.avatarUrl
                    ? <img src={post.avatarUrl} style={{width:'100%',height:'100%',objectFit:'cover'}} alt=""/>
                    : post.avatar}
                </div>
                <div className="feed-user-info">
                    <h4>{post.user}</h4>
                    <div className="feed-time">{post.time}</div>
                </div>
            </div>
            <div className="feed-content">
                {post.text && <div className="feed-text">{post.text}</div>}
                {post.habit && <span className="feed-habit-tag">{post.habit}</span>}
                {post.hasImage && post.mediaUrl && (
                    <div className="feed-media">
                        <img src={post.mediaUrl} alt="post" style={{width:'100%',maxHeight:280,objectFit:'cover',display:'block'}}/>
                    </div>
                )}
                {post.hasImage && !post.mediaUrl && (
                    <div className="feed-media">
                        <div className="feed-media-placeholder"><ImageIcon/><span>Photo</span></div>
                    </div>
                )}
                {post.hasVideo && post.mediaUrl && (
                    <div className="feed-media">
                        <video src={post.mediaUrl} controls playsInline preload="metadata" style={{width:'100%',height:260,objectFit:'contain',display:'block',background:'#000'}}/>
                    </div>
                )}
            </div>
            <div className="feed-actions">
                <div className={`feed-action${post.liked?' liked':''}`} onClick={()=>onLike && onLike(post.id)}>
                    <HeartIcon filled={post.liked}/><span>{post.likes}</span>
                </div>
                <div className="feed-action" onClick={()=>setShowComments(s=>!s)}>
                    <ChatIcon/><span>{post.comments}</span>
                </div>
                <div className="feed-action"><ShareIcon/><span>Share</span></div>
            </div>
            {showComments && (
                <div className="comments-section">
                    {loadingComments && <div style={{fontSize:11,color:'var(--gray-400)',padding:'4px 0'}}>Loading comments...</div>}
                    {comments.map(c => (
                        <div key={c.id} className="comment-item">
                            <div className="comment-avatar">{c.userAvatar}</div>
                            <div className="comment-body">
                                <div className="comment-user">{c.userName}</div>
                                <div className="comment-text">{c.text}</div>
                                <div className="comment-time">{c.createdAt?.toDate ? c.createdAt.toDate().toLocaleString(undefined,{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Just now'}</div>
                            </div>
                        </div>
                    ))}
                    {comments.length === 0 && !loadingComments && (
                        <div style={{fontSize:11,color:'var(--gray-400)',padding:'4px 0 8px'}}>No comments yet. Be the first!</div>
                    )}
                    {currentUser && (
                        <div className="comment-input-row">
                            <input
                                className="comment-input"
                                placeholder="Add a comment..."
                                value={commentText}
                                onChange={e=>setCommentText(e.target.value)}
                                onKeyDown={e=>e.key==='Enter'&&!e.shiftKey&&handleSendComment()}
                                maxLength={200}
                            />
                            <button className="comment-send" onClick={handleSendComment} disabled={!commentText.trim()||sendingComment}>
                                {sendingComment ? '…' : 'Send'}
                            </button>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

/* ── MEMBER PROFILE VIEW ── */
function MemberProfileView({ member: initialMember, currentUser, onBack }) {
    const [member, setMember] = useState(initialMember);
    const [posts, setPosts] = useState(initialMember.posts || []);

    const canSeePosts = member.isPublic || (member.isFollowing && member.followApproved);

    const handleFollow = () => {
        setMember(prev => ({
            ...prev,
            isFollowing: !prev.isFollowing,
            followApproved: prev.isPublic ? !prev.isFollowing : (prev.isFollowing ? false : false)
        }));
    };

    const handleLike = (postId) => {
        setPosts(prev => prev.map(p => p.id === postId ? {...p, liked: !p.liked} : p));
    };

    const completionPct = member.progress;

    return (
        <div>
            <button className="back-nav" onClick={onBack}><BackIcon/>Back to Members</button>
            <div className="member-profile-header">
                <div className="member-profile-avatar">{member.avatar}</div>
                <div className="member-profile-name">{member.name}</div>
                <div className="member-profile-handle">{member.handle}</div>
                <div className="member-profile-actions">
                    <button className={`follow-btn${member.isFollowing?' following':''}`} onClick={handleFollow}>
                        {member.isFollowing ? '✓ Following' : 'Follow'}
                    </button>
                    <button className="msg-btn">Message</button>
                </div>
                <div className="profile-stat-row">
                    <div className="profile-stat-cell">
                        <div className="profile-stat-num">{member.habits}</div>
                        <div className="profile-stat-lbl">Habit</div>
                    </div>
                    <div className="profile-stat-cell">
                        <div className="profile-stat-num">{member.streak}</div>
                        <div className="profile-stat-lbl">Day Streak</div>
                    </div>
                    <div className="profile-stat-cell">
                        <div className="profile-stat-num">{member.followers}</div>
                        <div className="profile-stat-lbl">Followers</div>
                    </div>
                    <div className="profile-stat-cell">
                        <div className="profile-stat-num">{member.following}</div>
                        <div className="profile-stat-lbl">Follow</div>
                    </div>
                </div>
            </div>

            {/* Group activity progress */}
            <div className="section-title">Activity Completion</div>
            <div style={{marginBottom:24}}>
                <div style={{display:'flex',justifyContent:'space-between',fontSize:11,fontWeight:700,textTransform:'uppercase',letterSpacing:.5,color:'var(--gray-500)',marginBottom:6}}>
                    <span>Completion Rate</span><span style={{fontFamily:'var(--din)'}}>{completionPct}%</span>
                </div>
                <div style={{height:8,background:'var(--gray-100)',borderRadius:0}}>
                    <div style={{height:'100%',background:'var(--black)',width:`${completionPct}%`,transition:'width .5s'}}></div>
                </div>
            </div>

            {/* Posts */}
            <div className="section-title">Post</div>
            {!canSeePosts ? (
                <div className="privacy-notice">
                    <LockIcon/>
                    {member.isFollowing && !member.followApproved
                        ? <span style={{display:'block',marginTop:6}}>Follow request pending · Posts visible once approved</span>
                        : <span style={{display:'block',marginTop:6}}>This account is private · Follow to view posts once approved</span>
                    }
                </div>
            ) : (
                posts.length === 0 ? (
                    <div className="empty-state">
                        <ImageIcon/>
                        <h3>No posts yet</h3>
                        <p>This user has not shared any content yet</p>
                    </div>
                ) : (
                    <div className="posts-grid">
                        {posts.map(p => (
                            <FeedCard key={p.id} post={{...p, user:member.name, avatar:member.avatar}} currentUser={currentUser} onLike={handleLike}/>
                        ))}
                    </div>
                )
            )}
        </div>
    );
}

/* ── GROUP DETAIL VIEW ── */
function GroupDetailView({ group, currentUser, onBack }) {
    const [members, setMembers] = useState(mockGroupMembers);
    const [selectedMember, setSelectedMember] = useState(null);
    const [joined, setJoined] = useState(group.joined);

    if (selectedMember) {
        return (
            <MemberProfileView
                member={selectedMember}
                currentUser={currentUser}
                onBack={()=>setSelectedMember(null)}
            />
        );
    }

    return (
        <div>
            <button className="back-nav" onClick={onBack}><BackIcon/>Back to Groups</button>

            <div className="group-detail-header">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:6}}>
                    <div className="group-detail-title">{group.name}</div>
                    <span className="group-category-tag">{group.category}</span>
                </div>
                <div className="group-detail-meta">
                    <span>{group.members}  members</span>
                    <span>•</span>
                    <span>{group.active}  active</span>
                </div>
                <div className="group-detail-progress">
                    <div style={{display:'flex',justifyContent:'space-between',fontSize:10,fontWeight:700,textTransform:'uppercase',letterSpacing:.5,color:'var(--gray-500)',marginBottom:6}}>
                        <span>Group Overall Progress</span><span style={{fontFamily:'var(--din)'}}>{group.progress}%</span>
                    </div>
                    <div className="progress-bar" style={{height:6}}>
                        <div className="progress-fill" style={{width:`${group.progress}%`}}></div>
                    </div>
                </div>
                <button
                    className={`join-btn${joined?' joined':''}`}
                    style={{width:'100%',marginTop:14,padding:'11px'}}
                    onClick={()=>setJoined(!joined)}
                >
                    {joined ? '✓ Joined Challenge' : 'Join Challenge'}
                </button>
            </div>

            <div className="member-list-title">Members ({members.length})</div>
            {members.map(member => (
                <div key={member.id} className="member-row" onClick={()=>setSelectedMember(member)}>
                    <div className="member-avatar-lg">{member.avatar}</div>
                    <div className="member-info">
                        <div className="member-name">{member.name}</div>
                        <div className="member-sub">{member.handle} · {member.streak}-day streak</div>
                        <div className="member-prog-wrap">
                            <div className="member-prog-track">
                                <div className="member-prog-fill" style={{width:`${member.progress}%`}}></div>
                            </div>
                            <div className="member-prog-pct">{member.progress}%</div>
                        </div>
                    </div>
                    <div className="member-arrow"><ChevronRightIcon/></div>
                </div>
            ))}
        </div>
    );
}

/* ── Date utilities: use YYYY-MM-DD format, locale-independent ── */
function toISODay(date) {
    const d = date || new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
}
function dateFromISO(str) {
    const [y,m,d] = str.split('-').map(Number);
    return new Date(y, m-1, d);
}
// Parse timeRange string "2026-02-17 ~ 2026-02-19" to get Start/End Date
function parseTimeRange(timeRange) {
    if (!timeRange) return { start: null, end: null };
    // Supports "2026-02-17 ~ 2026-02-19" and "2026/02/17 ~ 2026/02/19"
    const parts = timeRange.split(/～|~/).map(s => s.trim().replace(/\//g,'-'));
    return { start: parts[0]||null, end: parts[1]||null };
}

/* ── Calculate cumulative completion rate (shared helper) ──
   Formula: sum of completed sessions across all cycles (max per cycle = timesPerCycle)
         ÷ (Total Days ÷ intervalDays × timesPerCycle)
   intervalDays=1 → every day; intervalDays=3 → every 3-day cycle */
function calcCompletionRate(habit) {
    const timesPerCycle = habit.dailyTarget || 1;
    const intervalDays  = habit.intervalDays || 1;
    const { start: startStr, end: endStr } = parseTimeRange(habit.timeRange);
    const habitStart = startStr ? dateFromISO(startStr) : (habit.createdAt ? new Date(habit.createdAt) : new Date());
    const habitEnd   = endStr   ? dateFromISO(endStr)   : new Date();
    const msPerDay   = 1000 * 60 * 60 * 24;
    const rawDays    = Math.round((habitEnd - habitStart) / msPerDay) + 1;
    // If habit hasn't started yet (future start date), return 0
    if (rawDays <= 0) return 0;
    const totalDays  = Math.max(1, rawDays);
    // Total expected completions (denominator)
    const totalExpected = Math.ceil(totalDays / intervalDays) * timesPerCycle;
    // Actual completions (numerator, capped per day = timesPerCycle)
    const totalDone = Object.entries(habit.todayCounts || {}).reduce((s, [, v]) =>
        s + Math.min(timesPerCycle, Math.max(0, v || 0)), 0);
    return Math.min(100, Math.round((totalDone / totalExpected) * 100));
}

/* ── Check if today is a scheduled day ──
   Starting from habit start date, every intervalDays-day cycle, day 1 */
function isTodayActiveDay(habit, todayKey) {
    const intervalDays = habit.intervalDays || 1;
    if (intervalDays === 1) return true;
    const { start: startStr } = parseTimeRange(habit.timeRange);
    const habitStart = startStr ? dateFromISO(startStr) : (habit.createdAt ? new Date(habit.createdAt) : new Date());
    const today = dateFromISO(todayKey);
    const diffDays = Math.round((today - habitStart) / (1000 * 60 * 60 * 24));
    return diffDays >= 0 && (diffDays % intervalDays === 0);
}

/* ── HABIT DETAIL VIEW ── */
function HabitDetailView({ habit, onBack, onCount, currentDay }) {
    const todayKey = currentDay || toISODay();
    const target   = habit.dailyTarget || 1;
    const todayCounts = habit.todayCounts || {};
    const done = todayCounts[todayKey] !== undefined
        ? todayCounts[todayKey]
        : (todayCounts[new Date().toDateString()] || 0);
    const progPct = Math.min(100, Math.round((done / target) * 100));

    const intervalDays = habit.intervalDays || 1;
    const isActiveDay = isTodayActiveDay(habit, todayKey);

    // Today's completion rate: actual completions today (capped at goal) / daily goal (N/A on non-scheduled days)
    const todayDone = Math.min(target, Math.max(0, done));
    const todayRate = isActiveDay ? Math.min(100, Math.round((todayDone / target) * 100)) : null;

    // Cumulative completion rate: use shared helper
    const completionRate = calcCompletionRate(habit);

    return (
        <div>
            <button className="back-nav" onClick={onBack}><BackIcon/>My Habits</button>
            <div className="detail-title">{habit.name}</div>
            <div className="detail-category">
                {habit.category}
                {habit.freqLabel && ` · ${habit.freqLabel}`}
                {habit.durLabel  && ` · ${habit.durLabel}`}
                {habit.timeRange ? ' · ' + habit.timeRange : ''}
            </div>
            <div className="detail-stats-grid">
                <div className="detail-stat-card">
                    <div className="detail-stat-value">{target}</div>
                    <div className="detail-stat-label">Daily Goal</div>
                </div>
                <div className="detail-stat-card">
                    <div className="detail-stat-value">{done}</div>
                    <div className="detail-stat-label">Today's Done</div>
                </div>
                <div className="detail-stat-card">
                    <div className="detail-stat-value">{todayRate !== null ? `${todayRate}%` : '—'}</div>
                    <div className="detail-stat-label">{todayRate !== null ? "Today's Completion" : 'Rest Day'}</div>
                </div>
                <div className="detail-stat-card">
                    <div className="detail-stat-value">{completionRate}%</div>
                    <div className="detail-stat-label">Overall Rate</div>
                </div>
            </div>
            <div className="section-title">Today's Progress</div>
            <div style={{marginBottom:24}}>
                {!isActiveDay ? (
                    <div style={{
                        display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center',
                        padding:'28px 0', border:'1px solid var(--gray-200)', gap:8
                    }}>
                        <div style={{fontSize:13,fontWeight:700,color:'var(--gray-500)',textTransform:'uppercase',letterSpacing:1.5}}>Rest Day</div>
                        <div style={{fontSize:11,color:'var(--gray-400)'}}>Every {intervalDays} days — no check-in needed today</div>
                    </div>
                ) : (
                    <>
                        <div style={{display:'flex',justifyContent:'space-between',fontSize:11,fontWeight:700,textTransform:'uppercase',letterSpacing:.5,color:'var(--gray-500)',marginBottom:8}}>
                            <span>{done} / {target}  times</span><span style={{fontFamily:'var(--din)'}}>{progPct}%</span>
                        </div>
                        <div style={{height:8,background:'var(--gray-100)'}}>
                            <div style={{height:'100%',background:'var(--black)',width:`${progPct}%`,transition:'width .4s'}}></div>
                        </div>
                        <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:0,marginTop:14}}>
                            <div className="counter-wrap" style={{width:'100%',justifyContent:'center'}}>
                                <button className="counter-btn" style={{flex:1,height:44}} onClick={()=>onCount(habit.id,-1)}>−</button>
                                <input
                                    type="number"
                                    min="0"
                                    className="counter-val"
                                    style={{flex:2,height:44,fontSize:18,textAlign:'center',border:'none',borderLeft:'1px solid var(--gray-200)',borderRight:'1px solid var(--gray-200)',outline:'none',fontFamily:'var(--din)',fontWeight:700,background:'var(--white)',cursor:'text',MozAppearance:'textfield'}}
                                    value={done}
                                    onChange={e=>{
                                        const v = parseInt(e.target.value);
                                        if (!isNaN(v) && v >= 0) onCount(habit.id, Math.min(target, v) - done);
                                        else if (e.target.value === '') onCount(habit.id, -done);
                                    }}
                                />
                                <button className="counter-btn" style={{flex:1,height:44}} onClick={()=>onCount(habit.id,+1)}>＋</button>
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}

/* ── PRESETS (defined outside component, stable object references) ── */
const DURATION_PRESETS = [
    { label:'5 min',  value:5,   unit:'min' },
    { label:'15 min', value:15,  unit:'min' },
    { label:'30 min', value:30,  unit:'min' },
    { label:'1 hr',  value:60,  unit:'min' },
    { label:'Custom',    value:null, unit:'min' },
];
const FREQ_PRESETS = [
    { label:'Every day 1  times', timesPerDay:1, intervalDays:1, periodUnit:'day' },
    { label:'Every day 2  times', timesPerDay:2, intervalDays:1, periodUnit:'day' },
    { label:'Every day 3  times', timesPerDay:3, intervalDays:1, periodUnit:'day' },
    { label:'Custom',      timesPerDay:null, intervalDays:null, periodUnit:'custom' },
];

/* ── ADD HABIT MODAL ── */
function AddHabitModal({ onClose, onAdd }) {
    const now = new Date();
    const [name, setName] = useState('');
    const [category, setCategory] = useState('Fitness');

    // Start/End Date (date string for <input type="date">)
    const todayStr = toISODay(now); // use local date, not UTC
    const endOfYear = `${now.getFullYear()}-12-31`;
    const [startDate, setStartDate] = useState(todayStr);
    const [endDate, setEndDate]     = useState(endOfYear);

    const [durPreset, setDurPreset]   = useState(null);   // null = Not set
    const [durCustom, setDurCustom]   = useState('');
    const [durUnit,   setDurUnit]     = useState('min');

    const [freqPreset, setFreqPreset] = useState(null);
    const [freqCustomN, setFreqCustomN] = useState('1');       // Every X days — how many times
    const [freqIntervalDays, setFreqIntervalDays] = useState('1'); // Every N days

    const categories = ['Fitness','Nutrition','Skincare','Sleep','Mindfulness','Hydration','Learning','Other'];

    /* Calculate frequency params: { timesPerCycle: completions per cycle, intervalDays: days per cycle } */
    const getFreqParams = () => {
        if (!freqPreset) return { timesPerCycle: 1, intervalDays: 1 };
        if (freqPreset.periodUnit === 'custom') {
            return {
                timesPerCycle: Math.max(1, parseInt(freqCustomN) || 1),
                intervalDays:  Math.max(1, parseInt(freqIntervalDays) || 1),
            };
        }
        return {
            timesPerCycle: freqPreset.timesPerDay || 1,
            intervalDays:  freqPreset.intervalDays || 1,
        };
    };
    // Backward compat: dailyTarget stored as "times per cycle"
    const getDailyTarget = () => getFreqParams().timesPerCycle;

    /* Build frequency label */
    const getFreqLabel = () => {
        if (!freqPreset) return '';
        if (freqPreset.periodUnit === 'custom') {
            const days = parseInt(freqIntervalDays) || 1;
            const times = parseInt(freqCustomN) || 1;
            if (days === 1) return `Every day ${times}  times`;
            return `Every ${days} days, ${times} time${times>1?'s':''}`;
        }
        return freqPreset.label;
    };

    /* Build duration label */
    const getDurLabel = () => {
        if (!durPreset) return '';
        if (durPreset.value === null) {
            const unitMap = { min:'min', hour:'hr' };
            return `${durCustom} ${unitMap[durUnit]||durUnit}`;
        }
        return durPreset.label;
    };

    const handleAdd = () => {
        if (!name.trim()) return;
        // Validate custom duration input
        if (durPreset?.value === null && !durCustom.toString().trim()) {
            alert('Please enter a custom duration value.');
            return;
        }
        // Validate date range
        if (startDate > endDate) {
            alert('End date must be on or after start date.');
            return;
        }
        const timeRange = `${startDate} ～ ${endDate}`;
        const freqLabel = getFreqLabel();
        const durLabel  = getDurLabel();
        const { timesPerCycle, intervalDays } = getFreqParams();
        onAdd({ name: name.trim(), category, timeRange, freqLabel, durLabel, dailyTarget: timesPerCycle, intervalDays });
    };

    const isDurCustom  = durPreset?.value === null;
    const isFreqCustom = freqPreset?.periodUnit === 'custom';

    return (
        <div className="modal" onClick={onClose}>
            <div className="modal-content" onClick={e=>e.stopPropagation()}>
                <div className="modal-header">Add Habit</div>

                {/* Name */}
                <div className="form-group">
                    <label className="form-label">Habit Name</label>
                    <input type="text" className="form-input" value={name} onChange={e=>setName(e.target.value)} placeholder="e.g. Morning Run" autoFocus/>
                </div>

                {/* Category */}
                <div className="form-group">
                    <label className="form-label">Category</label>
                    <select className="form-input" value={category} onChange={e=>setCategory(e.target.value)}>
                        {categories.map(c=><option key={c} value={c}>{c}</option>)}
                    </select>
                </div>

                <div className="section-divider"/>

                {/* Duration Period */}
                <div className="form-group">
                    <div className="modal-section-label">Duration Period</div>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                        <input type="date" className="form-input" style={{flex:1,padding:'9px 8px',fontSize:12}} value={startDate} onChange={e=>setStartDate(e.target.value)}/>
                        <span className="date-sep">→</span>
                        <input type="date" className="form-input" style={{flex:1,padding:'9px 8px',fontSize:12}} value={endDate} onChange={e=>setEndDate(e.target.value)}/>
                    </div>
                </div>

                <div className="section-divider"/>

                {/* Session Duration */}
                <div className="form-group">
                    <div className="modal-section-label">Duration per Session</div>
                    <div className="pill-group">
                        {DURATION_PRESETS.map((p,i)=>(
                            <button key={i} className={`pill${durPreset===p?' selected':''}`} onClick={()=>setDurPreset(p)}>
                                {p.label}
                            </button>
                        ))}
                    </div>
                    {isDurCustom && (
                        <div className="pill-custom-wrap">
                            <input className="pill-custom-input" type="number" min="1" placeholder="30"
                                value={durCustom} onChange={e=>setDurCustom(e.target.value)}/>
                            <select className="pill-unit-select" value={durUnit} onChange={e=>setDurUnit(e.target.value)}>
                                <option value="min">min</option>
                                <option value="hour">hr</option>
                            </select>
                        </div>
                    )}
                </div>

                <div className="section-divider"/>

                {/* Frequency */}
                <div className="form-group">
                    <div className="modal-section-label">Frequency</div>
                    <div className="pill-group">
                        {FREQ_PRESETS.map((p,i)=>(
                            <button key={i} className={`pill${freqPreset===p?' selected':''}`} onClick={()=>setFreqPreset(p)}>
                                {p.label}
                            </button>
                        ))}
                    </div>
                    {isFreqCustom && (
                        <div style={{marginTop:10,display:'flex',flexDirection:'column',gap:8}}>
                            <div className="pill-custom-wrap">
                                <span style={{fontSize:11,color:'var(--gray-500)',fontWeight:600}}>Every</span>
                                <input className="pill-custom-input" type="number" min="1" placeholder="1"
                                    value={freqIntervalDays} onChange={e=>setFreqIntervalDays(e.target.value)}/>
                                <span style={{fontSize:11,color:'var(--gray-500)',fontWeight:600}}>days, do it</span>
                                <input className="pill-custom-input" type="number" min="1" placeholder="1"
                                    value={freqCustomN} onChange={e=>setFreqCustomN(e.target.value)}/>
                                <span style={{fontSize:11,color:'var(--gray-500)',fontWeight:600}}> times</span>
                            </div>
                            <div style={{fontSize:10,color:'var(--gray-400)',paddingLeft:2}}>
                                e.g. Every 1 day = daily; Every 2 days, 3 times = 3 sessions within 2 daysimes
                            </div>
                        </div>
                    )}
                </div>

                <div className="button-group">
                    <button className="button button-secondary" onClick={onClose}>Cancel</button>
                    <button className="button button-primary" onClick={handleAdd}>Create</button>
                </div>
            </div>
        </div>
    );
}


/* ── SVG Donut Chart helper ── */
function DonutChart({ pct, size=90, stroke=10, color='#fff', bg='rgba(255,255,255,0.12)', label, sublabel }) {
    const r = (size - stroke) / 2;
    const circ = 2 * Math.PI * r;
    const dash = (pct / 100) * circ;
    const cx = size / 2, cy = size / 2;
    return (
        <div className="donut-wrap" style={{width:size, height:size}}>
            <svg width={size} height={size} style={{transform:'rotate(-90deg)'}}>
                <circle cx={cx} cy={cy} r={r} fill="none" stroke={bg} strokeWidth={stroke}/>
                <circle cx={cx} cy={cy} r={r} fill="none" stroke={color} strokeWidth={stroke}
                    strokeDasharray={`${dash} ${circ}`}
                    strokeLinecap="butt"
                    style={{transition:'stroke-dasharray .8s cubic-bezier(.4,0,.2,1)'}}
                />
            </svg>
            <div className="donut-center">
                <div className="donut-center-val" style={{color}}>{pct}%</div>
                {sublabel && <div className="donut-center-lbl" style={{color}}>{sublabel}</div>}
            </div>
        </div>
    );
}

/* ── Mini SVG circle for archive list items ── */
function MiniDonut({ pct, size=46 }) {
    const stroke = 5, r = (size-stroke)/2;
    const circ = 2*Math.PI*r, dash = (pct/100)*circ;
    const color = pct>=70?'#4ade80':pct>=40?'#fbbf24':'#f87171';
    return (
        <svg width={size} height={size} style={{transform:'rotate(-90deg)'}}>
            <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#f0f0f0" strokeWidth={stroke}/>
            <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth={stroke}
                strokeDasharray={`${dash} ${circ}`} strokeLinecap="butt"/>
        </svg>
    );
}

/* ── HISTORY PAGE ── */
function HistoryPage({ habits, archivedHabits, percentile, onBack }) {
    // Sorted archived: newest first by archivedAt
    const sorted = [...archivedHabits].sort((a,b) => (b.archivedAt||'') > (a.archivedAt||'') ? 1 : -1);

    const expiredRates = archivedHabits.map(h => h.finalRate || 0);
    const activeRates  = habits.map(h => calcCompletionRate(h));
    const expiredAvg   = expiredRates.length ? Math.round(expiredRates.reduce((s,r)=>s+r,0)/expiredRates.length) : 0;
    const activeAvg    = activeRates.length  ? Math.round(activeRates.reduce((s,r)=>s+r,0)/activeRates.length)   : 0;

    // Meaningful stats
    const totalCompleted = archivedHabits.length;
    const bestHabit      = archivedHabits.reduce((best, h) => (!best || (h.finalRate||0) > (best.finalRate||0)) ? h : best, null);
    const highCount      = archivedHabits.filter(h=>(h.finalRate||0)>=70).length;
    const allRates       = [...expiredRates, ...activeRates];

    return (
        <div className="app-container" style={{paddingBottom:40}}>
            {/* Header nav */}
            <div className="history-nav">
                <button className="history-nav-back" onClick={onBack}>
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>
                    Back
                </button>
                <div className="history-nav-title">Habit History</div>
            </div>

            {/* Chart section — dark background */}
            <div className="history-chart-section">
                <div className="history-chart-title">Expired Habits · Final Score</div>
                <div className="history-charts-row">

                    {/* Main donut: EXPIRED avg — the real score */}
                    <DonutChart
                        pct={expiredAvg}
                        size={108} stroke={12}
                        color="#ffffff" bg="rgba(255,255,255,0.1)"
                        sublabel="EXPIRED AVG"
                    />

                    {/* Right side: meaningful stats */}
                    <div className="history-legend">

                        {/* Active habits current avg */}
                        <div style={{display:'flex',alignItems:'center',gap:10,paddingBottom:10,borderBottom:'1px solid rgba(255,255,255,.1)'}}>
                            <DonutChart pct={activeAvg} size={52} stroke={6}
                                color="#94a3b8" bg="rgba(255,255,255,0.08)"
                                sublabel="NOW"/>
                            <div>
                                <div style={{fontSize:10,opacity:.5,textTransform:'uppercase',letterSpacing:.8,marginBottom:2}}>Active Now</div>
                                <div style={{fontSize:12,opacity:.8,lineHeight:1.4}}>{habits.length} habit{habits.length!==1?'s':''} in progress</div>
                            </div>
                        </div>

                        {/* Stats row */}
                        <div style={{display:'flex',gap:0,marginTop:10}}>
                            <div style={{flex:1,textAlign:'center'}}>
                                <div style={{fontSize:20,fontWeight:700,fontFamily:'var(--din)',color:'#fff'}}>{totalCompleted}</div>
                                <div style={{fontSize:9,opacity:.45,textTransform:'uppercase',letterSpacing:.7,marginTop:2}}>Completed</div>
                            </div>
                            <div style={{width:1,background:'rgba(255,255,255,.1)',margin:'0 4px'}}/>
                            <div style={{flex:1,textAlign:'center'}}>
                                <div style={{fontSize:20,fontWeight:700,fontFamily:'var(--din)',color:'#4ade80'}}>{highCount}</div>
                                <div style={{fontSize:9,opacity:.45,textTransform:'uppercase',letterSpacing:.7,marginTop:2}}>≥70% rate</div>
                            </div>
                            <div style={{width:1,background:'rgba(255,255,255,.1)',margin:'0 4px'}}/>
                            <div style={{flex:1,textAlign:'center'}}>
                                <div style={{fontSize:20,fontWeight:700,fontFamily:'var(--din)',color:'#fbbf24'}}>{bestHabit ? (bestHabit.finalRate||0)+'%' : '—'}</div>
                                <div style={{fontSize:9,opacity:.45,textTransform:'uppercase',letterSpacing:.7,marginTop:2}}>Best rate</div>
                            </div>
                        </div>

                        {/* Best habit name */}
                        {bestHabit && (
                            <div style={{marginTop:10,padding:'7px 10px',background:'rgba(255,255,255,.07)',borderLeft:'2px solid rgba(255,255,255,.3)'}}>
                                <div style={{fontSize:9,opacity:.45,textTransform:'uppercase',letterSpacing:.7,marginBottom:2}}>Best habit</div>
                                <div style={{fontSize:11,fontWeight:600,opacity:.9,overflow:'hidden',whiteSpace:'nowrap',textOverflow:'ellipsis'}}>{bestHabit.name}</div>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Percentile banner */}
            {percentile !== null && allRates.length > 0 && (
                <div className="history-percentile">
                    <div className="percentile-big">{percentile}<span>%</span></div>
                    <div className="percentile-text">
                        <strong>Better than {percentile}% of all users</strong>
                        <small>
                            {percentile>=90?'Top tier performer 🔥':
                             percentile>=70?'Above average — great work 💪':
                             percentile>=50?'Solid consistency, keep it up ↑':
                             'Every habit counts — keep going ✦'}
                        </small>
                        <div className="percentile-bar-wrap">
                            <div className="percentile-bar-track">
                                <div className="percentile-bar-fill" style={{width:`${percentile}%`}}></div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Archive list */}
            <div className="archive-list-section">
                <div className="archive-list-header">
                    <div className="section-title" style={{marginBottom:0}}>Completed Habits</div>
                    <div className="archive-count-badge">{sorted.length} total</div>
                </div>

                {sorted.length === 0 ? (
                    <div style={{textAlign:'center',padding:'40px 20px'}}>
                        <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{margin:'0 auto 12px',display:'block',opacity:.15}}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <div style={{fontSize:13,fontWeight:600,color:'var(--gray-400)',marginBottom:6}}>No history yet</div>
                        <div style={{fontSize:11,color:'var(--gray-300)',lineHeight:1.6}}>
                            Habits will appear here once their<br/>end date has passed.
                        </div>
                    </div>
                ) : sorted.map((h, i) => {
                    const r = h.finalRate || 0;
                    const barColor = r>=70?'#4ade80':r>=40?'#fbbf24':'#f87171';
                    const textColor = r>=70?'#16a34a':r>=40?'#d97706':'#dc2626';
                    return (
                        <div key={h.id || i} className="archive-item">
                            <div className="archive-item-top">
                                <div className="archive-item-left">
                                    <div className="archive-item-name">{h.name}</div>
                                    <div className="archive-item-range">
                                        {h.timeRange || '—'}
                                        {h.archivedAt && ` · Ended ${h.archivedAt}`}
                                    </div>
                                </div>
                                <div className="archive-rate-circle" style={{position:'relative'}}>
                                    <MiniDonut pct={r}/>
                                    <div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',fontSize:10,fontWeight:700,fontFamily:'var(--din)',color:textColor,textAlign:'center',lineHeight:1}}>
                                        {r}%
                                    </div>
                                </div>
                            </div>
                            <div className="archive-prog-bar">
                                <div className="archive-prog-fill" style={{width:`${r}%`,background:barColor}}></div>
                            </div>
                            <div className="archive-item-tags">
                                <span className="archive-tag">{h.category}</span>
                                {h.freqLabel && <span className="archive-tag">{h.freqLabel}</span>}
                                {h.durLabel  && <span className="archive-tag">{h.durLabel}</span>}
                            </div>
                        </div>
                    );
                })}
            </div>
            <div style={{height:40}}/>
        </div>
    );
}

/* ── MAIN APP ── */
function MainApp({ user, onLogout }) {
    const [activeTab, setActiveTab] = useState('home');
    const [deleteModal, setDeleteModal] = useState(false);  // 刪帳 modal
    const [deleteStep, setDeleteStep] = useState(1);         // 1=確認 2=輸入密碼 3=刪除中
    const [deletePassword, setDeletePassword] = useState('');
    const [deleteError, setDeleteError] = useState('');
    const [showModal, setShowModal] = useState(false);
    const [showHistory, setShowHistory] = useState(false);
    const [habits, setHabits] = useState([]);
    const [archivedHabits, setArchivedHabits] = useState([]);
    const [percentile, setPercentile] = useState(null);
    const [loading, setLoading] = useState(true);
    const [selectedHabit, setSelectedHabit] = useState(null);
    const [selectedGroup, setSelectedGroup] = useState(null);
    const [groups, setGroups] = useState(() => {
        try {
            const saved = localStorage.getItem('groups_joined_' + (user?.uid || 'demo'));
            if (saved) {
                const joinedIds = JSON.parse(saved);
                return mockGroups.map(g => ({ ...g, joined: joinedIds.includes(g.id) }));
            }
        } catch(e) {}
        return mockGroups;
    });
    const [feedPosts, setFeedPosts] = useState(mockFeedGlobal);
    const [myPosts, setMyPosts] = useState([]);
    const [postText, setPostText] = useState('');
    const [postMedia, setPostMedia] = useState(null); // { type:'image'|'video', url, file }
    const fileInputRef = useRef(null);
    const videoInputRef = useRef(null);

    useEffect(() => {
        if (!isFirebaseConfigured) {
            const saved = localStorage.getItem(`habits_${user.uid}`);
            const savedArchive = localStorage.getItem(`archived_habits_${user.uid}`);
            if (savedArchive) { try { setArchivedHabits(JSON.parse(savedArchive)); } catch(e){} }
            if (saved) {
                // Migrate old key format → YYYY-MM-DD
                const parsed = JSON.parse(saved);
                const migrated = parsed.map(h => {
                    // Migrate checkedDates
                    const newChecked = [...new Set((h.checkedDates||[]).map(d => {
                        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                        const p = new Date(d); return isNaN(p) ? null : toISODay(p);
                    }).filter(Boolean))];
                    // Migrate todayCounts
                    const newCounts = {};
                    Object.entries(h.todayCounts||{}).forEach(([k,v]) => {
                        const isoKey = /^\d{4}-\d{2}-\d{2}$/.test(k) ? k : toISODay(new Date(k));
                        if (isoKey) newCounts[isoKey] = (newCounts[isoKey]||0) + v;
                    });
                    // Recalculate streak
                    let streak = 0;
                    let cur = new Date(); cur.setHours(0,0,0,0);
                    while (newChecked.includes(toISODay(cur))) { streak++; cur.setDate(cur.getDate()-1); }
                    return { ...h, checkedDates: newChecked, todayCounts: newCounts, streak };
                });
                setHabits(migrated);
            } else {
                setHabits([]);
            }
            setLoading(false); return;
        }
        const unsub = db.collection('habits').where('userId','==',user.uid).onSnapshot(snap => {
            setHabits(snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>{
                const ta = a.createdAt?.toMillis?.() || 0;
                const tb = b.createdAt?.toMillis?.() || 0;
                return tb - ta;
            }));
            setLoading(false);
        }, err => {
            console.error('Firestore error:', err);
            setLoading(false);
        });
        // Load archived habits
        db.collection('archived_habits').where('userId','==',user.uid).get()
            .then(snap => {
                const list = snap.docs.map(d=>({id:d.id,...d.data()}))
                    .sort((a,b)=>(b.archivedAt||'')>(a.archivedAt||'')?1:-1);
                setArchivedHabits(list);
            }).catch(()=>{});
        // Safety timeout: wait max 8s
        const timeout = setTimeout(() => setLoading(false), 8000);
        return () => { unsub(); clearTimeout(timeout); };
    }, [user]);

    useEffect(() => {
        if (!isFirebaseConfigured && habits.length >= 0) {
            localStorage.setItem(`habits_${user.uid}`, JSON.stringify(habits));
        }
    }, [habits, user]);

    useEffect(() => {
        if (!isFirebaseConfigured) {
            localStorage.setItem(`archived_habits_${user.uid}`, JSON.stringify(archivedHabits));
        }
    }, [archivedHabits, user]);

    // Auto-detect midnight rollover: schedule re-render at next 00:00
    const [currentDay, setCurrentDay] = useState(toISODay());
    useEffect(() => {
        const scheduleNextMidnight = () => {
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
            const msUntilMidnight = tomorrow - now;
            return setTimeout(() => {
                setCurrentDay(toISODay()); // trigger re-render, all todayKey will update
                scheduleNextMidnight();    // schedule next midnight detection
            }, msUntilMidnight);
        };
        const timer = scheduleNextMidnight();
        return () => clearTimeout(timer);
    }, []);

    const addHabit = ({ name, category, timeRange, freqLabel, durLabel, dailyTarget, intervalDays }) => {
        if (habits.length >= 30) {
            alert('You can have at most 30 active habits at a time.');
            return;
        }
        const habit = { name, category, timeRange, freqLabel: freqLabel||'', durLabel: durLabel||'', dailyTarget: dailyTarget||1, intervalDays: intervalDays||1, userId: user.uid, checkedDates:[], todayCounts:{}, streak:0, createdAt: new Date().toISOString() };
        if (!isFirebaseConfigured) {
            setHabits([{ ...habit, id: Date.now().toString() }, ...habits]);
        } else {
            db.collection('habits').add({ ...habit, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        setShowModal(false);
    };

    // Auto-archive habits whose end date has passed
    useEffect(() => {
        if (loading || habits.length === 0) return;
        const today = toISODay();
        const expired = habits.filter(h => {
            const { end } = parseTimeRange(h.timeRange);
            return end && end < today;
        });
        if (expired.length === 0) return;
        const existingIds = new Set(archivedHabits.map(a => a.id));
        const toAdd = expired.filter(h => !existingIds.has(h.id)).map(h => ({
            ...h, archivedAt: today, finalRate: calcCompletionRate(h)
        }));
        if (toAdd.length === 0) return;
        // Sort by archivedAt desc when merging
        setArchivedHabits(prev => [...toAdd, ...prev].sort((a,b)=>(b.archivedAt||'')>(a.archivedAt||'')?1:-1));
        if (!isFirebaseConfigured) {
            setHabits(prev => prev.filter(h => !expired.find(e=>e.id===h.id)));
        } else {
            toAdd.forEach(async h => {
                try {
                    await db.collection('archived_habits').doc(h.id).set({ ...h, userId: user.uid });
                    await db.collection('habits').doc(h.id).delete();
                } catch(e) { console.warn('Archive error', e); }
            });
        }
    }, [habits, loading]);

    // Percentile computation
    useEffect(() => {
        if (loading) return;
        const expiredRates = archivedHabits.map(h => h.finalRate || 0);
        const activeRates  = habits.map(h => calcCompletionRate(h));
        const all = [...expiredRates, ...activeRates];
        const myAvg = all.length ? Math.round(all.reduce((s,r)=>s+r,0)/all.length) : 0;
        if (!isFirebaseConfigured) {
            const mock = [15,22,28,35,40,45,50,54,58,62,65,68,70,73,75,78,80,82,84,86,88,90,92,95];
            setPercentile(Math.round(mock.filter(r=>r<myAvg).length/mock.length*100));
            return;
        }
        db.collection('user_stats').doc(user.uid)
            .set({ avgRate: myAvg, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true })
            .then(() => db.collection('user_stats').get())
            .then(snap => {
                const rates = snap.docs.map(d=>d.data().avgRate||0);
                setPercentile(Math.round(rates.filter(r=>r<myAvg).length/rates.length*100));
            }).catch(()=>{});
    }, [habits, archivedHabits, loading]);

    const deleteHabit = (habitId) => {
        if (!isFirebaseConfigured) {
            setHabits(prev => prev.filter(h => h.id !== habitId));
        } else {
            db.collection('habits').doc(habitId).delete();
        }
    };

    const countHabit = async (habitId, delta) => {
        const todayKey = toISODay();                       // YYYY-MM-DD
        const habit = habits.find(h=>h.id===habitId);
        if (!habit) return;

        // todayCounts: support old key format and migrate
        const rawCounts = { ...(habit.todayCounts||{}) };
        // If old-format key exists for today, migrate it
        const legacyTodayKey = new Date().toDateString();
        if (rawCounts[legacyTodayKey] !== undefined && rawCounts[todayKey] === undefined) {
            rawCounts[todayKey] = rawCounts[legacyTodayKey];
            delete rawCounts[legacyTodayKey];
        }
        const counts = rawCounts;
        // Check if today is "Done" (reached dailyTarget)
        const target = habit.dailyTarget || 1;
        const cur = counts[todayKey] || 0;
        const next = Math.min(target, Math.max(0, cur + delta));
        counts[todayKey] = next;

        const wasDone = cur >= target;
        const isDone  = next >= target;

        // Normalize checkedDates to YYYY-MM-DD, remove old format duplicates
        let checkedDates = [...new Set((habit.checkedDates||[]).map(d => {
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            const p = new Date(d); return isNaN(p) ? null : toISODay(p);
        }).filter(Boolean))];

        if (!wasDone && isDone)  checkedDates = [...new Set([...checkedDates, todayKey])];
        if (wasDone  && !isDone) checkedDates = checkedDates.filter(d=>d!==todayKey);

        // Streak: strictly counting back from today, 0 if today not done
        let streak = 0;
        let cur2 = new Date(); cur2.setHours(0,0,0,0);
        while (checkedDates.includes(toISODay(cur2))) { streak++; cur2.setDate(cur2.getDate()-1); }

        if (!isFirebaseConfigured) {
            setHabits(habits.map(h=>h.id===habitId?{...h,todayCounts:counts,checkedDates,streak}:h));
        } else {
            await db.collection('habits').doc(habitId).update({ todayCounts:counts, checkedDates, streak });
        }
    };

    const toggleHabit = async (habitId) => {
        const today = toISODay();
        const habit = habits.find(h=>h.id===habitId);
        if (!habit) return;
        // Normalize checkedDates to ISO format
        const normalized = [...new Set((habit.checkedDates||[]).map(d => {
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            const p = new Date(d); return isNaN(p) ? null : toISODay(p);
        }).filter(Boolean))];
        const isChecked = normalized.includes(today);
        const newDates = isChecked ? normalized.filter(d=>d!==today) : [...normalized, today];
        let streak = 0;
        let cur = new Date(); cur.setHours(0,0,0,0);
        while (newDates.includes(toISODay(cur))) { streak++; cur.setDate(cur.getDate()-1); }
        if (!isFirebaseConfigured) {
            setHabits(habits.map(h=>h.id===habitId?{...h,checkedDates:newDates,streak}:h));
        } else {
            await db.collection('habits').doc(habitId).update({ checkedDates:newDates, streak });
        }
    };

    const totalStreak = habits.reduce((s,h)=>s+(h.streak||0),0);
    const todayStr = currentDay;
    const todayCompleted = habits.filter(h=>{
        const normalized = (h.checkedDates||[]).map(d=>{
            if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            const p=new Date(d); return isNaN(p)?null:toISODay(p);
        }).filter(Boolean);
        return normalized.includes(todayStr);
    }).length;
    // Cumulative completion rate: average across habits (using shared helper)
    const rate = habits.length > 0
        ? Math.round(habits.reduce((sum, h) => sum + calcCompletionRate(h), 0) / habits.length)
        : 0;

    // ── Load feed posts from Firebase in real-time ──
    useEffect(() => {
        if (!isFirebaseConfigured) return;
        const unsub = db.collection('posts')
            .orderBy('createdAt', 'desc')
            .limit(50)
            .onSnapshot(snap => {
                const posts = snap.docs.map(d => {
                    const data = d.data();
                    const createdAt = data.createdAt?.toDate?.();
                    const timeStr = createdAt ? formatTime(createdAt) : 'Just now';
                    return { id: d.id, ...data, time: timeStr };
                });
                setFeedPosts(posts);
                // Update myPosts (own posts)
                setMyPosts(posts.filter(p => p.userId === user.uid));
            });
        return () => unsub();
    }, [user]);

    function formatTime(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff/60)} min ago`;
        if (diff < 86400) return `${Math.floor(diff/3600)} hr ago`;
        return `${Math.floor(diff/86400)} day ago`;
    }

    const handleLikeFeed = async (postId) => {
        if (!isFirebaseConfigured) {
            setFeedPosts(prev => prev.map(p => {
                if (p.id !== postId) return p;
                const nowLiked = !p.liked;
                return { ...p, liked: nowLiked, likes: Math.max(0, (p.likes||0) + (nowLiked ? 1 : -1)) };
            }));
            return;
        }
        const post = feedPosts.find(p => p.id === postId);
        if (!post) return;
        const likedBy = Array.isArray(post.likedBy) ? post.likedBy : [];
        const hasLiked = likedBy.includes(user.uid);
        // Optimistic UI update immediately
        setFeedPosts(prev => prev.map(p => {
            if (p.id !== postId) return p;
            const newLikedBy = hasLiked
                ? likedBy.filter(id => id !== user.uid)
                : [...likedBy, user.uid];
            return { ...p, likedBy: newLikedBy, likes: Math.max(0, (p.likes||0) + (hasLiked ? -1 : 1)) };
        }));
        try {
            await db.collection('posts').doc(postId).update({
                likes: firebase.firestore.FieldValue.increment(hasLiked ? -1 : 1),
                likedBy: hasLiked
                    ? firebase.firestore.FieldValue.arrayRemove(user.uid)
                    : firebase.firestore.FieldValue.arrayUnion(user.uid),
            });
        } catch(e) {
            console.error(e);
            // Revert on failure
            setFeedPosts(prev => prev.map(p => {
                if (p.id !== postId) return p;
                return { ...p, likedBy: likedBy, likes: Math.max(0, (p.likes||0) + (hasLiked ? 1 : -1)) };
            }));
        }
    };

    const [uploadingMedia, setUploadingMedia] = useState(false);
    const [uploadProgress, setUploadProgress] = useState(0);
    const [avatarUrl, setAvatarUrl] = useState(() => localStorage.getItem(`avatar_${user?.uid}`) || null);
    const [uploadingAvatar, setUploadingAvatar] = useState(false);
    const avatarInputRef = useRef(null);

    const handleMediaSelect = async (e, type) => {
        const file = e.target.files?.[0];
        if (!file) return;
        e.target.value = '';

        // Immediately show local preview
        const localUrl = URL.createObjectURL(file);
        setPostMedia({ type, url: localUrl, file, uploading: true });
        setUploadingMedia(true);
        setUploadProgress(0);

        try {
            const resourceType = type === 'video' ? 'video' : 'image';
            const result = await uploadToCloudinary(file, resourceType, (pct) => setUploadProgress(pct));
            setPostMedia({ type, url: result.url, file: null, uploading: false, local: result.local });
        } catch (err) {
            alert('Upload failed：' + err.message);
            setPostMedia(null);
        } finally {
            setUploadingMedia(false);
        }
    };

    const handleAvatarSelect = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        e.target.value = '';
        setUploadingAvatar(true);
        try {
            const result = await uploadToCloudinary(file, 'image', null);
            setAvatarUrl(result.url);
            localStorage.setItem(`avatar_${user?.uid}`, result.url);
        } catch (err) {
            alert('AvatarUpload failed：' + err.message);
        } finally {
            setUploadingAvatar(false);
        }
    };

    const handlePostSubmit = async () => {
        if (!postText.trim() && !postMedia) return;
        if (postMedia?.uploading) return;
        const avatar = (user.displayName || user.email)?.[0]?.toUpperCase() || 'U';
        const newPost = {
            userId: user.uid,
            user: user.displayName || 'User',
            avatar,
            avatarUrl: localStorage.getItem(`avatar_${user.uid}`) || null,
            text: postText.trim(),
            habit: '',
            likes: 0,
            comments: 0,
            likedBy: [],
            hasImage: postMedia?.type === 'image',
            hasVideo: postMedia?.type === 'video',
            mediaUrl: postMedia?.url || null,
        };
        if (isFirebaseConfigured) {
            try {
                await db.collection('posts').add({
                    ...newPost,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
            } catch(e) { alert('Post failed: ' + e.message); return; }
        } else {
            const localPost = { ...newPost, id: 'my-' + Date.now(), time: 'Just now', liked: false, isOwn: true };
            setMyPosts(prev => [localPost, ...prev]);
            setFeedPosts(prev => [localPost, ...prev]);
        }
        setPostText('');
        setPostMedia(null);
    };


    /* ── 判斷登入方式 ── */
    const isGoogleUser = () => {
        if (!auth.currentUser) return false;
        return auth.currentUser.providerData.some(p => p.providerId === 'google.com');
    };

    /* ── 刪除帳號 — 清除所有用戶資料後刪除 Firebase Auth 帳號 ── */
    const handleDeleteAccount = async () => {
        if (!isFirebaseConfigured) {
            localStorage.removeItem('demoUser');
            onLogout();
            return;
        }
        setDeleteStep(3);
        setDeleteError('');
        try {
            const uid = user.uid;
            // Step 1: 重新驗證（Firebase 刪帳需要近期登入）
            if (isGoogleUser()) {
                // Google OAuth 用戶：使用 Google popup 重新驗證
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.currentUser.reauthenticateWithPopup(provider);
            } else {
                // Email/Password 用戶：使用密碼重新驗證
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, deletePassword);
                await auth.currentUser.reauthenticateWithCredential(credential);
            }

            // Step 2: 刪除 Firestore 資料（所有 collection）
            // 刪除 habits
            const habitsSnap = await db.collection('habits').where('userId','==',uid).get();
            const batch1 = db.batch();
            habitsSnap.docs.forEach(d => batch1.delete(d.ref));
            if (habitsSnap.docs.length) await batch1.commit();

            // 刪除 posts 與其 subcollection comments
            const postsSnap = await db.collection('posts').where('userId','==',uid).get();
            for (const postDoc of postsSnap.docs) {
                const commentsSnap = await postDoc.ref.collection('comments').get();
                const batchC = db.batch();
                commentsSnap.docs.forEach(d => batchC.delete(d.ref));
                if (commentsSnap.docs.length) await batchC.commit();
                await postDoc.ref.delete();
            }

            // 刪除用戶自己在其他貼文下的 comments
            const allPosts = await db.collection('posts').get();
            for (const postDoc of allPosts.docs) {
                const myComments = await postDoc.ref.collection('comments').where('userId','==',uid).get();
                const batchMC = db.batch();
                myComments.docs.forEach(d => batchMC.delete(d.ref));
                if (myComments.docs.length) await batchMC.commit();
            }

            // 刪除 archived_habits
            try {
                const archiveSnap = await db.collection('archived_habits').where('userId','==',uid).get();
                const batchArch = db.batch();
                archiveSnap.docs.forEach(d => batchArch.delete(d.ref));
                if (archiveSnap.docs.length) await batchArch.commit();
            } catch(e){}
            // 刪除 user_stats
            try { await db.collection('user_stats').doc(uid).delete(); } catch(e){}
            // 刪除 upload_quotas
            try { await db.collection('upload_quotas').doc(uid).delete(); } catch(e){}

            // 刪除 users 文件
            try { await db.collection('users').doc(uid).delete(); } catch(e){}

            // 清除 localStorage
            localStorage.removeItem('demoUser');
            localStorage.removeItem('pwa-installed');
            localStorage.removeItem('notif-asked');
            localStorage.removeItem('ios-hint-shown');
            localStorage.removeItem('avatar_' + uid);

            // Step 3: 刪除 Firebase Auth 帳號（最後執行）
            await auth.currentUser.delete();

            // 完成 — onAuthStateChanged 會自動把用戶踢出
        } catch(e) {
            setDeleteStep(2);
            const errMap = {
                'auth/wrong-password':       '密碼錯誤，請再試一次',
                'auth/invalid-credential':   '密碼錯誤，請再試一次',
                'auth/too-many-requests':    '嘗試次數過多，請稍後再試',
                'auth/requires-recent-login':'請重新登入後再試',
            };
            setDeleteError(errMap[e.code] || ('刪除失敗：' + e.message));
        }
    };

    if (loading) return <div className="app-container"><div className="loading">Loading...</div></div>;
    if (showHistory) return (
        <HistoryPage
            habits={habits}
            archivedHabits={archivedHabits}
            percentile={percentile}
            onBack={()=>setShowHistory(false)}
        />
    );

    const renderHome = () => {
        if (selectedHabit) {
            const habit = habits.find(h=>h.id===selectedHabit);
            if (!habit) { setSelectedHabit(null); return null; }
            return <HabitDetailView habit={habit} onBack={()=>setSelectedHabit(null)} onCount={countHabit} currentDay={currentDay}/>;
        }
        return (
            <div>
                {/* + button */}
                <div className="home-top">
                    <button className="center-add-btn-standalone"
                        onClick={()=>{ if(habits.length>=30){alert('Max 30 active habits. Wait for habits to expire or delete one.');return;} setShowModal(true); }}
                        style={{opacity: habits.length>=30 ? 0.4 : 1}}
                    >
                        <PlusIcon/>
                    </button>
                </div>
                {habits.length > 0 && (
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}>
                        <div className="section-title" style={{marginBottom:0}}>My Habits</div>
                        <span style={{fontSize:10,fontWeight:700,color: habits.length>=30?'#dc2626':'var(--gray-400)',textTransform:'uppercase',letterSpacing:.8}}>
                            {habits.length}/30
                        </span>
                    </div>
                )}
                {habits.length === 0 ? (
                    <div className="empty-state">
                        <HomeIcon/>
                        <h3>No habits yet</h3>
                        <p>Tap + Create your first habit</p>
                    </div>
                ) : (
                    habits.map(habit => {
                        const todayKey = currentDay;
                        // Home bar: cumulative completion rate (supports custom intervalDays)
                        const progPct = calcCompletionRate(habit);
                        return (
                            <div key={habit.id} className="habit-card" onClick={()=>setSelectedHabit(habit.id)}>
                                <div className="habit-header">
                                    <div className="habit-info">
                                        <div className="habit-title">{habit.name}</div>
                                        <div className="habit-meta">
                                            <span className="habit-category">{habit.category}</span>
                                            {habit.streak > 0 && (
                                                <div className="habit-streak"><FlameIcon/><span>{habit.streak}</span></div>
                                            )}
                                        </div>
                                        {/* Frequency & Duration tag */}
                                        <div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:4}}>
                                            {habit.freqLabel && <span style={{fontSize:9,fontWeight:700,textTransform:'uppercase',letterSpacing:.5,padding:'2px 6px',background:'var(--gray-100)',color:'var(--gray-600)'}}>{habit.freqLabel}</span>}
                                            {habit.durLabel  && <span style={{fontSize:9,fontWeight:700,textTransform:'uppercase',letterSpacing:.5,padding:'2px 6px',background:'var(--gray-100)',color:'var(--gray-600)'}}>{habit.durLabel}</span>}
                                        </div>
                                        {habit.timeRange && <div className="habit-time-range" style={{marginTop:4}}>{habit.timeRange}</div>}
                                    </div>
                                    <div className="habit-progress-section" onClick={e=>e.stopPropagation()}>
                                        <div className="habit-progress-bar-wrap">
                                            <div className="habit-prog-label">
                                                <span>Done</span>
                                                <span style={{fontFamily:'var(--din)'}}>{progPct}%</span>
                                            </div>
                                            <div className="habit-prog-track">
                                                <div className={`habit-prog-fill${progPct>=100?' done':''}`} style={{width:`${progPct}%`}}></div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div className="card-delete-row" onClick={e=>e.stopPropagation()}>
                                    <button
                                        className="card-delete-btn"
                                        onClick={()=>deleteHabit(habit.id)}
                                    >
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Delete Habit
                                    </button>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        );
    };

    const renderGroups = () => {
        if (selectedGroup) {
            return <GroupDetailView group={selectedGroup} currentUser={user} onBack={()=>setSelectedGroup(null)}/>;
        }
        return (
            <div>
                <div className="section-title">Active Groups</div>
                {groups.map(group => (
                    <div key={group.id} className="group-card">
                        <div className="group-card-header">
                            <div className="group-name">{group.name}</div>
                            <span className="group-category-tag">{group.category}</span>
                        </div>
                        <div className="group-info">
                            <span>{group.members}  members</span>
                            <span>•</span>
                            <span>{group.active}  active</span>
                        </div>
                        <div className="group-progress">
                            <div className="progress-label">
                                <span>Progress</span><span style={{fontFamily:'var(--din)'}}>{group.progress}%</span>
                            </div>
                            <div className="progress-bar"><div className="progress-fill" style={{width:`${group.progress}%`}}></div></div>
                        </div>
                        <div className="group-bottom">
                            <div className="group-members">
                                {[...Array(Math.min(group.active,6))].map((_,i)=>(
                                    <div key={i} className="member-avatar-sm">{String.fromCharCode(65+i)}</div>
                                ))}
                            </div>
                            <div style={{display:'flex',gap:8}}>
                                <button
                                    className={`join-btn${group.joined?' joined':''}`}
                                    onClick={e=>{
                                        e.stopPropagation();
                                        setGroups(prev=>{
                                            const updated = prev.map(g=>g.id===group.id?{...g,joined:!g.joined}:g);
                                            try {
                                                const joinedIds = updated.filter(g=>g.joined).map(g=>g.id);
                                                localStorage.setItem('groups_joined_' + (user?.uid || 'demo'), JSON.stringify(joinedIds));
                                            } catch(e) {}
                                            return updated;
                                        });
                                    }}
                                >
                                    {group.joined ? '✓ Joined' : 'Join'}
                                </button>
                                <button
                                    className="join-btn"
                                    onClick={()=>setSelectedGroup(group)}
                                >
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );
    };

    const renderFeed = () => (
        <div>
            <div className="section-title">Community Feed</div>
            {feedPosts.length === 0 && (
                <div className="empty-state">
                    <ChatIcon/>
                    <h3>No posts yet</h3>
                    <p>Go to your Profile to publish your first post!</p>
                </div>
            )}
            {feedPosts.map(post => {
                // Determine liked: use likedBy array (Firebase mode) or liked flag (demo mode)
                const likedBy = Array.isArray(post.likedBy) ? post.likedBy : [];
                const liked = isFirebaseConfigured
                    ? likedBy.includes(user.uid)
                    : (post.liked || false);
                return (
                    <FeedCard
                        key={post.id}
                        post={{...post, liked, likes: post.likes || 0}}
                        currentUser={user}
                        onLike={handleLikeFeed}
                    />
                );
            })}
        </div>
    );

    const renderProfile = () => (
        <div>
            {!isCloudinaryConfigured && (
                <div className="cloudinary-setup-box">
                    <strong>⚡ Enable media uploads:</strong> Fill in your info at the top of the code<br/>
                    <code>CLOUDINARY_CLOUD_NAME</code> and <code>CLOUDINARY_UPLOAD_PRESET</code><br/>
                    <a href="https://cloudinary.com" target="_blank">Sign up free on Cloudinary →</a> (free forever plan)
                </div>
            )}
            <div className="profile-header">
                <div className="profile-avatar-wrap" onClick={()=>avatarInputRef.current?.click()} title="TapChange Photo">
                    {avatarUrl
                        ? <img src={avatarUrl} className="avatar-img" alt="Avatar"/>
                        : <div className="profile-avatar">{uploadingAvatar ? '⟳' : ((user.displayName||user.email)?.[0]?.toUpperCase()||'U')}</div>
                    }
                    <div className="avatar-edit-overlay">{uploadingAvatar ? 'Uploading…' : 'Change Photo'}</div>
                    <input ref={avatarInputRef} type="file" accept="image/*" style={{display:'none'}} onChange={handleAvatarSelect}/>
                </div>
                <div className="profile-name">{user.displayName||'User'}</div>
                <div className="profile-email">{user.email}</div>
                <div className="profile-stats">
                    <div className="profile-stat"><div className="profile-stat-value">{habits.length}</div><div className="profile-stat-label">Habits</div></div>
                    <div className="profile-stat"><div className="profile-stat-value">{myPosts.length}</div><div className="profile-stat-label">Post</div></div>
                    <div className="profile-stat"><div className="profile-stat-value">{rate}%</div><div className="profile-stat-label">Completion Rate</div></div>
                </div>
            </div>

            {/* ── Post ── */}
            <div className="composer-wrap">
                <textarea
                    className="composer-textarea"
                    placeholder="Share your habit progress or thoughts..."
                    value={postText}
                    maxLength={300}
                    onChange={e=>setPostText(e.target.value)}
                />
                {postMedia && (
                    <div className="composer-media-preview">
                        {postMedia.type==='image'
                            ? <img src={postMedia.url} alt="preview" style={{width:'100%',height:'100%',objectFit:'cover',display:'block'}}/>
                            : <video key={postMedia.url} src={postMedia.url} controls playsInline preload="metadata"
                                style={{width:'100%',height:'100%',objectFit:'cover',display:'block',background:'#000'}}/>
                        }
                        {postMedia.uploading
                            ? <div style={{position:'absolute',inset:0,background:'rgba(0,0,0,0.65)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:10}}>
                                <div style={{fontSize:12,color:'white',fontWeight:700,letterSpacing:1,textTransform:'uppercase'}}>{`Uploading ${uploadProgress}%`}</div>
                                <div style={{width:'60%',height:4,background:'rgba(255,255,255,0.2)',borderRadius:2,overflow:'hidden'}}>
                                    <div style={{width:uploadProgress+'%',height:'100%',background:'white',transition:'width 0.3s'}}/>
                                </div>
                              </div>
                            : <button className="composer-media-remove" onClick={()=>setPostMedia(null)}>&#x2715;</button>
                        }
                    </div>
                )}
                <div className="composer-toolbar">
                    <div className="composer-media-btns">
                        <button className="composer-media-btn" onClick={()=>fileInputRef.current?.click()}>
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Photo
                        </button>
                        <button className="composer-media-btn" onClick={()=>videoInputRef.current?.click()}>
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 10l4.553-2.069A1 1 0 0121 8.868v6.264a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Video
                        </button>
                        <input ref={fileInputRef} type="file" accept="image/*" style={{display:'none'}} onChange={e=>handleMediaSelect(e,'image')}/>
                        <input ref={videoInputRef} type="file" accept="video/*" style={{display:'none'}} onChange={e=>handleMediaSelect(e,'video')}/>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:12,flexWrap:'wrap',justifyContent:'flex-end'}}>
                        {postMedia && !postMedia.uploading && !postMedia.local && (
                            <span style={{fontSize:9,color:'var(--gray-400)',letterSpacing:.3,width:'100%',textAlign:'right'}}>
                                Media uploaded &middot; quota counted
                            </span>
                        )}
                        <span className="composer-char">{postText.length}/300</span>
                        <button
                            className="composer-submit"
                            disabled={(!postText.trim() && !postMedia) || postMedia?.uploading}
                            onClick={handlePostSubmit}
                        >{postMedia?.uploading ? 'Uploading…' : 'Post'}</button>
                    </div>
                </div>
            </div>

            {/* ── My Posts ── */}
            <div className="my-posts-section">
                {myPosts.length > 0 && <div className="section-title">My Posts</div>}
                {myPosts.map(p => (
                    <div key={p.id} className="my-post-item">
                        <div className="my-post-header">
                            <span className="my-post-time">{p.time}</span>
                            <button className="my-post-delete" onClick={async ()=>{
                                if (isFirebaseConfigured) {
                                    try { await db.collection('posts').doc(p.id).delete(); }
                                    catch(e) { alert('Delete failed: ' + e.message); }
                                } else {
                                    setMyPosts(prev=>prev.filter(x=>x.id!==p.id));
                                    setFeedPosts(prev=>prev.filter(x=>x.id!==p.id));
                                }
                            }}>Delete</button>
                        </div>
                        {p.text && <div className="my-post-body">{p.text}</div>}
                        {p.mediaUrl && (
                            <div className="my-post-media">
                                {p.hasImage
                                    ? <img src={p.mediaUrl} alt="post"/>
                                    : <video src={p.mediaUrl} controls playsInline preload="metadata" style={{width:'100%',height:180,objectFit:'contain',display:'block',background:'#000'}}/>
                                }
                            </div>
                        )}
                        <div className="my-post-actions">
                            <div className="feed-action"><HeartIcon filled={false}/><span>{p.likes}</span></div>
                            <div className="feed-action"><ChatIcon/><span>{p.comments}</span></div>
                        </div>
                    </div>
                ))}
                {myPosts.length === 0 && (
                    <div className="empty-state" style={{paddingTop:32}}>
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{width:36,height:36,margin:'0 auto 12px',opacity:.2}}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        <h3>No posts yet</h3>
                        <p>Share your first post and start your habit journey</p>
                    </div>
                )}
            </div>

            {/* ── History Entry ── */}
            <div style={{margin:'24px 0 0',borderTop:'1px solid var(--gray-100)',paddingTop:20}}>
                <div className="section-title" style={{marginBottom:10}}>Analytics</div>
                <button className="history-entry-btn" onClick={()=>setShowHistory(true)}>
                    <div className="history-entry-left">
                        <div className="history-entry-icon">
                            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="white" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        </div>
                        <div className="history-entry-text">
                            <strong>Habit History</strong>
                            <span>{archivedHabits.length} completed · tap to view</span>
                        </div>
                    </div>
                    <div className="history-entry-arrow">
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>
                    </div>
                </button>
            </div>

            {/* ── 帳號管理區 ── */}
            <div style={{margin:'24px 0 8px',borderTop:'1px solid var(--gray-100)',paddingTop:20}}>
                <div className="section-title" style={{marginBottom:12}}>Account</div>
                <button className="delete-account-btn" onClick={()=>{setDeleteModal(true);setDeleteStep(1);setDeletePassword('');setDeleteError('');}}>
                    <svg style={{width:13,height:13,marginRight:6,verticalAlign:'middle'}} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete My Account &amp; All Data
                </button>
            </div>

            {/* ── 刪帳確認 Modal ── */}
            {deleteModal && (
                <div className="danger-modal" onClick={e=>{if(e.target===e.currentTarget&&deleteStep!==3)setDeleteModal(false);}}>
                    <div className="danger-modal-box">
                        {deleteStep === 3 ? (
                            <div className="danger-deleting">
                                <div style={{fontSize:32}}>⏳</div>
                                <p>Deleting your account and all data...<br/>Please do not close the app.</p>
                            </div>
                        ) : deleteStep === 1 ? (
                            <>
                                <div className="danger-modal-title">⚠ Delete Account</div>
                                <div className="danger-modal-body">
                                    This will permanently delete:<br/>
                                    <strong>All your habits</strong>, completion records &amp; streaks<br/>
                                    <strong>All your posts</strong> and comments<br/>
                                    <strong>All uploaded photos &amp; videos</strong><br/>
                                    <strong>Your account</strong> and profile data<br/><br/>
                                    <strong>This action cannot be undone.</strong>
                                </div>
                                <button className="danger-confirm-btn" onClick={()=>setDeleteStep(2)}>
                                    I understand, continue →
                                </button>
                                <button className="danger-cancel-btn" onClick={()=>setDeleteModal(false)}>Cancel</button>
                            </>
                        ) : (
                            <>
                                <div className="danger-modal-title">
                                    {isGoogleUser() ? 'Confirm with Google' : 'Confirm with Password'}
                                </div>
                                <div className="danger-step">Step 2 of 2 — Final Confirmation</div>
                                <div className="danger-modal-body">
                                    {isGoogleUser() ? (
                                        <>
                                            Click below to re-authenticate with Google and confirm deletion of<br/>
                                            <strong>{user.email}</strong>
                                        </>
                                    ) : (
                                        <>
                                            Enter your password to confirm deletion of<br/>
                                            <strong>{user.email}</strong>
                                        </>
                                    )}
                                </div>
                                {!isGoogleUser() && (
                                    <input
                                        type="password"
                                        className="danger-confirm-input"
                                        placeholder="Enter your password"
                                        value={deletePassword}
                                        onChange={e=>setDeletePassword(e.target.value)}
                                        onKeyDown={e=>e.key==='Enter'&&deletePassword&&handleDeleteAccount()}
                                        autoFocus
                                    />
                                )}
                                {deleteError && (
                                    <div style={{color:'#dc2626',fontSize:11,marginBottom:12,padding:'8px 10px',background:'#fef2f2',border:'1px solid #fca5a5'}}>
                                        {deleteError}
                                    </div>
                                )}
                                <button
                                    className="danger-confirm-btn"
                                    disabled={!isGoogleUser() && !deletePassword}
                                    onClick={handleDeleteAccount}
                                >
                                    🗑 Permanently Delete Everything
                                </button>
                                <button className="danger-cancel-btn" onClick={()=>setDeleteModal(false)}>Cancel</button>
                            </>
                        )}
                    </div>
                </div>
            )}
        </div>
    );

    return (
        <div className="app-container">
            <div className="header">
                <div className="header-title">
                    <h1>Habit Tracker PRO</h1>
                    <p>{user.displayName||user.email}</p>
                </div>
                <button className="logout-btn" onClick={onLogout}>Sign Out</button>
            </div>
            <div className="content">
                {activeTab==='home' && renderHome()}
{activeTab==='feed' && renderFeed()}
                {activeTab==='profile' && renderProfile()}
            </div>
            {showModal && <AddHabitModal onClose={()=>setShowModal(false)} onAdd={addHabit}/>}
            <div className="tab-bar">
                <button className={`tab-item${activeTab==='home'?' active':''}`} onClick={()=>{setActiveTab('home');setSelectedHabit(null);}}>
                    <HomeIcon/><span>Home</span>
                </button>
<button className={`tab-item${activeTab==='feed'?' active':''}`} onClick={()=>setActiveTab('feed')}>
                    <FeedIcon/><span>Feed</span>
                </button>
                <button className={`tab-item${activeTab==='profile'?' active':''}`} onClick={()=>setActiveTab('profile')}>
                    <ProfileIcon/><span>Profile</span>
                </button>
            </div>
        </div>
    );
}

/* ── ROOT APP ── */
function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!isFirebaseConfigured) {
            const u = localStorage.getItem('demoUser');
            if (u) setUser(JSON.parse(u));
            setLoading(false); return;
        }
        const unsub = auth.onAuthStateChanged(u=>{
            if (u && isFirebaseConfigured) {
                // ✅ 只有 email 已驗證的用戶才寫入 Firestore
                if (u.emailVerified) {
                    db.collection('users').doc(u.uid).set({
                        uid: u.uid,
                        email: u.email || '',
                        displayName: u.displayName || '',
                        photoURL: u.photoURL || '',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true }).catch(()=>{});
                    setUser(u);
                } else {
                    // 未驗證的帳號：不寫入 Firestore，不讓進 App
                    auth.signOut();
                    setUser(null);
                }
            } else {
                setUser(u);
            }
            setLoading(false);
        });
        return ()=>unsub();
    }, []);

    const handleLogout = () => {
        if (!isFirebaseConfigured) { localStorage.removeItem('demoUser'); setUser(null); }
        else auth.signOut();
    };

    if (loading) return <div className="app-container"><div className="loading">Loading...</div></div>;
    return user ? <MainApp user={user} onLogout={handleLogout}/> : <AuthPage onAuthSuccess={setUser}/>;
}

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
<!-- ── PWA: Service Worker + Install Prompt + Push Notifications ── -->
<script>
(function() {
    /* 1. Register Service Worker */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('[PWA] SW registered:', reg.scope);
                    // Ask for push notification permission (delayed 5s, let user explore first)
                    setTimeout(() => askNotifPermission(reg), 5000);
                })
                .catch(err => console.warn('[PWA] SW failed:', err));
        });
    }

    /* 2. Intercept install prompt event */
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Already installed — skip banner
        if (localStorage.getItem('pwa-installed')) return;
        showInstallBanner();
    });

    /* 3. Show install banner */
    function showInstallBanner() {
        if (document.getElementById('pwa-banner')) return;
        const banner = document.createElement('div');
        banner.id = 'pwa-banner';
        banner.className = 'pwa-install-banner';
        banner.innerHTML = `
            <div class="pwa-install-icon"><img src="./icons/icon-192x192.png" alt="icon"></div>
            <div class="pwa-install-text">
                <strong>Install Habit Tracker Pro</strong>
                <span>Add to home screen for quick access</span>
            </div>
            <button class="pwa-install-btn" id="pwa-install-btn">Install</button>
            <button class="pwa-install-close" id="pwa-install-close">✕</button>
        `;
        document.body.appendChild(banner);

        document.getElementById('pwa-install-btn').onclick = async () => {
            banner.remove();
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') localStorage.setItem('pwa-installed', '1');
            deferredPrompt = null;
        };
        document.getElementById('pwa-install-close').onclick = () => {
            banner.remove();
            localStorage.setItem('pwa-installed', '1');
        };
    }

    /* 4. iOS Safari install hint (iOS does not support beforeinstallprompt) */
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isInStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (isIOS && !isInStandalone && !localStorage.getItem('ios-hint-shown')) {
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);max-width:340px;width:calc(100% - 32px);background:#0a0a0a;color:#fff;padding:14px 16px;font-size:12px;line-height:1.6;z-index:500;text-align:center;box-shadow:0 4px 24px rgba(0,0,0,.3)';
            hint.innerHTML = `
                <div style="font-weight:700;font-size:13px;margin-bottom:6px">📲 Add to iPhone Home Screen</div>
                <div style="opacity:.75">Tap the <strong style="opacity:1">Share button ↑</strong> below → Select "Add to Home Screen" to use like an app</div>
                <button onclick="this.parentElement.remove();localStorage.setItem('ios-hint-shown','1')" style="margin-top:10px;background:white;color:#0a0a0a;border:none;padding:6px 16px;font-weight:700;font-size:11px;cursor:pointer;text-transform:uppercase;letter-spacing:.8px">Got it</button>
            `;
            document.body.appendChild(hint);
        }, 3000);
    }

    /* 5. Push notification request */
    async function askNotifPermission(reg) {
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'default') return;
        if (localStorage.getItem('notif-asked')) return;

        const prompt = document.createElement('div');
        prompt.id = 'notif-prompt';
        prompt.className = 'notif-prompt';
        prompt.innerHTML = `
            <div class="notif-prompt-text">
                <strong>🔔 Enable Daily Reminders</strong>
                We'll remind you when it's time to complete your habits, every day
            </div>
            <button class="notif-yes" id="notif-yes">Enable</button>
            <button class="notif-no"  id="notif-no">No thanks</button>
        `;
        document.body.appendChild(prompt);

        document.getElementById('notif-yes').onclick = async () => {
            prompt.remove();
            localStorage.setItem('notif-asked', '1');
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                scheduleDailyReminder(reg);
                // Welcome notification
                reg.showNotification('🎉 Reminders Enabled!', {
                    body: 'We will remind you to complete your habits every day at 8 PM',
                    icon: './icons/icon-192x192.png',
                    badge: './icons/icon-72x72.png',
                });
            }
        };
        document.getElementById('notif-no').onclick = () => {
            prompt.remove();
            localStorage.setItem('notif-asked', '1');
        };
    }

    /* 6. Daily reminder (local, simulated with setTimeout, no backend needed) */
    function scheduleDailyReminder(reg) {
        const now = new Date();
        // Read user's preferred reminder hour (0-23), default = 20 (8pm local time)
        const reminderHour = parseInt(localStorage.getItem('reminder-hour') || '20', 10);
        const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), reminderHour, 0, 0);
        if (next <= now) next.setDate(next.getDate() + 1);
        const ms = next - now;
        setTimeout(() => {
            if (Notification.permission === 'granted') {
                reg.showNotification('Habit Tracker Pro', {
                    body: "Have you completed today's habits? Tap here to log your progress 💪",
                    icon: './icons/icon-192x192.png',
                    badge: './icons/icon-72x72.png',
                    vibrate: [200, 100, 200],
                });
            }
            // Schedule next day
            scheduleDailyReminder(reg);
        }, ms);
    }

    /* 7. Detect app installed → hide banner */
    window.addEventListener('appinstalled', () => {
        localStorage.setItem('pwa-installed', '1');
        const b = document.getElementById('pwa-banner');
        if (b) b.remove();
        console.log('[PWA] App installed!');
    });
})();
</script>
</body>
</html>
